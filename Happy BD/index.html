    <!DOCTYPE html>
    <html lang="zh-CN">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>å­èŒœçš„æ˜Ÿæ²³ç”Ÿæ—¥å±• Â· Happy Orbit, Zixian</title>
    <meta name="description" content="ä¸ºå­èŒœå®šåˆ¶çš„ä¸€é¡µå¼ç”Ÿæ—¥ç½‘é¡µï¼šç›¸å†Œé“¶æ²³ã€æ—¶é—´è½´ã€æ‹¼å›¾è§£é”ã€å¿ƒæ„¿æ°”çƒã€ç¥ç¦çƒŸèŠ±" />
        <meta name="theme-color" content="#0D1B2A" />
        
    <!-- Security: CSP -->
    <!--
    å®‰å…¨ç­–ç•¥ï¼ˆCSPï¼‰è¯´æ˜ï¼š
    - å¦‚éœ€æ’­æ”¾å¤–éƒ¨éŸ³é¢‘ï¼Œè¯·å°†å…¶åŸŸååŠ å…¥ media-srcï¼ˆå·²å…è®¸ https: ä¸ data:ï¼‰ã€‚
    - å¦‚éœ€é¢å¤–å›¾ç‰‡æˆ– API åŸŸï¼Œåˆ†åˆ«æ·»åŠ åˆ° img-src / connect-srcã€‚
    - frame-src 'self' å…è®¸åŒæº iframeï¼ˆç”¨äº vendor/hb-classic æ²™ç®±ï¼‰ã€‚
    -->
    <meta http-equiv="Content-Security-Policy" 
        content="default-src 'self'; img-src 'self' https://images.unsplash.com data:; media-src 'self' https: data:; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://maxcdn.bootstrapcdn.com; script-src 'self' 'unsafe-inline' https://ajax.googleapis.com https://maxcdn.bootstrapcdn.com https://cdnjs.cloudflare.com; font-src 'self' https://fonts.gstatic.com; connect-src 'self' https://images.unsplash.com; frame-src 'self'; manifest-src 'self' blob: data:; worker-src 'self' blob:; base-uri 'self'; frame-ancestors 'none'">
    
    <!-- SEO: Open Graph -->
    <meta property="og:title" content="å­èŒœçš„æ˜Ÿæ²³ç”Ÿæ—¥å±• Â· Happy Orbit, Zixian" />
    <meta property="og:description" content="ç›¸å†Œé“¶æ²³ã€æ—¶é—´è½´ã€æ‹¼å›¾ã€çƒŸèŠ±â€¦ä¸“å±äº’åŠ¨ç”Ÿæ—¥ç½‘é¡µ" />
    <meta property="og:type" content="website" />
    <meta property="og:image" content="https://images.unsplash.com/photo-1529336953121-a0ce99a0f007?w=1200&h=630&fit=crop" />
    
    <link rel="preconnect" href="https://images.unsplash.com" crossorigin>
        <style>
            /* ===== è®¾è®¡ç³»ç»Ÿ ===== */
            :root{
                --bg-deep:#0D1B2A;      /* æš®é› */
                --bg-deeper:#08111d;
                --ink:#E6E6FA;          /* æ˜Ÿè¾‰ */
                --rose:#EFB8C8;         /* ç«ç‘°é‡‘ */
                --mint:#b7ffe1;
                --accent:#8ec5ff;
                --card:#12243b;
                --muted:#9aa7b2;
                --shadow:0 10px 30px rgba(0,0,0,.45);
                --radius:16px;
                --radius-lg:24px;
                --glass:rgba(255,255,255,0.06);
            }
            *{box-sizing:border-box}
    /* å…œåº•ï¼Œé¿å…å†çœ‹åˆ° UA ç™½åº• */
    html,body{margin:0;padding:0;background:#0b1420;color:var(--ink);font:16px/1.7 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;scroll-behavior:smooth}
            img{max-width:100%;display:block}
            a{color:var(--mint);text-decoration:none}
        h1,h2,h3{margin:0 0 .75rem 0; line-height:1.25}
        p{margin:.5rem 0 1rem}
        .container{width:min(1100px,92vw);margin:0 auto;padding:56px 0}
        .section{padding:64px 0;border-top:1px solid rgba(255,255,255,.06)}
            .card{background:linear-gradient(180deg,var(--glass),rgba(255,255,255,0.02));border:1px solid rgba(255,255,255,.08);backdrop-filter:blur(6px);-webkit-backdrop-filter:blur(6px);border-radius:var(--radius);box-shadow:var(--shadow)}
            .btn{appearance:none;border:none;border-radius:999px;background:linear-gradient(135deg,var(--rose),#ffd2df 60%,#fff1f6);color:#381a22;font-weight:700;padding:12px 20px;cursor:pointer;box-shadow:0 6px 18px rgba(239,184,200,.35);transition:transform .15s ease, box-shadow .15s ease}
            .btn:hover{transform:translateY(-1px);box-shadow:0 10px 24px rgba(239,184,200,.5)}
            .btn.ghost{background:transparent;color:var(--ink);border:1px solid rgba(255,255,255,.16);box-shadow:none}
            .btn:focus-visible,.tag:focus-visible,.face[role="button"]:focus-visible{outline:2px solid var(--rose);outline-offset:2px}
            .muted{color:var(--muted)}
            .pill{display:inline-flex;align-items:center;gap:.4rem;padding:.35rem .7rem;border-radius:999px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.1);font-size:.85rem}
            .grid{display:grid;gap:16px}
            @media(min-width:800px){.grid.cols-3{grid-template-columns:repeat(3,1fr)}.grid.cols-4{grid-template-columns:repeat(4,1fr)}}

            /* ===== é¡¶éƒ¨å¯¼èˆª ===== */
            .nav{position:sticky;top:0;z-index:40;background:linear-gradient(180deg,rgba(8,17,29,.9),rgba(8,17,29,.6) 80%,transparent);backdrop-filter:blur(6px);border-bottom:1px solid rgba(255,255,255,.06)}
            .nav-inner{width:min(1024px,92vw);margin:0 auto;display:flex;align-items:center;justify-content:space-between;padding:10px 0}
            .nav a{padding:8px 10px;border-radius:8px;color:var(--ink)}
            .nav a:hover{background:rgba(255,255,255,.06)}

            /* ===== Hero æ˜Ÿæ²³èˆå° ===== */
                        #hero{position:relative;min-height:84vh;display:grid;place-items:center}
                        /* èƒŒæ™¯å±‚ï¼šä¸å†ç”¨è´Ÿå±‚çº§ */
                        #starfield{position:fixed;inset:0;z-index:0;background:#0b1420}
                        /* æš—è§’ç½©å±‚ï¼šåœ¨æ˜Ÿç©ºä¹‹ä¸Šï¼Œå†…å®¹ä¹‹ä¸‹ */
                        #vignette{position:fixed;inset:0;pointer-events:none;z-index:1;
                            background:radial-gradient(1200px 800px at 70% -10%, rgba(18,36,59,.28), rgba(13,27,42,.12) 45%, rgba(8,17,29,0) 100%)}
            .hero-content{position:relative;z-index:1;display:flex;flex-direction:column;align-items:center;text-align:center;gap:16px;padding:20px}
            .title{font-size:clamp(28px,6vw,56px);letter-spacing:.02em}
            .typing{min-height:1.8em;border-right:2px solid var(--rose);white-space:nowrap;overflow:hidden}
            .hero-actions{display:flex;gap:10px;flex-wrap:wrap;justify-content:center}

            .gate{display:flex;gap:8px;align-items:center;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);border-radius:999px;padding:6px 8px}
            .gate input{all:unset;padding:6px 10px;min-width:12ch}

            /* ===== ç›¸å†Œé“¶æ²³ ===== */
            /* Masonry åˆ—ä¿æŒä¸å˜ */
            .gallery{columns:2 260px;column-gap:14px}

            /* å…³é”®ï¼šç»™ figure ä¸€ä¸ªå›ºæœ‰é«˜åº¦å ä½ï¼Œé˜²æ­¢å›¾ç‰‡å¤±è´¥æ—¶é«˜åº¦ä¸º 0 */
            .photo{
            break-inside:avoid;
            position:relative;
            margin:0 0 14px 0;
            border-radius:14px;
            overflow:hidden;
            border:1px solid rgba(255,255,255,.08);
            aspect-ratio: 4 / 3;           /* âœ… å ä½é«˜åº¦ï¼Œç°ä»£æµè§ˆå™¨ */
            background:rgba(255,255,255,.02);
            /* å…¼å®¹éå¸¸è€çš„æµè§ˆå™¨å¯åŠ ï¼šmin-height: 180px; */
            }

            /* è®©å›¾ç‰‡é“ºæ»¡å®¹å™¨ï¼›å³ä½¿åŠ è½½å¤±è´¥ä¹Ÿä¸æ’‘é«˜å¸ƒå±€ */
            .photo img{
            position:absolute;
            inset:0;
            width:100%;
            height:100%;
            object-fit:cover;
            opacity:1;
            transition:opacity .4s ease;
            }

            /* å­—å¹•æ­£å¸¸å¤šè¡Œæ¢è¡Œï¼Œä¸è¢«è£åˆ‡ */
            .photo figcaption{
            position:absolute;
            left:0; right:0; bottom:0;
            background:linear-gradient(0deg,rgba(0,0,0,.75),transparent);
            padding:12px 12px;
            font-size:.9rem;
            text-align:center;
            line-height:1.4;
            white-space:normal;           /* é˜²æ­¢é•¿è‹±æ–‡ä¸æ¢è¡Œ */
            word-break:break-word;
            }
        .tags{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0}
        .tag{cursor:pointer;appearance:none;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.06);color:var(--ink);padding:.35rem .7rem;border-radius:999px}
        .tag[aria-pressed="true"]{background:rgba(239,184,200,.15);border-color:rgba(239,184,200,.5)}

            /* å›¾ç‰‡æŸ¥çœ‹å™¨ */
            .lightbox{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;place-items:center;z-index:50}
            .lightbox.open{display:grid}
            .lightbox .viewer{width:min(960px,92vw);max-height:86vh;display:grid;gap:10px}
            .lightbox img{max-height:70vh;margin:auto;border-radius:12px}

            /* ===== æ—¶é—´è½´ ===== */
            .timeline{overflow:auto hidden;padding:10px}
            .lane{display:flex;gap:16px;min-height:200px}
            .tcard{min-width:240px;perspective:1000px}
            .face{position:relative;height:180px;border-radius:14px;padding:14px;transform-style:preserve-3d;transition:transform .5s;border:1px solid rgba(255,255,255,.1);background:linear-gradient(180deg,var(--glass),rgba(255,255,255,.02))}
            .face.flip{transform:rotateY(180deg)}
            .front,.back{position:absolute;inset:0;padding:14px;backface-visibility:hidden}
            .back{transform:rotateY(180deg)}

            /* ï¼ˆå·²ç§»é™¤ï¼šæ‰­è›‹æœºã€å°æµ‹æ ·å¼ï¼‰ */

            /* ===== æ‹¼å›¾ ===== */
            .puzzle{width:min(360px,92vw);height:min(360px,92vw);position:relative;border-radius:12px;overflow:hidden;border:1px solid rgba(255,255,255,.1);background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.015))}
            .tile{position:absolute;width:33.3333%;height:33.3333%;background-size:300% 300%;border:1px solid rgba(255,255,255,.05);cursor:pointer;transition:box-shadow .15s}
            .tile:active{box-shadow:0 0 0 2px rgba(255,255,255,.2) inset}

        /* ===== å…¨å±€åŠ¨æ•ˆè¦†ç›–å±‚ ===== */
        .fx-overlay{position:fixed;inset:0;pointer-events:none;z-index:20;overflow:hidden}
        #fxFireworks{position:absolute;inset:0}
        #fxBarrage{position:absolute;left:0;right:0;overflow:hidden;top:80px;bottom:auto;height:calc(100vh - 200px)}
        /* ç»å…¸ç”Ÿæ—¥é¡µè¦†ç›–å±‚ - å®‰å…¨æ²™ç®±åµŒå…¥ */
        #hbOverlay{position:fixed;inset:0;background:rgba(0,0,0,.85);z-index:200;display:none;place-items:center}
        #hbOverlay.open{display:grid}
        #hbOverlay iframe{width:min(1000px,95vw);height:min(650px,90vh);border:0;border-radius:12px;box-shadow:0 12px 48px rgba(0,0,0,.6)}
        #hbClose{position:absolute;top:1rem;right:1rem;z-index:201;font:700 18px system-ui;border:0;background:rgba(0,0,0,.7);color:white;padding:.5rem .8rem;border-radius:.5rem;cursor:pointer;transition:background .2s}
        #hbClose:hover{background:rgba(0,0,0,.9)}            /* æ°”çƒè®¾è®¡ - çœŸæ­£çš„æ°”çƒå½¢çŠ¶ */
            /* ç»“æ„ï¼š .balloon > .g(ç»„ï¼šæ°”çƒ+çº¿) + small(æ–‡å­—)  */
            .balloon{
                position:absolute;
                bottom:20px;
                display:flex;
                flex-direction:column;
                align-items:center;
                cursor:pointer;
                transition:transform .2s ease;
            }
            .balloon:hover{transform:scale(1.05)}
            
            /* ç»„ï¼šæ°”çƒ+çº¿ä¸€èµ·æ—‹è½¬ */
            .balloon .g{
                display:flex;
                flex-direction:column;
                align-items:center;
                /* ç»„ä¸€èµ·æ—‹è½¬ â‡’ æ°”çƒå’Œçº¿ä¸ä¼šåˆ†å®¶ */
                transform-origin: 50% 68px; /* æ—‹è½¬åŸºç‚¹åœ¨"ç³»ç»“"é™„è¿‘ */
                filter: drop-shadow(0 10px 18px rgba(0,0,0,.35)); /* é˜´å½±ç»™ç»„ï¼Œè€Œä¸æ˜¯ç»™æ–‡å­— */
            }
            
            /* æ°”çƒä¸»ä½“ - åœ†å½¢ï¼Œåº•éƒ¨ç¨å°– */
            .balloon .b{
                width:50px;
                height:65px;
                background:linear-gradient(135deg, var(--balloon-color, #ff6b9d) 0%, var(--balloon-dark, #c9184a) 100%);
                border-radius:50% 50% 50% 50% / 60% 60% 40% 40%;
                position:relative;
                box-shadow:
                    inset -10px -10px 20px rgba(0,0,0,.2),
                    inset 10px 10px 20px rgba(255,255,255,.3),
                    0 10px 30px rgba(0,0,0,.3);
                /* æ°”çƒæœ¬ä½“çš„æ™¯æ·±æ¨¡ç³Šé€šè¿‡å˜é‡æ³¨å…¥ï¼›æ–‡å­—ä¸å—å½±å“ */
                transform-origin: 50% calc(100% - 6px); /* å›´ç»•ç³»ç»“é™„è¿‘æ—‹è½¬æ›´è‡ªç„¶ */
                filter: var(--dof, none);                /* â† åªåœ¨ .b ä¸Šç”Ÿæ•ˆçš„æ¨¡ç³Š */
            }
            
            /* æ–‡å­—æ°¸è¿œä¸è¢«æ¨¡ç³Š */
            .balloon small{
                margin-top:8px; 
                max-width:120px; 
                text-align:center;
                color:var(--ink); 
                font-size:.9rem; 
                line-height:1.3;
                text-shadow:0 2px 4px rgba(0,0,0,.3);
                filter:none !important;                /* å…³é”®ï¼šå³ä½¿çˆ¶å±‚æœ‰ filterï¼Œä¹Ÿä¸è®©å®ƒåƒæ¨¡ç³Š */
                -webkit-font-smoothing: antialiased;
                text-rendering: optimizeLegibility;
            }
            
            /* æ°”çƒä¸Šå‡åŠ¨ç”» - ä½¿ç”¨è§†å£å•ä½ï¼Œé€‚é…æ‰€æœ‰å±å¹• */
            @keyframes floatUp{
                0%{
                    transform:translateY(0) translateX(0) rotate(0deg);
                    opacity:1;
                }
                25%{
                    transform:translateY(-30vh) translateX(calc(var(--drift, 0px) * 0.25)) rotate(calc(var(--rotate, 5deg) * 0.5));
                }
                50%{
                    transform:translateY(-60vh) translateX(calc(var(--drift, 0px) * 0.5)) rotate(var(--rotate, 5deg));
                    opacity:1;
                }
                75%{
                    transform:translateY(-90vh) translateX(calc(var(--drift, 0px) * 0.75)) rotate(calc(var(--rotate, 5deg) * 0.5));
                    opacity:0.7;
                }
                100%{
                    transform:translateY(-120vh) translateX(var(--drift, 0px)) rotate(0deg);
                    opacity:0;
                }
            }
            
        .barrage{position:absolute;left:0;top:0;right:0;bottom:0;pointer-events:none;overflow:hidden}
        .msg{position:absolute;background:rgba(0,0,0,.7);color:#fff;padding:12px 20px;border-radius:999px;font-size:1rem;line-height:1.5;border:1px solid rgba(255,255,255,.2);white-space:nowrap;box-shadow:0 4px 12px rgba(0,0,0,.3)}

            /* ï¼ˆå·²ç§»é™¤ï¼šæ‰¿è¯ºä¹¦/ç­¾å/çºªå¿µå¡æ ·å¼ï¼‰ */

            /* è¾…åŠ© */
            .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
            .right{margin-left:auto}
            .center{text-align:center}
            .hidden{display:none!important}
            
            /* Resize Guard: åœ¨é¢‘ç¹ç¼©æ”¾/è°ƒæ•´çª—å£æ—¶ï¼Œæš‚æ—¶å…³é—­è¿‡æ¸¡ä¸åŠ¨ç”»ï¼Œé¿å… GPU/å†…å­˜æŠ–åŠ¨ */
            html.resizing *, html.resizing .section.in-view{
                transition:none!important; animation:none!important;
            }
            
            /* é€šçŸ¥åŠ¨ç”» */
            @keyframes slideIn{
                from{transform:translateX(120%);opacity:0}
                to{transform:translateX(0);opacity:1}
            }
            @keyframes slideOut{
                from{transform:translateX(0);opacity:1}
                to{transform:translateX(120%);opacity:0}
            }
            
            /* å›¾ç‰‡æ·¡å…¥ + blur-up + shimmer */
            @keyframes fadeIn{
                from{opacity:0}
                to{opacity:1}
            }
            .photo img.blur{filter:blur(12px);transform:scale(1.02)}
            .photo img.ready{transition:filter .35s ease, opacity .35s ease, transform .35s ease;filter:blur(0)}
            .shimmer{position:relative;overflow:hidden}
            .shimmer::after{content:"";position:absolute;inset:0;transform:translateX(-100%);background:linear-gradient(90deg,transparent,rgba(255,255,255,.08),transparent);animation:shimmer 1.2s infinite}
            @keyframes shimmer{100%{transform:translateX(100%)}}
            
            /* Lightbox zoom gestures */
            .lightbox .viewer{touch-action:none}
            #big.zooming{cursor:grab}
            #big.zooming:active{cursor:grabbing}
            
            /* åŠ è½½æŒ‡ç¤ºå™¨ */
            .loading{
                display:inline-block;
                width:20px;
                height:20px;
                border:3px solid rgba(255,255,255,.3);
                border-radius:50%;
                border-top-color:var(--rose);
                animation:spin 1s ease-in-out infinite;
            }
            @keyframes spin{
                to{transform:rotate(360deg)}
            }
            
            /* Performance: content-visibility for off-screen sections */
            .section{
                content-visibility:auto;
                contain-intrinsic-size:1000px 800px;
            }
            /*
            * æ»šåŠ¨å‡ºç°åŠ¨ç”»ï¼ˆIntersectionObserver é…åˆï¼‰ï¼š
            * - ç»™ section æ·»åŠ  .reveal-pending ä»¥é¿å…é¦–å±é—ªçƒï¼›
            * - å½“è¿›å…¥è§†å£æ—¶ç§»é™¤ pending å¹¶åŠ  .in-view è§¦å‘åŠ¨ç”»ã€‚
            * - è‹¥ç”¨æˆ·åå¥½å‡å°‘åŠ¨æ•ˆï¼ˆprefers-reduced-motionï¼‰ï¼ŒJS å°†ä¸å¯ç”¨åŠ¨ç”»ã€‚
            */
            @keyframes fadeSlideUp{from{opacity:0;transform:translateY(16px)}to{opacity:1;transform:translateY(0)}}
            .section.reveal-pending{opacity:0}
            .section.in-view{animation:fadeSlideUp .6s ease-out both}
            
            /* Skip link for accessibility */
            .skip-link{
                position:absolute;
                top:-40px;
                left:0;
                background:var(--rose);
                color:#0D1B2A;
                padding:8px;
                text-decoration:none;
                z-index:100;
            }
            .skip-link:focus{
                top:0;
            }
            
            /* Status/toast container */
            #toast-container{
                position:fixed;
                top:20px;
                right:20px;
                z-index:10000;
                display:flex;
                flex-direction:column;
                gap:10px;
            }
            /* ç§»åŠ¨åŠ¨ç”»çš„æ€§èƒ½æš—ç¤º */
            .balloon{will-change:transform}
            .tile{will-change:transform}
            .tile.bump{transform:scale(0.98);transition:transform .12s ease}
            
            /* æ°”çƒå¯ç‚¹å‡»ï¼ˆè¦†ç›–çˆ¶å±‚ pointer-events:noneï¼‰ */
            .fx-overlay .balloon{ pointer-events:auto; }
            
            /* é«˜äº®æµ®æ ‡å®šä½ä¸Šä¸‹æ–‡ */
            [data-copy-key]{ position:relative; }
            
            /* ===== ç”œèœœå¯çˆ±ä¸»é¢˜ ===== */
            body.theme-sweet {
                --bg-deep:#201128;
                --bg-deeper:#170c1f;
                --ink:#FFF6FB;
                --rose:#FFB7D5;
                --mint:#C1FFE7;
                --accent:#A8C8FF;
                --card:#281536;
                --muted:#D6CFE2;
                --glass:rgba(255,255,255,0.08);
            }
            body.theme-sweet .btn{
                background:linear-gradient(135deg,#FFB7D5,#FFE4EF 60%,#FFF8FB);
                color:#5b2236; 
                box-shadow:0 8px 20px rgba(255,183,213,.35);
            }
            body.theme-sweet .pill{
                background:rgba(255,255,255,.10);
                border-color:rgba(255,255,255,.18);
            }
            body.theme-sweet .card{
                box-shadow:0 12px 36px rgba(0,0,0,.45);
            }

            /* ===== æ›´å¥½çœ‹çš„æ°”çƒ ===== */
            .balloon{ 
                filter:drop-shadow(0 10px 18px rgba(0,0,0,.35)); 
            }
            .balloon .b{
                width:56px;
                height:74px; 
                position:relative;
                background:linear-gradient(145deg, var(--balloon-color,#ff6b9d), var(--balloon-dark,#c9184a));
                border-radius:52% 52% 50% 50% / 62% 62% 42% 42%;
                box-shadow:
                    inset -14px -16px 24px rgba(0,0,0,.25),
                    inset 10px 12px 24px rgba(255,255,255,.28);
            }
            
            /* å¿ƒå½¢å˜ä½“ */
            /* â€”â€” æ›´è‡ªç„¶çš„å¿ƒå½¢ â€”â€” */
            .balloon.heart .b{
                width:64px; height:64px;
                background:linear-gradient(145deg, var(--balloon-color,#ff6b9d), var(--balloon-dark,#c9184a));
                position:relative;
                box-shadow:
                    inset -12px -12px 20px rgba(0,0,0,.22),
                    inset 10px 10px 20px rgba(255,255,255,.26),
                    0 10px 18px rgba(0,0,0,.35);
            }

            /* å¿ƒå½¢ç”¨æ›´åœ†æ¶¦çš„ pathï¼ˆå¯¹ç§°ã€åº•éƒ¨ä¸è¿‡å°–ï¼‰ */
            @supports (clip-path: path("M0,0 L1,0 L1,1 Z")){
                .balloon.heart .b{
                    -webkit-clip-path: path('M32 61 C20 48, 8 36, 8 24 C8 14, 16 8, 24 8 C28 8, 32 10.5, 32 15 C32 10.5, 36 8, 40 8 C48 8, 56 14, 56 24 C56 36, 44 48, 32 61 Z');
                            clip-path: path('M32 61 C20 48, 8 36, 8 24 C8 14, 16 8, 24 8 C28 8, 32 10.5, 32 15 C32 10.5, 36 8, 40 8 C48 8, 56 14, 56 24 C56 36, 44 48, 32 61 Z');
                }
            }

            /* ä¸æ”¯æŒ path() çš„é€€åŒ–å½¢çŠ¶ï¼ˆæ›´åœ†ä¸€ç‚¹ï¼‰ */
            @supports not (clip-path: path("M0,0 L1,0 L1,1 Z")){
                .balloon.heart .b{
                    clip-path: polygon(50% 92%, 22% 52%, 22% 32%, 36% 18%, 50% 30%, 64% 18%, 78% 32%, 78% 52%);
                }
            }

            /* åªå±è”½æ—§å®ç°é‡Œçš„è¡¥å½¢å°å—ï¼ˆå¦‚æœè¿˜åœ¨ DOM é‡Œï¼‰ï¼Œä¸è¦å±è”½é«˜å…‰å’Œç³»ç»“ */
            .balloon.heart .b > i { display:none; }

            /* åªä¿ç•™é«˜å…‰ä¸€æ¬¡ï¼Œé¿å…æ¥ç¼ */
            .balloon .b::before{
                content:"";
                position:absolute; inset:0;
                background:radial-gradient(45% 35% at 28% 28%, rgba(255,255,255,.55), transparent 60%);
                pointer-events:none;
            }
            
            /* æ‹¼å›¾å¹½çµåº•å›¾æ”¯æŒ */
            /* å–æ¶ˆå¯¹å®¹å™¨/å­å…ƒç´ çš„æ•´ä½“é€æ˜åº¦ */
            .puzzle.ghost { 
                opacity: 1;
                background-position:center; 
                background-size:100% 100%; 
                background-repeat:no-repeat;
            }

            /* ç”¨ä¼ªå…ƒç´ æ¸²æŸ“åº•å›¾åŠé€æ˜ç½©å±‚ï¼Œåªå½±å“åº•å›¾ï¼Œä¸å½±å“ tile */
            .puzzle::before { content:none; }
            .puzzle.ghost::before{
                content:"";
                position:absolute; inset:0; pointer-events:none;
                background-image: inherit;
                background-position:center;
                background-size:100% 100%;
                opacity:.22;                 /* æƒ³æ›´æ¸…æ™°å°±è°ƒå°è¿™ä¸ªæ•° */
            }

            /* tile ç»´æŒæ»¡è‰²æ˜¾ç¤º */
            .puzzle .tile { 
                opacity: 1;
                transition: transform .15s ease; 
            }

            /* â€”â€” ç»å¯¹æ¸…é™¤å†å²ä¸‰è§’ç³»ç»“/è¡¥ç‰‡ â€”â€” */
            .balloon .b::after,
            .balloon.heart .b::after,
            .balloon .b > i,
            .balloon .b > i::before,
            .balloon .b > i::after{
                content:none !important;
                display:none !important;
                border:0 !important;
                clip-path:none !important;
                box-shadow:none !important;
                background:none !important;
            }

            /* knot ä»å‹åœ¨æœ€ä¸Šé¢è¦†ç›–æ¥ç¼ */
            .balloon .k{
                position:relative;
                z-index:2;
                width:12px; height:8px;
                margin-top:-1px;
                background:linear-gradient(180deg, var(--balloon-dark,#c9184a), #6b0f2a);
                border-radius:0 0 6px 6px;
            }

            /* â€”â€” ç”¨ SVG ç”»ç»³ï¼šåœ†ç«¯å¤´ï¼Œå½»åº•æ²¡æœ‰"ç®­å¤´" â€”â€” */
            .balloon svg.s{
                display:block;
                position:relative;
                top:-2px;           /* è½»è½»æ’å…¥ç»“é‡Œä¸€ç‚¹ */
                z-index:1;
                overflow:visible;   /* è®©åœ†ç«¯ä¸è¢«è£ */
            }
            .balloon svg.s line{
                stroke:rgba(255,255,255,.85);
                stroke-width:2;
                stroke-linecap:round;   /* å…³é”®ï¼šåœ†ç«¯ */
            }

            /* ä¸‡ä¸€æŸå¤„ä»æ¸²æŸ“äº†æ—§çš„ div.sï¼Œç›´æ¥å±è”½ */
            .balloon div.s{ display:none !important; }

            /* å¿ƒå½¢æ°”çƒä¸“ç”¨ï¼šæ›´çœŸå®çš„"ç³»å£+ç»“"å½¢çŠ¶ */
            .balloon.heart .k{
                z-index:3;                    /* è¦†ç›–æ¥ç¼ */
                width:18px;
                height:12px;
                margin-top:-3px;              /* è½»æ’å…¥å¿ƒå½¢åº•éƒ¨ä¸€ç‚¹ */
                position:relative;
                border-radius:9px 9px 8px 8px;
                background:
                    radial-gradient(120% 120% at 50% 20%, rgba(255,255,255,.45), transparent 55%),
                    linear-gradient(180deg, var(--balloon-color,#ff6b9d), var(--balloon-dark,#6b0f2a));
                box-shadow:
                    inset 0 -3px 4px rgba(0,0,0,.35),
                    0 1px 0 rgba(255,255,255,.22) inset;
            }

            /* "é¢ˆéƒ¨"â€”â€”ä¸Šçª„ä¸‹å®½ï¼Œæ’è¿›å¿ƒå½¢é‡Œï¼Œè®©è¿æ¥æ›´é¡ºæ»‘ï¼ˆåœ†æ¶¦ç‰ˆï¼‰ */
            .balloon.heart .k::before{
                content:"";
                position:absolute;
                left:50%;
                top:-7px;                             /* é¢ˆéƒ¨å¾€ä¸Šæ’å…¥å¿ƒå½¢ */
                transform:translateX(-50%);
                width:22px;
                height:14px;
                background:linear-gradient(180deg, var(--balloon-color,#ff6b9d), var(--balloon-dark,#6b0f2a));
                /* Fallbackï¼šæ›´æ¸©å’Œçš„å¤šè¾¹å½¢ï¼ˆé¿å…å°–é”è±å½¢ï¼‰ */
                clip-path: polygon(50% 2%, 74% 42%, 50% 90%, 26% 42%);
                filter: drop-shadow(0 1px 0 rgba(0,0,0,.22));
                border-radius: 6px;                   /* è¿›ä¸€æ­¥æŸ”åŒ–è¾¹ç¼˜ï¼ˆéƒ¨åˆ†æµè§ˆå™¨å¯¹ clip-path è¾¹è§’æŠ—é”¯é½¿æ›´å‹å¥½ï¼‰ */
            }

            /* æ”¯æŒ path() æ—¶ä½¿ç”¨åœ†æ¶¦è´å¡å°”é¢ˆéƒ¨ï¼ˆä¸Šçª„ä¸‹å®½ï¼Œè¿‡æ¸¡é¡ºæ»‘ï¼‰ */
            @supports (clip-path: path("M0,0 L1,0 L1,1 Z")){
                .balloon.heart .k::before{
                    -webkit-clip-path: path('M11 0 C14 2, 19 7, 19 10 C19 12, 16 14, 11 14 C6 14, 3 12, 3 10 C3 7, 8 2, 11 0 Z');
                            clip-path: path('M11 0 C14 2, 19 7, 19 10 C19 12, 16 14, 11 14 C6 14, 3 12, 3 10 C3 7, 8 2, 11 0 Z');
                }
            }

            /* ç»³å­å’Œæ–°ç»“å¯¹é½å¾—æ›´è‡ªç„¶ä¸€ç‚¹ */
            .balloon.heart svg.s{ top:-1px; }
            
            /* æ­£æ–‡ç»Ÿç»ŸæŠ¬åˆ°ä¸Šé¢ï¼ˆåªé€‰ body çš„ç›´æ¥å­å…ƒç´ ï¼‰*/
            body > *:not(#starfield):not(#vignette){
                position:relative; z-index:2;
            }
            
            /* Fix: é¦–å¸§ 300Ã—150 ç”»å¸ƒç™½å— & ç”»å¸ƒå¸ƒå±€æŠ–åŠ¨ */
            canvas { display:block; }
            #starfield, #fxFireworks { width:100vw; height:100vh; }
            #fxFireworks { background:transparent; } /* æ˜ç¤ºé€æ˜ï¼Œé¿å…æŸäº› UA é»˜è®¤åº•è‰² */
            
            /* é¦–å¸§ç™½å—é˜²æŠ¤ï¼šæ˜Ÿç©ºåœ¨"å‡†å¤‡å¥½"å‰å…ˆé€æ˜ï¼Œç»˜åˆ¶åæ·¡å…¥ */
            #starfield { background:#0b1420; }
            #starfield:not([data-ready]){ opacity:0; }
            #starfield[data-ready]{ opacity:1; transition:opacity .18s ease; }
            
            /* Hero æ–‡æ¡ˆæœ€å¤§å®½åº¦ï¼Œé¦–å±æ›´èšç„¦ */
            .hero-content{ max-width:min(820px,92vw); }
        </style>
    </head>
    <body>

    <!-- å…¨å±€èƒŒæ™¯ï¼šæ˜Ÿç©º + æš—è§’å±‚ï¼ˆä¸é®æŒ¡å†…å®¹ï¼‰ -->
    <canvas id="starfield" aria-hidden="true"></canvas>
    <div id="vignette" aria-hidden="true"></div>

        <!-- Skip link for accessibility -->
        <a href="#main" class="skip-link">è·³åˆ°ä¸»å†…å®¹</a>
        
        <!-- Toast container for notifications -->
        <div id="toast-container" role="status" aria-live="polite" aria-atomic="true"></div>
        
        <!-- é¡¶éƒ¨å¯¼èˆª -->
        <div class="nav" role="navigation" aria-label="ä¸»å¯¼èˆª">
            <div class="nav-inner">
                <div class="pill">ğŸŒŒ å­èŒœçš„æ˜Ÿæ²³ç”Ÿæ—¥å±•</div>
                <nav class="row" aria-label="ç« èŠ‚">
                    <a id="navPhotos" href="#photos">ç›¸å†Œ</a>
                    <a id="navTimeline" href="#timeline">æ—¶é—´è½´</a>
                    <a id="navPuzzle" href="#puzzle">æ‹¼å›¾</a>
                    <a id="navClassic" href="#classic">ç»å…¸ç”Ÿæ—¥</a>
                </nav>
            </div>
        </div>

        <!-- Hero èˆå° -->
        <section id="hero" class="container">
            <div class="hero-content">
                <div class="pill">ç¬¬ <span id="revolutions">â€”</span> æ¬¡ç»•æ—¥æ—…è¡Œ</div>
                <h1 class="title">Happy Orbit, <span style="color:var(--rose)">Zixian</span> âœ¨</h1>
                <div id="typing" class="typing" aria-live="polite"></div>
                <div class="hero-actions">
                    <span class="gate" role="group" aria-label="å¯†è¯­è§£é”">
                        <input id="key" placeholder="è¾“å…¥å¯†è¯­ï¼ˆå¦‚ç”Ÿæ—¥ï¼š2001-06-18ï¼‰" aria-label="å¯†è¯­" autocomplete="off" />
                        <button class="btn ghost" id="unlock" type="button">è§£é”</button>
                    </span>
                    <button class="btn" id="goPhotos" type="button">å¼€å§‹é€›å±•</button>
                </div>
                
            </div>
        </section>

        <!-- ç›¸å†Œé“¶æ²³ -->
        <main id="main">
        <section id="photos" class="section">
            <div class="container">
                <h2 id="photosTitle">ğŸ“· ç›¸å†Œé“¶æ²³</h2>
                <p id="photosSub" class="muted">æ¯ä¸€å¼ ç…§ç‰‡éƒ½æ˜¯æ˜Ÿåº§çš„ä¸€é¢—æ˜Ÿã€‚</p>
                <div class="tags" id="filters"></div>
                <div class="gallery" id="gallery" aria-live="polite"></div>
            </div>
        </section>

        <!-- æŸ¥çœ‹å™¨ -->
        <div class="lightbox" id="lightbox" role="dialog" aria-modal="true" aria-label="ç…§ç‰‡æŸ¥çœ‹å™¨">
            <div class="viewer card">
                <img id="big" alt="æ”¾å¤§ç…§ç‰‡" />
                <div class="row" style="justify-content:space-between;padding:8px 12px">
                    <div id="bigcap" class="muted"></div>
                    <div class="row">
                        <button class="btn ghost" id="prevLight" type="button" aria-label="ä¸Šä¸€å¼ ">ä¸Šä¸€å¼ </button>
                        <button class="btn ghost" id="nextLight" type="button" aria-label="ä¸‹ä¸€å¼ ">ä¸‹ä¸€å¼ </button>
                        <button class="btn ghost" id="closeLight" type="button">å…³é—­</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ—¶é—´è½´ -->
        <section id="timeline" class="section">
            <div class="container">
                <h2 id="timelineTitle">ğŸ—ºï¸ æˆ‘ä»¬çš„æ—¶é—´è½´</h2>
                <div class="timeline card">
                    <div class="lane" id="lane"></div>
                </div>
                <p id="timelineTip" class="muted">ç‚¹å‡»å¡ç‰‡ç¿»é¢ï¼ŒæŸ¥çœ‹â€œé‚£å¤©æˆ‘æƒ³è¯´çš„è¯â€ã€‚</p>
            </div>
        </section>

        

        <!-- æ‹¼å›¾è§£é” -->
        <section id="puzzle" class="section">
            <div class="container">
                <h2 id="puzzleTitle">ğŸ§© å°æ‹¼å›¾ Â· è§£é”ç”Ÿæ—¥æƒŠå–œ</h2>
                <p id="puzzleTip" class="muted">å°†ç¢ç‰‡ç§»åŠ¨åˆ°æ­£ç¡®ä½ç½®ã€‚å®Œæˆåè‡ªåŠ¨è§£é”æƒŠå–œéŸ³é¢‘ã€‚</p>
                <div class="row" style="align-items:flex-start">
                    <div class="puzzle card" id="puzzleStage" aria-label="3x3æ»‘å—æ‹¼å›¾" role="application"></div>
                    <div class="card" style="padding:14px;min-width:260px">
                        <div class="row"><button class="btn" id="shuffle" type="button">é‡æ–°æ‰“ä¹±</button><button class="btn ghost" id="reveal" type="button">çœ‹åŸå›¾</button></div>
                        <audio id="surprise" class="row" controls src="" preload="none"></audio>
                        <p class="muted">å®Œæˆæç¤ºä¼šå‡ºç°ï¼ŒéŸ³é¢‘å³è§£é”æ’­æ”¾ã€‚</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- å…¨å±€åŠ¨æ•ˆè¦†ç›–å±‚ï¼ˆè‡ªåŠ¨å¼¹å¹• + æ°”çƒï¼‰ï¼Œä¸å æ®å¸ƒå±€ï¼Œpointer-events:none -->
        <div id="fxOverlay" class="fx-overlay" aria-hidden="true">
            <canvas id="fxFireworks"></canvas>
            <div class="barrage" id="fxBarrage"></div>
        </div>

        <!-- ç»å…¸ç”Ÿæ—¥é¡µ Overlayï¼šæ²™ç®±åµŒå…¥ vendor/hb-classic -->
        <div id="hbOverlay" role="dialog" aria-modal="true" aria-label="ç»å…¸ç”Ÿæ—¥é¡µ">
            <button id="hbClose" aria-label="å…³é—­ç»å…¸ç”Ÿæ—¥é¡µ">âœ• å…³é—­</button>
            <iframe id="hbFrame" 
                    title="ç»å…¸ç”Ÿæ—¥é¡µ" 
                    src="./vendor/hb-classic/index.html"
                    loading="lazy"
                    sandbox="allow-scripts allow-same-origin"
                    referrerpolicy="no-referrer">
            </iframe>
        </div>

        

        <footer class="section">
            <div class="container center muted">Â© <span id="year"></span> For Zixian, with stardust. ç¥ä½ ç”Ÿæ—¥å¿«ä¹ã€‚</div>
        </footer>
        </main>

        <script>
        // ===== v3.2 - Config-driven & Global Effects =====
        'use strict';
        
        console.log('ğŸˆ Happy Birthday Script v3.0 - Professional Edition');
        
        /*
        * ===== ç»Ÿä¸€é…ç½®ï¼ˆå¼€å‘è€…åªéœ€æ”¹è¿™é‡Œï¼‰ =====
        * ç”¨é€”ï¼šé›†ä¸­ç®¡ç†ç½‘ç«™æ‰€æœ‰å¯è§æ–‡æ¡ˆ/å‚æ•°ï¼ˆæ ‡é¢˜ã€æŒ‰é’®ã€æç¤ºã€é¢˜åº“ã€åŠ¨æ•ˆç­‰ï¼‰ã€‚
        * ç”Ÿæ•ˆï¼šä¿å­˜å¹¶åˆ·æ–°å³å¯ï¼ˆçº¯é™æ€ï¼Œæ— æ„å»ºæ­¥éª¤ï¼‰ã€‚
        * å®‰å…¨ï¼šç”¨æˆ·è¾“å…¥éƒ½æœ‰ sanitizeï¼›æœ¬é…ç½®ä¸ºé™æ€æ–‡æœ¬ï¼Œå°†æŒ‰åŸæ ·æ¸²æŸ“ã€‚
        * ä½ç½®æ˜ å°„ï¼šæ¯ä¸ªå­—æ®µä¸‹æ–¹é™„æ³¨äº†â€œå‡ºç°ä½ç½®/æ³¨æ„äº‹é¡¹â€ï¼Œä¾¿äºå¿«é€Ÿå®šä½ä¿®æ”¹ã€‚
        */
        const CONFIG = {
            site: {
                // å‡ºç°ä½ç½®ï¼š<title> / og:title / å¯¼èˆªå“ç‰Œ Pill
                title: 'å­èŒœçš„æ˜Ÿæ²³ç”Ÿæ—¥å±• Â· Happy Orbit, å­èŒœ',
                // å‡ºç°ä½ç½®ï¼š<meta name="description"> / og:descriptionï¼ˆç”¨äºåˆ†äº«å¡ç‰‡ï¼‰
                description: 'ä¸ºå­èŒœå®šåˆ¶çš„ä¸€é¡µå¼ç”Ÿæ—¥ç½‘é¡µï¼šç›¸å†Œé“¶æ²³ã€æ—¶é—´è½´ã€æ‹¼å›¾è§£é”ã€å¼¹å¹•æ°”çƒ',
                // å‡ºç°ä½ç½®ï¼šå¯¼èˆªæ å·¦ä¾§å“ç‰Œ
                brand: 'ğŸŒŒ å­èŒœçš„æ˜Ÿæ²³ç”Ÿæ—¥å±•',
                // å‡ºç°ä½ç½®ï¼šog:imageï¼ˆå»ºè®® 1200Ã—630ï¼‰ï¼Œç¤¾äº¤å¹³å°åˆ†äº«é¢„è§ˆå›¾
                ogImage: 'https://images.unsplash.com/photo-1529336953121-a0ce99a0f007?w=1200&h=630&fit=crop',
                // å‡ºç°ä½ç½®ï¼š<meta name="theme-color">ï¼Œå½±å“æµè§ˆå™¨åœ°å€æ /å®‰å“ä»»åŠ¡æ é…è‰²
                themeColor: '#0D1B2A'
            },
            nav: {
                // å‡ºç°ä½ç½®ï¼šé¡¶éƒ¨å¯¼èˆªï¼›ä»…ä¿ç•™ï¼š#photos/#timeline/#puzzle
                photos: 'ç›¸å†Œ', timeline: 'æ—¶é—´è½´', puzzle: 'æ‹¼å›¾'
            },
            hero: {
                // å‡ºç°ä½ç½®ï¼šé¦–é¡µä¸»æ ‡é¢˜ï¼ˆæ”¯æŒå°‘é‡å†…è”æ ·å¼/Emojiï¼‰
                titleHTML: 'Happy Orbit, <span style="color:var(--rose)">å­èŒœ</span> âœ¨',
                // å‡ºç°ä½ç½®ï¼šä¸»æ ‡é¢˜ä¸‹çš„æ‰“å­—æœºå­—å¹•ï¼ˆå¾ªç¯æ˜¾ç¤ºï¼‰ï¼›å¯ç”¨ 'N' ä»£è¡¨æœ¬å¹´ä¸ 2001 çš„å·®å€¼
                lines: ['ä¸ä½ åŒè½¨çš„ç¬¬Næ¬¡ç»•æ—¥æ—…è¡Œã€‚','ä»Šæ™šï¼ŒæŠŠå›å¿†æ’æˆæ˜Ÿåº§ã€‚','ç¥ä½ ç”Ÿæ—¥å¿«ä¹ï¼Œå­èŒœã€‚'],
                // å‡ºç°ä½ç½®ï¼šå¯†è¯­è¾“å…¥æ¡†å ä½
                keyPlaceholder: 'è¾“å…¥å¯†è¯­ï¼ˆå¦‚ç”Ÿæ—¥ï¼š2001-06-18ï¼‰',
                // å‡ºç°ä½ç½®ï¼šå¯†è¯­è§£é”æŒ‰é’®
                unlock: 'è§£é”',
                // å‡ºç°ä½ç½®ï¼šå¼€å§‹é€›å±•æŒ‰é’®ï¼ˆæ»šåŠ¨åˆ°ç›¸å†Œï¼‰
                go: 'å¼€å§‹é€›å±•'
            },
            sections: {
                // ç›¸å†Œæ¨¡å—ï¼šæ ‡é¢˜ + å‰¯æ–‡æ¡ˆï¼ˆæ¨¡å—é¡¶éƒ¨ï¼‰
                photos: { title: 'ğŸ“· ç›¸å†Œé“¶æ²³', sub: 'æ¯ä¸€å¼ ç…§ç‰‡éƒ½æ˜¯æ˜Ÿåº§çš„ä¸€é¢—æ˜Ÿã€‚' },
                // æ—¶é—´è½´æ¨¡å—ï¼šæ ‡é¢˜ + æç¤ºï¼ˆæç¤ºæ˜¾ç¤ºåœ¨å¡ç‰‡ä¸Šæ–¹ï¼‰
                timeline: { title: 'ğŸ—ºï¸ æˆ‘ä»¬çš„æ—¶é—´è½´', tip: 'ç‚¹å‡»å¡ç‰‡ç¿»é¢ï¼ŒæŸ¥çœ‹â€œé‚£å¤©æˆ‘æƒ³è¯´çš„è¯â€ã€‚' },
                
                // æ‹¼å›¾æ¨¡å—ï¼šæ ‡é¢˜/æç¤º/æŒ‰é’®ï¼ˆå®Œæˆåè‹¥è®¾ç½®äº† surpriseAudio åˆ™æ’­æ”¾ï¼‰
                puzzle: { title: 'ğŸ§© å°æ‹¼å›¾ Â· è§£é”ç”Ÿæ—¥æƒŠå–œ', tip: 'å°†ç¢ç‰‡ç§»åŠ¨åˆ°æ­£ç¡®ä½ç½®ã€‚å®Œæˆåè‡ªåŠ¨è§£é”æƒŠå–œéŸ³é¢‘ã€‚', shuffle: 'é‡æ–°æ‰“ä¹±', reveal: 'çœ‹åŸå›¾' },
                // é¡µè„šï¼šæ”¯æŒ {year} å ä½ç¬¦
                footer: 'Â© {year} For å­èŒœ, with stardust. ç¥ä½ ç”Ÿæ—¥å¿«ä¹ã€‚'
            },
            // Toast æç¤ºé›†åˆï¼šæ‰€æœ‰å¼¹å‡ºçš„æ“ä½œç»“æœ/é”™è¯¯æé†’éƒ½ä»è¿™é‡Œå–
            messages: {
                unlockSuccess: 'è§£é”æˆåŠŸï¼šå·²åŠ å…¥éšè—ç›¸å†Œ âœ¨',
                unlockFail: 'å¯†è¯­ä¸å¯¹ï¼Œä½†æ˜Ÿæ˜Ÿä¸ä¼šè®°ä»‡~ ğŸ’«',
                autoplayBlocked: 'è‡ªåŠ¨æ’­æ”¾å—é™ï¼Œè¯·å…ˆä¸é¡µé¢äº¤äº’å†è¯•ä¸€æ¬¡ï½',
                genericIssue: 'é‡åˆ°äº†å°é—®é¢˜ï¼Œä½†ä¸å½±å“ä½¿ç”¨ ğŸŒŸ'
            },
            data: {
                /*
                 * è§£é”å¯†è¯­ï¼ˆæ•°ç»„ï¼‰
                 * - ç”¨é€”ï¼šè§£é”â€œæœªå…¬å¼€â€ç›¸å†Œä¸å°å½©è›‹ã€‚
                 * - åŒ¹é…è§„åˆ™ï¼šä»»ä¸€å‘½ä¸­å³è§†ä¸ºè§£é”ï¼ˆå¿½ç•¥å¤§å°å†™å»ºè®®è‡ªå·±å¤„ç†ï¼‰ã€‚
                 * - æ¨èï¼šåŒ…å«æ—¥æœŸ/æ˜µç§°çš„å˜ä½“ï¼Œé¿å…è¯¯è§¦å‘ã€‚
                 * - å®‰å…¨æ€§ï¼šä»…å­˜åœ¨æœ¬åœ°çŠ¶æ€ï¼Œä¸å­˜æ˜æ–‡ï¼›åˆ·æ–°åéœ€é‡æ–°è¾“å…¥ã€‚
                 */
                secretKeys: ["2001-06-18","20010618","loveu","zixian"],
                /*
                 * ç›¸å†Œåˆ—è¡¨ï¼ˆæ•°ç»„ï¼‰
                 * - ç»“æ„ï¼š{ src, tag, place, time, say }
                 * - srcï¼šå›¾ç‰‡ URLï¼ˆæ”¯æŒ Unsplash ç­‰ https èµ„æºï¼‰ï¼›
                 * - tagï¼šæ ‡ç­¾ï¼ˆè‡ªåŠ¨ç”Ÿæˆè¿‡æ»¤å™¨ï¼Œå¦‚â€œæ—…è¡Œ/æ—¥å¸¸/æç¬‘â€ç­‰ï¼‰ï¼›
                 * - place/timeï¼šåœ°ç‚¹/æ—¶é—´ï¼Œæ˜¾ç¤ºåœ¨å¡ç‰‡æ ‡é¢˜ï¼›
                 * - sayï¼šä¸€å¥è¯æè¿°ï¼›
                 * æ³¨æ„ï¼šå¦‚æœæœªæ¥æŠŠå›¾ç‰‡ç»˜åˆ¶åˆ° Canvas ä¾›ä¸‹è½½ï¼Œéœ€ç¡®ä¿æœåŠ¡ç«¯ CORS å…è®¸ï¼ˆcrossOrigin="anonymous"ï¼‰ã€‚
                 */
                photos: [
                    {src:"https://images.unsplash.com/photo-1529336953121-a0ce99a0f007?q=80&w=1400&auto=format&fit=crop", tag:"æ—…è¡Œ", place:"é’å²›", time:"2023-08", say:"æµ·é£æŠŠä½ çœ¸å­é‡Œçš„å…‰ä¹Ÿå¹äº®äº†"},
                    {src:"https://images.unsplash.com/photo-1520975916090-3105956dac38?q=80&w=1400&auto=format&fit=crop", tag:"æ—¥å¸¸", place:"å®¶", time:"2024-02", say:"ç…è›‹çš„è¾¹ç¼˜åƒæ—¥å‡º"},
                    {src:"https://images.unsplash.com/photo-1489440543286-a69330151c0a?q=80&w=1400&auto=format&fit=crop", tag:"é«˜ç”œ", place:"å’–å•¡é¦†", time:"2024-11", say:"æ‹¿é“æ³¡æ²«ä¸Šçš„å°èƒ¡å­æ¡ˆå‘ç°åœº"},
                    {src:"https://images.unsplash.com/photo-1510772314292-9c0ad4c82d9d?q=80&w=1400&auto=format&fit=crop", tag:"æç¬‘", place:"æ¸¸ä¹å›­", time:"2022-10", say:"å°–å«çš„å’Œç¬‘çš„å…¶å®ä¸€ä¸ªæ„æ€"},
                    {src:"https://images.unsplash.com/photo-1549880338-65ddcdfd017b?q=80&w=1400&auto=format&fit=crop", tag:"æ—…è¡Œ", place:"å±±é‡", time:"2021-07", say:"é“¶æ²³è¦ä»ä½ çš„ç«æ¯›ä¸Šè·¯è¿‡"},
                    {src:"https://images.unsplash.com/photo-1469474968028-56623f02e42e?q=80&w=1400&auto=format&fit=crop", tag:"æ—¥å¸¸", place:"å°åŒº", time:"2024-05", say:"æ™šé£å’Œä½ éƒ½å‡†ç¡®æŠµè¾¾"}
                ],
                // æ—¶é—´è½´å¡ç‰‡ï¼šwhenï¼ˆè§’æ ‡ï¼‰/ frontï¼ˆæ­£é¢ï¼‰/ backï¼ˆåé¢ï¼‰
                // - æŒ‰æ•°ç»„é¡ºåºä»å·¦åˆ°å³é“ºæ’ï¼›
                // - å»ºè®® 4~12 æ¡ä»¥å†…ï¼Œè¿‡å¤šä¼šå½±å“æ»šåŠ¨èŠ‚å¥ï¼›
                timeline: [
                    {when:"åˆè§", front:"ç¬¬ä¸€æ¬¡å¿ƒåŠ¨", back:"å¦‚æœèƒ½å›åˆ°é‚£å¤©ï¼Œæˆ‘ä¼šæ›´å¤§å£°åœ°è¯´ï¼šå¹¸ä¼šï¼Œå®‡å®™èµ å“ã€‚"},
                    {when:"ç¬¬ä¸€æ¬¡æ—…è¡Œ", front:"é”™è¿‡æœ«ç­è½¦", back:"åŸæ¥æ…¢ä¸€ç‚¹ï¼Œä¸–ç•Œä¼šæ›´é…åˆæˆ‘ä»¬ã€‚"},
                    {when:"ç¬¬ä¸€ä»½ç¤¼ç‰©", front:"äº²æ‰‹åšçš„è›‹ç³•", back:"ç³–éœœå¤ªç”œï¼Œä½†ä½ ç¬‘èµ·æ¥åˆšå¥½ã€‚"},
                    {when:"æ¬å®¶é‚£å‘¨", front:"ç®±å­å±±", back:"è°¢è°¢ä½ æŠŠæˆ‘çš„æ··ä¹±ä¹Ÿè£…ç®±æ‰“åŒ…ã€‚"},
                    {when:"ä»Šå¹´ä»Šå¤©", front:"ç”Ÿæ—¥ï¼", back:"ç»§ç»­å¹¶è‚©ï¼Œä»¥æ’æ˜Ÿä½œè·¯ç¯ã€‚"}
                ],
                
                // æ‹¼å›¾èƒŒæ™¯ï¼ˆCSS èƒŒæ™¯åˆ‡ç‰‡æ˜¾ç¤ºï¼›ä¸ç»˜åˆ¶åˆ° Canvasï¼Œä¸å— CORS é™åˆ¶ï¼‰
                // - å»ºè®®ä½¿ç”¨ 1200px ä»¥ä¸Šå®½åº¦çš„æ¨ªå›¾ï¼›
                // - æƒ³æ›¿æ¢ä¸ºæœ¬åœ°å›¾ç‰‡ï¼Œå¯æ”¾åŒç›®å½•ç›¸å¯¹è·¯å¾„ï¼Œå¦‚ './img/puzzle.jpg'ï¼›
                puzzleImg: "https://images.unsplash.com/photo-1500530855697-b586d89ba3ee?q=80&w=1200&auto=format&fit=crop",
                // æ‹¼å›¾å®Œæˆåæ’­æ”¾çš„éŸ³é¢‘ï¼ˆå¯ç•™ç©ºç¦ç”¨ï¼‰
                // - æ”¯æŒ mp3/ogg ç­‰å¸¸è§æ ¼å¼ï¼›
                // - è‹¥å¼•ç”¨è·¨åŸŸèµ„æºï¼Œéœ€ https ä¸”å…è®¸è·¨åŸŸåª’ä½“ï¼›
                surpriseAudio: "",
                // èƒŒæ™¯éŸ³ä¹ï¼ˆå¯¼èˆªä¼šå‡ºç°æ’­æ”¾/é™éŸ³æŒ‰é’®ï¼›ç•™ç©ºåˆ™éšè—æŒ‰é’®ï¼‰
                // - è®¾ç½®ç¤ºä¾‹ï¼š"./audio/music.mp3" æˆ– https é“¾æ¥ï¼›
                // - ç§»åŠ¨ç«¯é€šå¸¸éœ€è¦ç”¨æˆ·ç‚¹å‡»åæ‰å¯æ’­æ”¾ï¼ˆå·²åšæç¤ºï¼‰ã€‚
                bgm: ""
            },
            // ä¸»é¢˜é…ç½®ï¼ˆ'sweet' å¼€å¯ç²‰å«©ä¸»é¢˜ï¼‰
            ui: { theme: 'sweet' },
            effects: {
                // æ€§èƒ½è‡ªé€‚åº”
                performance: {
                    targetFPS: 55, // ç›®æ ‡å¸§ç‡ï¼ˆä»…æ³¨é‡Šç”¨ï¼‰
                    degradeAt: [42, 28], // æ€§èƒ½é˜ˆå€¼ï¼š[é™ç”»è´¨é˜ˆå€¼FPS, åˆ‡æ¢åˆ°2Dé˜ˆå€¼FPS]
                    maxBalloons: 24, 
                    maxBarrages: 60,
                    dprFactor: {"1":0.9,"1.5":1.0,"2":1.05,"3":1.1}
                },
                // å…¨å±€æ°”çƒåŠ¨æ•ˆï¼ˆé¡µé¢ä¸Šå±‚æ¼‚æµ®ï¼‰
                balloons: {
                    enabled: true,
                    physics: true,    // â† æ–°å¢ï¼štrue ä½¿ç”¨ç‰©ç†åŠ¨ç”»ï¼›false ä»ç”¨ CSS keyframes
                    // æ¯åˆ†é’Ÿå¤§çº¦å¤šå°‘ä¸ªæ°”çƒï¼ˆå®é™…è®¡æ—¶å¸¦è½»å¾®éšæœºæŠ–åŠ¨ï¼‰
                    densityPerMinute: 15,
                    // ä¸Šå‡åŠ¨ç”»æ—¶é•¿ï¼ˆç§’åŒºé—´ï¼Œå•ä¸ªæ°”çƒåœ¨åŒºé—´å†…éšæœºï¼‰
                    speedSecRange: [7, 12],
                    // æ°”çƒæ–‡æ¡ˆæ± ï¼ˆä¸ºç©ºæ—¶ä¼šå›é€€åˆ°å†…ç½® DEFAULT_WISHESï¼‰
                    texts: ['ç”Ÿæ—¥å¿«ä¹','æ°¸è¿œå¼€å¿ƒ','æ‰€çˆ±çš†æ‰€å¾—','è¢«ä¸–ç•Œæ¸©æŸ”ä»¥å¾…'],
                    colors: [
                        ['#ff6b9d','#c9184a'],['#ffd93d','#f9a826'],['#6bcf7f','#2d8f47'],['#74c0fc','#339af0'],['#da77f2','#9c36d4'],['#ff8787','#fa5252']
                    ],
                    shape: 'mix',        // 'round' | 'heart' | 'mix'
                    glossy: true,        // é«˜å…‰&è¾¹ç¼˜å…‰
                    depthBlur: [0, 1.5]  // åŒå±æ™¯æ·±ï¼ˆåƒç´ ï¼‰èŒƒå›´
                },
                // å…¨å±€å¼¹å¹•åŠ¨æ•ˆï¼ˆæ¨ªå‘æ»šåŠ¨ï¼‰
                barrage: {
                    enabled: true,
                    // æ¯åˆ†é’Ÿå¤§çº¦å¤šå°‘æ¡å¼¹å¹•ï¼ˆå®é™…è®¡æ—¶å¸¦è½»å¾®éšæœºæŠ–åŠ¨ï¼‰
                    densityPerMinute: 20,
                    // å•æ¡å¼¹å¹•æ»šåŠ¨å…¨å±æ‰€éœ€æ—¶é—´ï¼ˆæ¯«ç§’åŒºé—´ï¼Œå•æ¡åœ¨åŒºé—´å†…éšæœºï¼‰
                    speedMsRange: [5000, 9000],
                    // å¼¹å¹•æ–‡æ¡ˆæ± ï¼ˆä¸ºç©ºæ—¶ä¼šå›é€€åˆ°å†…ç½® DEFAULT_WISHESï¼‰
                    messages: ['å­èŒœç”Ÿæ—¥å¿«ä¹ï¼','æ„¿ä½ æ˜Ÿæ²³é•¿æ˜','ä»Šå¤©ä¹Ÿè¦å¼€å¿ƒï¼','æœ‰æˆ‘åœ¨~','è¦ä¸€ç›´è¢«çˆ±åŒ…å›´']
                }
            },
            // æ‹¼å›¾å¯é…ç½®
            puzzle: { 
                defaultSize: 3, 
                sizeOptions: [3, 4], 
                showGhost: false   // â† æ”¹ä¸º falseï¼Œé»˜è®¤ä¸æ˜¾ç¤ºåº•å›¾
            }
        };

        // ===== æ–‡æ¡ˆæ€»æ§ï¼ˆAlt+E / å¯¼èˆªæŒ‰é’®"ğŸ“ æ–‡æ¡ˆ"ï¼‰=====
        (function CopyCenter(){
        const OVK='COPY_OVERRIDES_V1';
        const isObj=o=>o&&typeof o==='object'&&!Array.isArray(o);
        const norm=p=>p.replace(/\[(\d+)\]/g,'.$1');
        const get=(o,p)=>norm(p).split('.').reduce((a,k)=>a?.[k],o);
        const set=(o,p,v)=>{ const ks=norm(p).split('.'); const last=ks.pop(); let cur=o;
            for(const k of ks){ if(!(k in cur)||!isObj(cur[k])) cur[k]={}; cur=cur[k]; } cur[last]=v; };
        const merge=(t,s)=>{ for(const k in s){ if(isObj(s[k])){ if(!isObj(t[k])) t[k]={}; merge(t[k],s[k]); } else { t[k]=s[k]; } } return t; };
        const collect=(o,prefix='',out=[])=>{
            if(typeof o==='string'){ out.push({path:prefix,value:o}); return out; }
            if(Array.isArray(o)){ o.forEach((it,i)=>collect(it,`${prefix}[${i}]`,out)); return out; }
            if(isObj(o)){ Object.keys(o).forEach(k=>collect(o[k], prefix?`${prefix}.${k}`:k, out)); }
            return out;
        };

        // è½½å…¥å†å²è¦†ç›–
        try{ const raw=localStorage.getItem(OVK); if(raw) merge(CONFIG, JSON.parse(raw)); }catch{}

        // ç»‘å®šä¸åˆ·æ–°ï¼ˆæŠŠ key è®°åˆ° DOMï¼Œä¾¿äºé«˜äº®ä¸é‡æ‰“ï¼‰
        const B=[];
        window.bindText=(sel,key,{html=false}={})=>{
            const el=document.querySelector(sel); if(!el) return;
            const v=get(CONFIG,key); if(v==null) return;
            if(html) el.innerHTML=v; else el.textContent=v;
            el.dataset.copyKey=key; B.push({sel,key,html});
        };
        window.refreshCopy=()=>{
            B.forEach(({sel,key,html})=>{
            const el=document.querySelector(sel); if(!el) return;
            const v=get(CONFIG,key); if(v==null) return;
            if(html) el.innerHTML=v; else el.textContent=v;
            });
            try{ dom.clear(); }catch{}
            try{ gallery.renderFilters(); gallery.render(); }catch{}
            try{ renderTimeline(); }catch{}
            
            if (Array.isArray(CONFIG.hero.lines)) window.__TYPEWRITER_LINES__ = CONFIG.hero.lines.slice();
        };

        // æ–‡æ¡ˆé¢æ¿ UI
        function setupUI(){
            const css=`
            #copyBtn{margin-left:8px}
            #copyPanel{position:fixed;top:0;right:0;width:min(520px,100%);height:100vh;background:#0b1624;
            box-shadow:-24px 0 40px rgba(0,0,0,.4);z-index:9999;display:none;flex-direction:column}
            #copyPanel.open{display:flex}
            #copyPanel header{display:flex;gap:8px;align-items:center;padding:10px;border-bottom:1px solid rgba(255,255,255,.08)}
            #copyPanel input,#copyPanel textarea{width:100%;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);
            color:#e6e6fa;border-radius:8px;padding:8px}
            #copyList{padding:10px;overflow:auto;display:grid;gap:8px}
            .copy-item{display:grid;gap:6px}
            .copy-key{font:12px/1.2 system-ui;color:#9aa7b2}
            [data-copy-highlight] [data-copy-key]::after{
            content:attr(data-copy-key);position:absolute;left:6px;bottom:6px;background:#efb8c8;color:#381a22;border-radius:6px;
            padding:2px 6px;font:12px/1 system-ui }
            `;
            const st=document.createElement('style'); st.textContent=css; document.head.appendChild(st);

            const nav=document.querySelector('.nav-inner');
            const btn=document.createElement('button'); btn.id='copyBtn'; btn.className='pill'; btn.type='button'; btn.textContent='ğŸ“ æ–‡æ¡ˆ';
            btn.addEventListener('click',toggle); if(nav) nav.appendChild(btn);

            const p=document.createElement('div'); p.id='copyPanel';
            p.innerHTML=`
            <header>
                <strong style="flex:1">æ–‡æ¡ˆé¢æ¿</strong>
                <input id="copySearch" placeholder="æœç´¢ key æˆ–å†…å®¹â€¦" />
                <button class="btn ghost" id="copyHighlight">é«˜äº®</button>
                <button class="btn ghost" id="copyExport">å¯¼å‡ºJSON</button>
                <button class="btn ghost" id="copyImport">å¯¼å…¥JSON</button>
                <button class="btn" id="copyClose">å…³é—­</button>
            </header>
            <div id="copyList"></div>`;
            document.body.appendChild(p);

            const list=p.querySelector('#copyList');
            const render=(q='')=>{
            const items=collect(CONFIG).filter(it=>{
                const s=(it.path+' '+it.value).toLowerCase(); return !q || s.includes(q.toLowerCase());
            });
            list.innerHTML='';
            for(const it of items){
                const wrap=document.createElement('div'); wrap.className='copy-item';
                wrap.innerHTML=`<div class="copy-key">${it.path}</div>`;
                const multi=/\n/.test(it.value) || it.value.length>60;
                const field=document.createElement(multi?'textarea':'input');
                field.value=it.value;
                field.addEventListener('input', (e)=>{
                set(CONFIG,it.path,e.target.value);
                localStorage.setItem(OVK, JSON.stringify(CONFIG));
                refreshCopy();
                });
                wrap.appendChild(field); list.appendChild(wrap);
            }
            };
            render();
            p.querySelector('#copySearch').addEventListener('input',e=>render(e.target.value));
            let hl=false; p.querySelector('#copyHighlight').addEventListener('click',()=>{
            hl=!hl; document.documentElement.toggleAttribute('data-copy-highlight',hl);
            });
            p.querySelector('#copyExport').addEventListener('click',()=>{
            const blob=new Blob([JSON.stringify(CONFIG,null,2)],{type:'application/json'});
            const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='copy.json'; a.click();
            setTimeout(()=>URL.revokeObjectURL(a.href),1000);
            });
            p.querySelector('#copyImport').addEventListener('click',()=>{
            const txt=prompt('ç²˜è´´ JSONï¼š'); if(!txt) return;
            try{ merge(CONFIG, JSON.parse(txt)); localStorage.setItem(OVK, JSON.stringify(CONFIG)); refreshCopy(); render(); }
            catch{ alert('JSON æ— æ•ˆ'); }
            });
            
            // â€”â€” èµ„äº§ï¼ˆå›¾ç‰‡ï¼‰ç®¡ç†ï¼šæ‰«æå¹¶ä¸Šä¼ æ›¿æ¢ â€”â€” //
            const ASSET_BOX = document.createElement('details');
            ASSET_BOX.open = true;
            ASSET_BOX.innerHTML = `
            <summary style="padding:8px 10px;border-top:1px solid rgba(255,255,255,.08);cursor:pointer">ğŸ“· èµ„äº§ Â· å›¾ç‰‡æ›¿æ¢</summary>
            <div id="assetList" style="padding:10px;display:grid;gap:10px"></div>`;
            p.appendChild(ASSET_BOX);

            function looksLikeImage(v){
            return typeof v==='string' && /^(data:image\/|https?:\/\/).+/i.test(v);
            }
            // æ”¶é›†æ‰€æœ‰ string å›¾ç‰‡å­—æ®µï¼ˆå«æ•°ç»„ï¼‰
            function collectImageKeys(root){
            const out=[]; const walk=(o, path='')=>{
                if (typeof o==='string'){ if(looksLikeImage(o)) out.push({path,value:o}); return; }
                if (Array.isArray(o)){ o.forEach((it,i)=>walk(it, `${path}[${i}]`)); return; }
                if (o && typeof o==='object'){ Object.keys(o).forEach(k=>walk(o[k], path?`${path}.${k}`:k)); }
            }; walk(root); return out;
            }

            function drawAssets(){
            const box = ASSET_BOX.querySelector('#assetList'); box.innerHTML='';
            const imgs = collectImageKeys(CONFIG);
            imgs.forEach(({path,value})=>{
                const row=document.createElement('div');
                row.style.display='grid'; row.style.gridTemplateColumns='1fr auto'; row.style.gap='8px'; row.style.alignItems='center';
                const left=document.createElement('div');
                const shortValue = value.length > 50 ? value.substring(0, 47) + '...' : value;
                left.innerHTML = `<div class="copy-key">${path}</div>
                <div style="display:flex;gap:8px;align-items:center;margin-top:4px">
                    <img src="${value}" alt="" style="width:64px;height:48px;object-fit:cover;border-radius:6px;border:1px solid rgba(255,255,255,.15)" onerror="this.style.display='none'"/>
                    <input value="${shortValue}" readonly style="cursor:pointer;font-size:11px" title="${value}" />
                </div>`;
                const up=document.createElement('button'); up.className='btn ghost'; up.textContent='ä¸Šä¼ æ›¿æ¢'; up.style.fontSize='12px';
                up.addEventListener('click', async ()=>{
                const f=document.createElement('input'); f.type='file'; f.accept='image/*';
                f.onchange=async ()=>{
                    const file=f.files?.[0]; if(!file) return;
                    const dataUrl = await compressToDataURL(file, 1600, 0.85); // å®½åº¦ä¸Šé™ï¼Œè´¨é‡85%
                    set(CONFIG, path, dataUrl);
                    localStorage.setItem(OVK, JSON.stringify(CONFIG));
                    refreshCopy(); drawAssets();
                }; f.click();
                });
                row.append(left,up); box.appendChild(row);
            });
            }
            drawAssets();

            // å›¾ç‰‡å‹ç¼©åˆ° dataURLï¼ˆé¿å… CORSï¼Œé€‚é…æ‹¼å›¾èƒŒæ™¯ï¼‰
            async function compressToDataURL(file, maxW=1600, quality=0.85){
            return new Promise((resolve)=>{
                const r=new FileReader(); 
                r.onload=()=>{ 
                const i=new Image(); 
                i.onload=()=>{
                    const scale = Math.min(1, maxW / i.width);
                    const w = Math.round(i.width*scale), h=Math.round(i.height*scale);
                    const c=document.createElement('canvas'); c.width=w; c.height=h;
                    const ctx=c.getContext('2d'); ctx.drawImage(i,0,0,w,h);
                    resolve(c.toDataURL('image/jpeg', quality));
                };
                i.src=r.result; 
                }; 
                r.readAsDataURL(file); 
            });
            }
            
            p.querySelector('#copyClose').addEventListener('click',toggle);
            document.addEventListener('keydown',e=>{ if(e.altKey && (e.key==='e'||e.key==='E')){ e.preventDefault(); toggle(); } });
            function toggle(){ p.classList.toggle('open'); }
        }
        if(document.readyState==='loading'){ document.addEventListener('DOMContentLoaded',setupUI); } else setupUI();

        // å°‘é‡ API
        window.__COPY_PANEL__={open:()=>document.getElementById('copyPanel')?.classList.add('open')};
        })();

        // ===== æ€§èƒ½ç›‘æ§ =====
        const perf = {
            start: performance.now(),
            mark: (name) => {
                const t = performance.now() - perf.start;
                console.log(`â±ï¸ ${name}: ${t.toFixed(2)}ms`);
            }
        };

        // å°†é¡µé¢é™æ€æ–‡æ¡ˆä¸å…ƒä¿¡æ¯ä» CONFIG æ³¨å…¥
        function applyConfig(){
            document.title = CONFIG.site.title;
            const metaDesc=document.querySelector('meta[name="description"]'); if(metaDesc) metaDesc.setAttribute('content',CONFIG.site.description);
            const ogTitle=document.querySelector('meta[property="og:title"]'); if(ogTitle) ogTitle.setAttribute('content',CONFIG.site.title);
            const ogDesc=document.querySelector('meta[property="og:description"]'); if(ogDesc) ogDesc.setAttribute('content',CONFIG.site.description);
            const ogImg=document.querySelector('meta[property="og:image"]'); if(ogImg) ogImg.setAttribute('content',CONFIG.site.ogImage);
            const theme=document.querySelector('meta[name="theme-color"]'); if(theme) theme.setAttribute('content',CONFIG.site.themeColor);

            bindText('.nav-inner .pill','site.brand');
            bindText('#navPhotos','nav.photos');
            bindText('#navTimeline','nav.timeline');
            bindText('#navPuzzle','nav.puzzle');

            bindText('h1.title','hero.titleHTML',{html:true});
            const keyInput=document.getElementById('key'); if(keyInput) keyInput.placeholder=CONFIG.hero.keyPlaceholder;
            bindText('#unlock','hero.unlock');
            bindText('#goPhotos','hero.go');
            

            bindText('#photosTitle','sections.photos.title');
            bindText('#photosSub','sections.photos.sub');
            bindText('#timelineTitle','sections.timeline.title');
            bindText('#timelineTip','sections.timeline.tip');
            
            bindText('#puzzleTitle','sections.puzzle.title');
            bindText('#puzzleTip','sections.puzzle.tip');
            bindText('#shuffle','sections.puzzle.shuffle');
            bindText('#reveal','sections.puzzle.reveal');
            

            const footer=document.querySelector('footer .container');
            if(footer) footer.innerHTML=(CONFIG.sections.footer||'').replace('{year}', new Date().getFullYear());

            if(Array.isArray(CONFIG.hero.lines)) window.__TYPEWRITER_LINES__=CONFIG.hero.lines.slice();
        }
        
        // ===== æ•°æ®ï¼ˆæ”¹ä¸ºä» CONFIG è¯»å–ï¼‰ =====
        const DATA = CONFIG.data;

        // ç¥ç¦çŸ­è¯­åº“ï¼ˆç”¨äºè‡ªåŠ¨æˆ–ç©ºè¾“å…¥æ—¶éšæœºï¼‰
        const DEFAULT_WISHES = [
            'æ„¿ä½ å¿«ä¹','å¹³å®‰å–œä¹','ä¸‡äº‹èƒœæ„','å¿ƒæƒ³äº‹æˆ','å‰ç¨‹ä¼¼é”¦',
            'å¾—å¿æ‰€æ„¿','æ—¥æ—¥è‡ªæ–°','é¡ºé£é¡ºæ°´','æ‰€çˆ±çš†æ‰€å¾—','æ°¸è¿œæœ‰å…‰',
            'å²å²å¸¸æ¬¢æ„‰','æ˜Ÿæ²³é•¿æ˜','æ¸©æŸ”ä¸”åšå¼º','è¢«ä¸–ç•Œæ¸©æŸ”ä»¥å¾…'
        ];
        
        // ===== å®‰å…¨å·¥å…·ï¼šæ–‡æœ¬æ¸…ç†ï¼ˆé˜²XSSï¼‰ =====
        const sanitize = {
            text: (str) => String(str || '').slice(0, 500),
            html: (str) => sanitize.text(str).replace(/[<>'"&]/g, c => ({
                '<': '&lt;', '>': '&gt;', "'": '&#39;', '"': '&quot;', '&': '&amp;'
            })[c])
        };
        
        // ===== ç²¾ç¡®ç»•æ—¥æ¬¡æ•°è®¡ç®— =====
        function orbitsSince(isoDate = '2001-06-18') {
            const birth = new Date(isoDate);
            const now = new Date();
            let years = now.getFullYear() - birth.getFullYear();
            const hadBirthday = (now.getMonth() > birth.getMonth()) || 
                            (now.getMonth() === birth.getMonth() && now.getDate() >= birth.getDate());
            return hadBirthday ? years : years - 1;
        }
        
        // ===== Unsplash å“åº”å¼å›¾ç‰‡è¾…åŠ© =====
        const unsplash = (baseUrl, width) => {
            try {
                const url = new URL(baseUrl);
                url.searchParams.set('w', width);
                url.searchParams.set('auto', 'format');
                url.searchParams.set('fit', 'crop');
                url.searchParams.set('q', '80');
                return url.toString();
            } catch {
                return baseUrl;
            }
        };
        
        // ===== LocalStorage å®‰å…¨å°è£… =====
        const storage = {
            get: (key, fallback = null) => {
                try {
                    const val = localStorage.getItem(key);
                    return val ? JSON.parse(val) : fallback;
                } catch { return fallback; }
            },
            set: (key, val) => {
                try {
                    localStorage.setItem(key, JSON.stringify(val));
                    return true;
                } catch { return false; }
            }
        };

        // ===== å·¥å…·ç±»ï¼šæ€§èƒ½ä¼˜åŒ–çš„ DOM æŸ¥è¯¢ =====
        class DOMCache {
            constructor() {
                this.cache = new Map();
            }
            get(selector) {
                if (!this.cache.has(selector)) {
                    this.cache.set(selector, document.querySelector(selector));
                }
                return this.cache.get(selector);
            }
            getAll(selector) {
                return document.querySelectorAll(selector);
            }
            clear() {
                this.cache.clear();
            }
        }
        
        const dom = new DOMCache();
        const $ = (s) => dom.get(s);
        const $$ = (s) => dom.getAll(s);

        // ===== å°å·¥å…·å‡½æ•°ï¼ˆæ”¹è¿›ç‰ˆï¼‰ =====
        const rand = (n) => Math.floor(Math.random() * n);
        const randRange = (min, max) => min + Math.random() * (max - min);
        
        const downloadBlob = (blob, filename) => {
            const a = document.createElement('a');
            const url = URL.createObjectURL(blob);
            a.href = url;
            a.download = filename;
            a.click();
            setTimeout(() => URL.revokeObjectURL(url), 1000);
        };
        
        const debounce = (fn, delay = 150) => {
            let timer;
            return (...args) => {
                clearTimeout(timer);
                timer = setTimeout(() => fn(...args), delay);
            };
        };
        
        const throttle = (fn, limit = 100) => {
            let inThrottle;
            return (...args) => {
                if (!inThrottle) {
                    fn(...args);
                    inThrottle = true;
                    setTimeout(() => inThrottle = false, limit);
                }
            };
        };
        
        // å®‰å…¨çš„ IntersectionObserverï¼ˆæ‡’åŠ è½½ä¼˜åŒ–ï¼‰
        const lazyObserver = 'IntersectionObserver' in window ? new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const img = entry.target;
                    if (img.dataset.src) {
                        img.src = img.dataset.src;
                        img.removeAttribute('data-src');
                        lazyObserver.unobserve(img);
                    }
                }
            });
        }, { rootMargin: '50px' }) : null;
        
        // åŠ¨æ•ˆå§‹ç»ˆå¼€å¯
        const prefersReducedMotion = false;
        const smoothBehavior = 'smooth';

        // é€šç”¨ï¼šCSSåƒç´ åˆ°é«˜DPRç”»å¸ƒç¼©æ”¾ï¼ˆå®‰å…¨ç‰ˆï¼šå…¼å®¹ 2D / WebGLï¼‰
        function scaleCanvas(canvas, ctx) {
            const rect = canvas.getBoundingClientRect();
            // æ—©æœŸå¸ƒå±€æˆ–éšè—æ—¶ rect å¯èƒ½ä¸º 0ï¼Œå…œåº•ç”¨è§†å£å°ºå¯¸
            const cssW = rect.width  || window.innerWidth  || 1;
            const cssH = rect.height || window.innerHeight || 1;
            
            const MAX_DIM = 4096;                         // å•è¾¹åƒç´ ä¸Šé™ï¼Œé˜²å†…å­˜ç‚¸è£‚
            const rawDpr = window.devicePixelRatio || 1;
            const dprCap = Math.min(
                2.5,
                MAX_DIM / Math.max(1, cssW),
                MAX_DIM / Math.max(1, cssH)
            );
            const dpr = Math.max(1, Math.min(rawDpr, dprCap));
            
            const w = Math.max(1, Math.floor(cssW * dpr));
            const h = Math.max(1, Math.floor(cssH * dpr));
            
            if (canvas.width !== w || canvas.height !== h) {
                canvas.width  = w;
                canvas.height = h;
                
                // åªæœ‰ 2D ä¸Šä¸‹æ–‡æ‰éœ€è¦è®¾ç½®å½“å‰å˜æ¢çŸ©é˜µ
                if (ctx && typeof ctx.setTransform === 'function') {
                    ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
                }
            }
            
            return { width: cssW, height: cssH, dpr };
        }
        
        applyConfig();
        
        // ===== å†…è” PWA Manifestï¼ˆåŠ¨æ€ç”Ÿæˆ PNG å›¾æ ‡ï¼Œå…¨éƒ¨åœ¨å†…å­˜ä¸­å®Œæˆï¼‰=====
        function setupInlineManifest(){
          try{
            // ç”¨ Canvas ç°åœºç”Ÿæˆ 192/512 ä¸¤ä¸ª PNG å›¾æ ‡ï¼ˆé¿å…ä»»ä½•å¤–é“¾/æ–‡ä»¶ï¼‰
            const makeIcon = (size) => {
              const c = document.createElement('canvas');
              c.width = c.height = size;
              const ctx = c.getContext('2d');

              // èƒŒæ™¯æ¸å˜
              const g = ctx.createLinearGradient(0,0,size,size);
              g.addColorStop(0, '#0d1b2a');
              g.addColorStop(1, '#2a3a55');
              ctx.fillStyle = g;
              ctx.fillRect(0,0,size,size);

              // ç®€å•"âœ¨"å¾½è®°
              ctx.font = Math.floor(size * 0.55) + 'px serif';
              ctx.textAlign = 'center';
              ctx.textBaseline = 'middle';
              ctx.fillStyle = '#EFB8C8';
              ctx.fillText('âœ¨', size/2, size/2 + size*0.03);

              return {
                src: c.toDataURL('image/png'),
                sizes: `${size}x${size}`,
                type: 'image/png',
                purpose: 'any maskable'
              };
            };

            const icons = [192, 512].map(makeIcon);
            const manifest = {
              name: CONFIG.site.title,
              short_name: 'å­èŒœ',
              start_url: '.',
              scope: '.',
              display: 'standalone',
              background_color: CONFIG.site.themeColor,
              theme_color: CONFIG.site.themeColor,
              description: CONFIG.site.description,
              icons
            };

            const blob = new Blob([JSON.stringify(manifest)], { type: 'application/manifest+json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('link');
            link.rel = 'manifest';
            link.href = url;
            document.head.appendChild(link);
          }catch(err){
            console.log('Manifest å†…è”å¤±è´¥ï¼š', err);
          }
        }
        setupInlineManifest();
        
        // ===== å¯ç”¨ç”œèœœä¸»é¢˜ =====
        if (CONFIG.ui?.theme === 'sweet') { 
            document.body.classList.add('theme-sweet'); 
        }
        
        perf.mark('æ ¸å¿ƒå·¥å…·åˆå§‹åŒ–å®Œæˆ');

        // ===== æ˜Ÿé‡èƒŒæ™¯ & æ‰“å­—æœºï¼ˆä¼˜åŒ–ç‰ˆï¼‰ =====
        const typingEl = $('#typing');
        // ä» CONFIG.hero.lines æ³¨å…¥ï¼Œå¯éšæ—¶åœ¨é¡¶éƒ¨é…ç½®ä¿®æ”¹
        const lines = Array.isArray(window.__TYPEWRITER_LINES__) ? window.__TYPEWRITER_LINES__ : [
            'ä¸ä½ åŒè½¨çš„ç¬¬Næ¬¡ç»•æ—¥æ—…è¡Œã€‚',
            'ä»Šæ™šï¼ŒæŠŠå›å¿†æ’æˆæ˜Ÿåº§ã€‚',
            'ç¥ä½ ç”Ÿæ—¥å¿«ä¹ï¼Œå­èŒœã€‚'
        ];
        
        // æ‰“å­—æœºæ•ˆæœç®¡ç†å™¨
        class TypeWriter {
            constructor(element, lines, speed = 50) {
                this.element = element;
                this.lines = lines;
                this.speed = speed;
                this.lineIdx = 0;
                this.charIdx = 0;
                this.isRunning = false;
            }
            
            start() {
                this.isRunning = true;
                this.tick();
            }
            
            tick() {
                if (!this.isRunning) return;
                
                const str = this.lines[this.lineIdx].replace('N', new Date().getFullYear() - 2001);
                this.element.textContent = str.slice(0, this.charIdx++);
                
                if (this.charIdx <= str.length) {
                    setTimeout(() => this.tick(), this.speed);
                } else {
                    setTimeout(() => {
                        this.charIdx = 0;
                        this.lineIdx = (this.lineIdx + 1) % this.lines.length;
                        this.tick();
                    }, 1200);
                }
            }
            
            stop() {
                this.isRunning = false;
            }
        }
        
        const typeWriter = new TypeWriter(typingEl, lines);
        typeWriter.start();
        
        // ä½¿ç”¨ç²¾ç¡®çš„ç»•æ—¥æ¬¡æ•°è®¡ç®—
        const orbits = orbitsSince('2001-06-18');
        const revolutionsEl = $('#revolutions');
        if (revolutionsEl) revolutionsEl.textContent = orbits;

        // ===== Cosmos èƒŒæ™¯ï¼ˆWebGL æ˜Ÿäº‘ + é“¶æ²³ + æ˜Ÿç¾¤ï¼‰å¸¦è‡ªåŠ¨é™çº§ =====
        function createCosmos(canvas){
            console.log('createCosmos è¢«è°ƒç”¨ï¼Œcanvas:', canvas, 'width:', canvas.width, 'height:', canvas.height);
            // å…ˆè¯• WebGL2ï¼ˆåŸæ¥çš„ CosmosGL â†’ å·²æ”¹å CosmosGL2ï¼‰
            try{ 
                console.log('å°è¯•åˆ›å»º WebGL2 å¼•æ“...');
                const engine = new CosmosGL2(canvas); 
                console.log('âœ“ WebGL2 å¼•æ“åˆ›å»ºæˆåŠŸ');
                return engine;
            }
            catch(err2){
                console.warn('âœ— WebGL2 åˆå§‹åŒ–å¤±è´¥ï¼Œæ”¹è¯• WebGL1ï¼š', err2?.message||err2);
                try{ 
                    console.log('å°è¯•åˆ›å»º WebGL1 å¼•æ“...');
                    const engine = new CosmosGL1(canvas); 
                    console.log('âœ“ WebGL1 å¼•æ“åˆ›å»ºæˆåŠŸ');
                    return engine;
                }
                catch(err1){
                    console.warn('âœ— WebGL1 ä¹Ÿä¸å¯ç”¨ï¼Œå›é€€ 2Dï¼š', err1?.message||err1);
                    console.log('å°è¯•åˆ›å»º 2D Canvas å¼•æ“...');
                    const engine = new StarField2D(canvas);
                    console.log('âœ“ 2D Canvas å¼•æ“åˆ›å»ºæˆåŠŸ');
                    return engine;
                }
            }
        }

        // --- WebGL2 å®ç° ---
        class CosmosGL2{
            constructor(canvas){
                console.log('[CosmosGL2] æ„é€ å‡½æ•°å¼€å§‹, canvas:', canvas);
                this.canvas = canvas;
                this.gl = canvas.getContext('webgl2', { alpha:true, antialias:true, premultipliedAlpha:true });
                if(!this.gl) throw new Error('WebGL2 unavailable');
                console.log('[CosmosGL2] WebGL2 context è·å–æˆåŠŸ');
                this._fpsSamples = [];
                this._quality = 1.0;   // 1.0 é«˜è´¨é‡ â†’ 0.6 ä½è´¨é‡
                this._shoot = [0,0,-10]; // x,y (NDC), time
                this._scroll = 0.0;
                this._lastScrollY = window.scrollY;
                this._time0 = performance.now();
                this._compile();
                this.resize();
                this._bindScroll();
                this._anim = requestAnimationFrame(this._tick.bind(this));
                console.log('[CosmosGL2] æ„é€ å®Œæˆï¼ŒåŠ¨ç”»å¾ªç¯å·²å¯åŠ¨');
            }
            _srcVert(){
                return `#version 300 es
                const vec2 V[3]=vec2[3](vec2(-1.0,-1.0), vec2(3.0,-1.0), vec2(-1.0,3.0));
                void main(){ gl_Position = vec4(V[gl_VertexID],0.0,1.0); }`;
            }
            _srcFrag(){
                return `#version 300 es
                precision highp float;
                out vec4 o;
                uniform vec2 u_res;
                uniform float u_time;
                uniform float u_scroll;    // 0..1
                uniform float u_quality;   // 0.6..1.0
                uniform vec3 u_shoot;      // xy:NDC, z:time

                // hash/noise/fbm
                float h1(vec2 p){ return fract(sin(dot(p,vec2(127.1,311.7)))*43758.5453); }
                float noise(vec2 p){
                    vec2 i=floor(p), f=fract(p);
                    float a=h1(i), b=h1(i+vec2(1,0)), c=h1(i+vec2(0,1)), d=h1(i+vec2(1,1));
                    vec2 u=f*f*(3.0-2.0*f);
                    return mix(a,b,u.x) + (c-a)*u.y*(1.0-u.x) + (d-b)*u.x*u.y;
                }
                float fbm(vec2 p){
                    float v=0.0, a=0.5;
                    for(int i=0;i<5;i++){ v+=a*noise(p); p*=2.0; a*=0.5; }
                    return v;
                }
                // ç¨€ç–æ˜Ÿå±‚ï¼šä¹é‚»åŸŸç‚¹æ˜Ÿ
                float stars(vec2 p, float scale){
                    p*=scale;
                    vec2 i=floor(p), f=fract(p);
                    float s=0.0;
                    for(int y=-1;y<=1;y++){
                        for(int x=-1;x<=1;x++){
                            vec2 g=vec2(x,y);
                            vec2 o=vec2(h1(i+g), h1(i+g+23.1))*0.8;
                            float d=length(f-g-o);
                            s+=smoothstep(0.02, 0.0, d);
                        }
                    }
                    return s;
                }

                // æ˜Ÿç‚¹è‰²æ¸©ï¼ˆ0..1 å†· â†’ æš–ï¼‰
                vec3 starColor(float h){
                    return mix(vec3(0.7,0.82,1.0), vec3(1.0,0.88,0.72), smoothstep(0.2,0.9,h));
                }

                void main(){
                    vec2 uv = (gl_FragCoord.xy/u_res)*2.0-1.0;
                    uv.x *= u_res.x/u_res.y;
                    float t = u_time;

                    // è§†å·®ï¼šéšæ»šåŠ¨æ°´å¹³åç§»ä¸é“¶æ²³å¸¦è§’åº¦
                    // TUNING: è°ƒæ•´ 0.8 å¯æ”¹å˜æ¨ªå‘è§†å·®å¼ºåº¦ï¼ˆè¶Šå¤§è¶Šæ˜æ˜¾ï¼‰
                    float camX = (u_scroll-0.5)*0.8;
                    vec2 p = uv*1.6 + vec2(camX, 0.0);

                    // é“¶æ²³å¸¦ï¼ˆæ—‹è½¬åçš„ y å¸¦çŠ¶ï¼‰
                    // TUNING: è§’åº¦èŒƒå›´ = åŸºå‡† -0.45 + æ»šåŠ¨*1.1ï¼Œå¯æŒ‰éœ€ç¼©å° 1.1 é™ä½æ‘†åŠ¨å¹…åº¦
                    float ang = -0.45 + u_scroll*1.1;
                    mat2 R = mat2(cos(ang), -sin(ang), sin(ang), cos(ang));
                    vec2 q = R*p;
                    // TUNING: å¸¦å®½æ§åˆ¶é¡¹ï¼Œexp(-B*q.y^2) ä¸­ B è¶Šå°è¶Šâ€œè‚¥â€ï¼Œé»˜è®¤ 10.0
                    float band = exp(-14.0*q.y*q.y);

                    // æ˜Ÿäº‘ï¼ˆåŒè‰² fbm è°ƒåˆ¶ï¼‰
                    // TUNING: ä¸¤ç»„ fbm å åŠ æ§åˆ¶â€œäº‘æœµâ€å±‚æ¬¡ä¸æµåŠ¨é€Ÿåº¦
                    float n1 = fbm(p*0.7 + vec2(0.0, t*0.02));   // é€Ÿåº¦ 0.02ï¼ˆå‡å°æ›´é™æ€ï¼‰
                    float n2 = fbm(p.yx*1.5 + vec2(t*0.03, -t*0.02));
                    // TUNING: nebula æµ“åº¦æŒ‡æ•°ï¼špow(..., 1.3) è¶Šå¤§è¶Šâ€œè–„â€ï¼Œ1.1 æ›´æµ“å¯†
                    float neb = pow(smoothstep(0.2, 1.0, n1*0.65 + 0.35*n2), 1.3);
                    // TUNING: èƒŒæ™¯ä¸»è‰²ï¼ˆæ·±è“â†’ç´«è‰²ï¼‰ï¼Œå¯æ›¿æ¢ä¸ºä½ çš„ä¸»é¢˜è‰²
                    vec3 baseCol = mix(vec3(0.04,0.07,0.12), vec3(0.50,0.22,0.60), neb);
                    // TUNING: è“è‰²ç‚¹ç¼€å¼ºåº¦ç³»æ•° 0.12ï¼Œå¯å¾®è°ƒä¸º 0.08~0.18
                    baseCol += 0.12*vec3(0.12,0.34,0.85)*neb*n2;

                    // ä¸‰å±‚æ˜Ÿç¾¤ + é“¶æ²³å¢å¼º + é—ªçƒ
                    // TUNING: ä¸‰å±‚æ˜Ÿå¯†åº¦ï¼ˆæ•°å€¼è¶Šå¤§è¶Šç¨€ç–ï¼‰ï¼š32/80/140
                    float sA = stars(p*1.2 + vec2(t*0.01,0.0), mix(32.0, 48.0, u_quality));
                    float sB = stars(p*0.6, 80.0);
                    float sC = stars(p*0.25, 140.0);
                    // TUNING: é—ªçƒé€Ÿåº¦å› å­ï¼ˆt*3.0ï¼‰ï¼šè°ƒå°æ›´æŸ”å’Œ
                    float tw = 0.5 + 0.5*sin(6.2831*h1(floor(p*80.0))+t*3.0);
                    float stVal = (sA*0.9 + sB*0.6 + sC*0.4) * (0.7+0.3*tw);
                    vec3 stCol = starColor(h1(floor(p*120.0)));
                    stVal *= (0.9 + 0.8*band);

                    // ç‚¹å‡»æŸ”å…‰è„‰å†²ï¼ˆ1.2s è¡°å‡ï¼‰
                    // TUNING: è„‰å†²å¯¿å‘½ï¼ˆ1.2ï¼‰ä¸åŠå¾„é˜ˆå€¼ï¼ˆ0.25ï¼‰å¯æŒ‰éœ€è°ƒæ•´
                    float pulse = 0.0;
                    if(u_shoot.z > 0.0){
                        float life = clamp(1.0 - (t - u_shoot.z)/1.2, 0.0, 1.0);
                        vec2 hit = u_shoot.xy;
                        float d = length(uv - hit);
                        pulse = smoothstep(0.25, 0.0, d) * life;
                    }

                                        float st = stVal;
                                        vec3 col = baseCol + st * stCol;
                    
                                        // 4x4 Bayer æŠ–åŠ¨ï¼Œç¼“è§£è‰²å¸¦
                                        float bayer(vec2 p){
                                            ivec2 ip = ivec2(mod(p, 4.0));
                                            int b[16] = int[16](0,8,2,10,12,4,14,6,3,11,1,9,15,7,13,5);
                                            return float(b[ip.x + ip.y*4]) / 16.0;
                                        }
                    col += pulse*vec3(1.0,0.85,0.6); // TUNING: è„‰å†²é¢œè‰²ï¼ˆæš–é‡‘ï¼‰
                    // è½»å¾®æŠ–åŠ¨å‡å°‘è‰²å¸¦
                    col += (bayer(gl_FragCoord.xy)*0.006 - 0.003);
                    // è½»å¾®ä¼½é©¬ä¸é«˜å…‰ï¼ˆ0.9 è¶Šå°è¶Šäº®ï¼‰
                    col = pow(col, vec3(0.9));
                    o = vec4(col, 1.0);
                }`;
            }
            _srcFrag(){
                return `#version 300 es
                precision highp float;
                out vec4 o;
                uniform vec2 u_res;
                uniform float u_time;
                uniform float u_scroll;   // 0..1
                uniform float u_quality;  // 0.6..1.0
                uniform vec3 u_shoot;     // xy:NDC, z:time

                // hash/noise/fbm
                float h1(vec2 p){ return fract(sin(dot(p,vec2(127.1,311.7)))*43758.5453); }
                float noise(vec2 p){
                    vec2 i=floor(p), f=fract(p);
                    float a=h1(i), b=h1(i+vec2(1,0)), c=h1(i+vec2(0,1)), d=h1(i+vec2(1,1));
                    vec2 u=f*f*(3.0-2.0*f);
                    return mix(a,b,u.x) + (c-a)*u.y*(1.0-u.x) + (d-b)*u.x*u.y;
                }
                float fbm(vec2 p){
                    float v=0.0, a=0.5;
                    for(int i=0;i<5;i++){ v+=a*noise(p); p*=2.0; a*=0.5; }
                    return v;
                }
                // ç¨€ç–æ˜Ÿå±‚ï¼šä¹é‚»åŸŸç‚¹æ˜Ÿ
                float stars(vec2 p, float scale){
                    p*=scale;
                    vec2 i=floor(p), f=fract(p);
                    float s=0.0;
                    for(int y=-1;y<=1;y++){
                        for(int x=-1;x<=1;x++){
                            vec2 g=vec2(float(x),float(y));
                            vec2 o=vec2(h1(i+g), h1(i+g+vec2(23.1,7.7)))*0.8;
                            float d=length(f-g-o);
                            s+=smoothstep(0.02, 0.0, d);
                        }
                    }
                    return s;
                }
                // æ˜Ÿç‚¹è‰²æ¸©
                vec3 starColor(float h){
                    return mix(vec3(0.7,0.82,1.0), vec3(1.0,0.88,0.72), smoothstep(0.2,0.9,h));
                }
                // 4x4 Bayer æŠ–åŠ¨ï¼ˆé¡¶å±‚å®šä¹‰ï¼ï¼‰
                float bayer(vec2 p){
                    ivec2 ip = ivec2(mod(p, 4.0));
                    int b[16] = int[16](0,8,2,10,12,4,14,6,3,11,1,9,15,7,13,5);
                    return float(b[ip.x + ip.y*4]) / 16.0;
                }

                void main(){
                    vec2 uv = (gl_FragCoord.xy/u_res)*2.0-1.0;
                    uv.x *= u_res.x/u_res.y;
                    float t = u_time;

                    // è§†å·® + é“¶æ²³å¸¦æ—‹è½¬
                    float camX = (u_scroll-0.5)*0.8;
                    vec2 p = uv*1.6 + vec2(camX, 0.0);
                    float ang = -0.45 + u_scroll*1.1;
                    mat2 R = mat2(cos(ang), -sin(ang), sin(ang), cos(ang));
                    vec2 q = R*p;
                    float band = exp(-14.0*q.y*q.y);

                    // æ˜Ÿäº‘
                    float n1 = fbm(p*0.7 + vec2(0.0, t*0.02));
                    float n2 = fbm(p.yx*1.5 + vec2(t*0.03, -t*0.02));
                    float neb = pow(smoothstep(0.2, 1.0, n1*0.65 + 0.35*n2), 1.3);
                    vec3 baseCol = mix(vec3(0.04,0.07,0.12), vec3(0.50,0.22,0.60), neb);
                    baseCol += 0.12*vec3(0.12,0.34,0.85)*neb*n2;

                    // ä¸‰å±‚æ˜Ÿç¾¤ + é—ªçƒ
                    float sA = stars(p*1.2 + vec2(t*0.01,0.0), mix(32.0, 48.0, u_quality));
                    float sB = stars(p*0.6, 80.0);
                    float sC = stars(p*0.25, 140.0);
                    float tw = 0.5 + 0.5*sin(6.2831*h1(floor(p*80.0))+t*3.0);
                    float stVal = (sA*0.9 + sB*0.6 + sC*0.4) * (0.7+0.3*tw);
                    vec3 stCol = starColor(h1(floor(p*120.0)));
                    stVal *= (0.9 + 0.8*band);

                    // ç‚¹å‡»æŸ”å…‰è„‰å†²
                    float pulse = 0.0;
                    if(u_shoot.z > 0.0){
                        float life = clamp(1.0 - (t - u_shoot.z)/1.2, 0.0, 1.0);
                        vec2 hit = u_shoot.xy;
                        float d = length(uv - hit);
                        pulse = smoothstep(0.25, 0.0, d) * life;
                    }

                    vec3 col = baseCol + stVal * stCol;
                    col += pulse*vec3(1.0,0.85,0.6);
                    col += (bayer(gl_FragCoord.xy)*0.006 - 0.003); // è½»å¾®æŠ–åŠ¨é™è‰²å¸¦
                    col = pow(col, vec3(0.9));                     // è½»å¾®ä¼½é©¬
                    o = vec4(col, 1.0);
                }`;
            }
            _compile(){
                const gl=this.gl;
                const vs=this._createShader(gl.VERTEX_SHADER, this._srcVert());
                const fs=this._createShader(gl.FRAGMENT_SHADER, this._srcFrag());
                const pr=gl.createProgram();
                gl.attachShader(pr,vs); gl.attachShader(pr,fs); gl.linkProgram(pr);
                if(!gl.getProgramParameter(pr, gl.LINK_STATUS)) throw new Error(gl.getProgramInfoLog(pr)||'link failed');
                gl.deleteShader(vs); gl.deleteShader(fs);
                this.pr=pr;
                this.u_res=gl.getUniformLocation(pr,'u_res');
                this.u_time=gl.getUniformLocation(pr,'u_time');
                this.u_scroll=gl.getUniformLocation(pr,'u_scroll');
                this.u_quality=gl.getUniformLocation(pr,'u_quality');
                this.u_shoot=gl.getUniformLocation(pr,'u_shoot');
            }
            _createShader(type, src){
                const gl=this.gl, sh=gl.createShader(type);
                gl.shaderSource(sh, src); gl.compileShader(sh);
                if(!gl.getShaderParameter(sh, gl.COMPILE_STATUS)) throw new Error(gl.getShaderInfoLog(sh)||'compile failed');
                return sh;
            }
            resize(){
                const gl=this.gl;
                const {width, height} = scaleCanvas(this.canvas, gl); // å¤ç”¨ä½ çš„ DPR é€‚é…
                gl.viewport(0,0,gl.drawingBufferWidth, gl.drawingBufferHeight);
                gl.useProgram(this.pr);
                gl.uniform2f(this.u_res, gl.drawingBufferWidth, gl.drawingBufferHeight);
            }
            _bindScroll(){
                const onScroll = ()=>{
                    const h = document.documentElement;
                    const max = Math.max(1, h.scrollHeight - h.clientHeight);
                    this._scroll = Math.min(1, Math.max(0, window.scrollY / max));
                };
                onScroll();
                window.addEventListener('scroll', throttle(onScroll, 50), { passive:true });
            }
            _tick(now){
                if(!this._ticked){ 
                    console.log('[CosmosGL2] ç¬¬ä¸€å¸§æ¸²æŸ“å¼€å§‹'); 
                    this._ticked = true; 
                }
                const gl=this.gl;
                // å¸§ç‡ä¼°è®¡ï¼šæ¯ 20 å¸§æ»‘çª—ç»Ÿè®¡
                this._fpsSamples.push(now);
                if(this._fpsSamples.length>20){
                    const dt = (this._fpsSamples[this._fpsSamples.length-1]-this._fpsSamples[0])/1000;
                    const fps = 19/dt;
                    this._fpsSamples.shift();
                    // æ€§èƒ½é˜ˆå€¼æ¥è‡ª CONFIG.effects.performance.degradeAtï¼š[é™ç”»è´¨, åˆ‡æ¢2D]
                    const [d1, d2] = CONFIG.effects?.performance?.degradeAt || [48,32];
                    if(fps < d2){ // å½»åº•é™çº§ï¼šåˆ‡æ¢åˆ° 2D
                        this.destroy();
                        this._fallbackTo2D();
                        return;
                    } else if(fps < d1){
                        this._quality = 0.7; // é™ç”»è´¨ï¼ˆå‡å°‘æ˜Ÿå¯†åº¦/é‡‡æ ·ï¼‰
                    } else {
                        this._quality = 1.0; // æ¢å¤é«˜ç”»è´¨
                    }
                }
                const t = (now - this._time0)/1000;
                gl.useProgram(this.pr);
                gl.uniform1f(this.u_time, t);
                gl.uniform1f(this.u_scroll, this._scroll);
                gl.uniform1f(this.u_quality, this._quality);
                gl.uniform3f(this.u_shoot, this._shoot[0], this._shoot[1], this._shoot[2]);
                gl.drawArrays(gl.TRIANGLES, 0, 3);
                this._anim = requestAnimationFrame(this._tick.bind(this));
            }
            _fallbackTo2D(){
                try{ this.gl?.getExtension('WEBGL_lose_context')?.loseContext(); }catch{}
                // è§¦å‘ä¸€æ¬¡å°ºå¯¸é‡ç½®ï¼Œæ¸…ç”»å¸ƒçŠ¶æ€
                this.canvas.width = this.canvas.width;
                
                const engine = new StarField2D(this.canvas);
                
                // âœ… æŠŠå¯¹å¤– API ä»£ç†åˆ° 2D å¼•æ“ï¼Œå¤–éƒ¨ä»£ç ï¼ˆpause/resume/shoot/resizeï¼‰ç»§ç»­å¯ç”¨
                ['resize','pause','resume','shoot'].forEach(m=>{
                    this[m] = engine[m].bind(engine);
                });
            }
            shoot(px,py){
                // å±å¹•åæ ‡â†’NDCï¼ˆä¸ä½  shader ä¸­çš„ uv å¯¹é½ï¼‰
                const r=this.canvas.getBoundingClientRect();
                let x = ((px)/r.width)*2.0 - 1.0;
                let y = ((py)/r.height)*2.0 - 1.0;
                y = -y; // WebGL åæ ‡ç³»ç¿»è½¬
                x *= r.width/r.height; // å®½é«˜æ¯”æ ¡æ­£
                this._shoot = [x,y,(performance.now()-this._time0)/1000];
            }
            pause(){ if(this._anim){ cancelAnimationFrame(this._anim); this._anim=null; } }
            resume(){ if(!this._anim && !prefersReducedMotion){ this._anim=requestAnimationFrame(this._tick.bind(this)); } }
            destroy(){
                this.pause();
                try{
                    // âœ… ç¡®ä¿çœŸæ­£é‡Šæ”¾ WebGL ä¸Šä¸‹æ–‡
                    this.gl?.getExtension('WEBGL_lose_context')?.loseContext();
                }catch{}
                this.gl = null;
            }
        }

        // --- WebGL1 å®ç°ï¼šCosmosGL1ï¼ˆGLSL 1.00ï¼‰---
        class CosmosGL1 {
          constructor(canvas){
            console.log('[CosmosGL1] æ„é€ å‡½æ•°å¼€å§‹, canvas:', canvas);
            this.canvas = canvas;
            const gl = canvas.getContext('webgl', { alpha:true, antialias:true, premultipliedAlpha:true });
            if(!gl) throw new Error('WebGL1 unavailable');
            this.gl = gl;
            console.log('[CosmosGL1] WebGL1 context è·å–æˆåŠŸ');
            this._fpsSamples = [];
            this._quality = 1.0;
            this._shoot = [0,0,-10];
            this._scroll = 0.0;
            this._lastScrollY = window.scrollY;
            this._time0 = performance.now();
            this._compile();
            this._initQuad();
            this.resize();
            this._bindScroll();
            this._anim = requestAnimationFrame(this._tick.bind(this));
            console.log('[CosmosGL1] æ„é€ å®Œæˆï¼ŒåŠ¨ç”»å¾ªç¯å·²å¯åŠ¨');
          }
          _srcVert(){
            // å…¨å±ä¸‰è§’å½¢ï¼ˆWebGL1 æ—  gl_VertexIDï¼Œèµ° attributeï¼‰
            return `
              attribute vec2 a_pos;
              void main(){ gl_Position = vec4(a_pos,0.0,1.0); }
            `;
          }
          _srcFrag(){
            // GLSL ES 1.00 ç‰ˆæœ¬çš„ç‰‡å…ƒç€è‰²å™¨ï¼ˆå»æ‰äº† int æ•°ç»„æŠ–åŠ¨ï¼Œç”¨ hash æŠ–åŠ¨ï¼‰
            return `
              precision mediump float;
              uniform vec2 u_res;
              uniform float u_time;
              uniform float u_scroll;
              uniform float u_quality;
              uniform vec3 u_shoot;

              float h1(vec2 p){ return fract(sin(dot(p,vec2(127.1,311.7)))*43758.5453); }
              float noise(vec2 p){
                vec2 i=floor(p), f=fract(p);
                float a=h1(i), b=h1(i+vec2(1.0,0.0)), c=h1(i+vec2(0.0,1.0)), d=h1(i+vec2(1.0,1.0));
                vec2 u=f*f*(3.0-2.0*f);
                return mix(a,b,u.x) + (c-a)*u.y*(1.0-u.x) + (d-b)*u.x*u.y;
              }
              float fbm(vec2 p){
                float v=0.0, a=0.5;
                for(int i=0;i<5;i++){ v+=a*noise(p); p*=2.0; a*=0.5; }
                return v;
              }
              float stars(vec2 p, float scale){
                p*=scale;
                vec2 i=floor(p), f=fract(p);
                float s=0.0;
                for(int y=-1;y<=1;y++){
                  for(int x=-1;x<=1;x++){
                    vec2 g=vec2(float(x),float(y));
                    vec2 o=vec2(h1(i+g), h1(i+g+vec2(23.1,7.7)))*0.8;
                    float d=length(f-g-o);
                    s+=smoothstep(0.02, 0.0, d);
                  }
                }
                return s;
              }
              vec3 starColor(float h){
                return mix(vec3(0.7,0.82,1.0), vec3(1.0,0.88,0.72), smoothstep(0.2,0.9,h));
              }
              // ç®€æ˜“ hash æŠ–åŠ¨ï¼Œæ›¿ä»£ Bayerï¼ˆGLSL1 å…¼å®¹ï¼‰
              float dither(vec2 p){
                return fract(sin(dot(p, vec2(12.9898,78.233))) * 43758.5453);
              }

              void main(){
                vec2 uv = (gl_FragCoord.xy/u_res)*2.0-1.0;
                uv.x *= u_res.x/u_res.y;
                float t = u_time;

                float camX = (u_scroll-0.5)*0.8;
                vec2 p = uv*1.6 + vec2(camX, 0.0);

                float ang = -0.45 + u_scroll*1.1;
                mat2 R = mat2(cos(ang), -sin(ang), sin(ang), cos(ang));
                vec2 q = R*p;
                float band = exp(-14.0*q.y*q.y);

                float n1 = fbm(p*0.7 + vec2(0.0, t*0.02));
                float n2 = fbm(p.yx*1.5 + vec2(t*0.03, -t*0.02));
                float neb = pow(smoothstep(0.2, 1.0, n1*0.65 + 0.35*n2), 1.3);
                vec3 baseCol = mix(vec3(0.04,0.07,0.12), vec3(0.50,0.22,0.60), neb);
                baseCol += 0.12*vec3(0.12,0.34,0.85)*neb*n2;

                float sA = stars(p*1.2 + vec2(t*0.01,0.0), mix(32.0, 48.0, u_quality));
                float sB = stars(p*0.6, 80.0);
                float sC = stars(p*0.25, 140.0);
                float tw = 0.5 + 0.5*sin(6.2831*h1(floor(p*80.0))+t*3.0);
                float stVal = (sA*0.9 + sB*0.6 + sC*0.4) * (0.7+0.3*tw);
                vec3 stCol = starColor(h1(floor(p*120.0)));
                stVal *= (0.9 + 0.8*band);

                vec3 col = baseCol + stVal * stCol;

                // ç‚¹å‡»æŸ”å…‰è„‰å†²ï¼ˆ1.2sï¼‰
                float pulse = 0.0;
                if(u_shoot.z > 0.0){
                  float life = clamp(1.0 - (t - u_shoot.z)/1.2, 0.0, 1.0);
                  vec2 hit = u_shoot.xy;
                  float d = length(uv - hit);
                  pulse = smoothstep(0.25, 0.0, d) * life;
                }
                col += pulse*vec3(1.0,0.85,0.6);

                // ç®€æ˜“æŠ–åŠ¨é™ä½è‰²å¸¦
                col += (dither(gl_FragCoord.xy)*0.006 - 0.003);

                col = pow(col, vec3(0.9));
                gl_FragColor = vec4(col, 1.0);
              }
            `;
          }
          _compile(){
            const gl=this.gl;
            const vs=this._createShader(gl.VERTEX_SHADER, this._srcVert());
            const fs=this._createShader(gl.FRAGMENT_SHADER, this._srcFrag());
            const pr=gl.createProgram();
            gl.attachShader(pr,vs); gl.attachShader(pr,fs); gl.linkProgram(pr);
            if(!gl.getProgramParameter(pr, gl.LINK_STATUS)) throw new Error(gl.getProgramInfoLog(pr)||'link failed');
            gl.deleteShader(vs); gl.deleteShader(fs);
            this.pr=pr;
            this.u_res=gl.getUniformLocation(pr,'u_res');
            this.u_time=gl.getUniformLocation(pr,'u_time');
            this.u_scroll=gl.getUniformLocation(pr,'u_scroll');
            this.u_quality=gl.getUniformLocation(pr,'u_quality');
            this.u_shoot=gl.getUniformLocation(pr,'u_shoot');
            this.a_pos=gl.getAttribLocation(pr,'a_pos');
          }
          _createShader(type, src){
            const gl=this.gl, sh=gl.createShader(type);
            gl.shaderSource(sh, src); gl.compileShader(sh);
            if(!gl.getShaderParameter(sh, gl.COMPILE_STATUS)) throw new Error(gl.getShaderInfoLog(sh)||'compile failed');
            return sh;
          }
          _initQuad(){
            const gl=this.gl;
            this.buf=gl.createBuffer();
            gl.bindBuffer(gl.ARRAY_BUFFER,this.buf);
            // å…¨å±ä¸‰è§’å½¢é¡¶ç‚¹
            const V=new Float32Array([-1,-1, 3,-1, -1,3]);
            gl.bufferData(gl.ARRAY_BUFFER, V, gl.STATIC_DRAW);
          }
          resize(){
            const gl=this.gl;
            const {width, height} = scaleCanvas(this.canvas, gl); // å¤ç”¨ä½ çš„ DPR é€‚é…
            gl.viewport(0,0,gl.drawingBufferWidth, gl.drawingBufferHeight);
            gl.useProgram(this.pr);
            gl.uniform2f(this.u_res, gl.drawingBufferWidth, gl.drawingBufferHeight);
          }
          _bindScroll(){
            const onScroll = ()=>{
              const h = document.documentElement;
              const max = Math.max(1, h.scrollHeight - h.clientHeight);
              this._scroll = Math.min(1, Math.max(0, window.scrollY / max));
            };
            onScroll();
            window.addEventListener('scroll', throttle(onScroll, 50), { passive:true });
          }
          _tick(now){
            if(!this._ticked){ 
                console.log('[CosmosGL1] ç¬¬ä¸€å¸§æ¸²æŸ“å¼€å§‹'); 
                this._ticked = true; 
            }
            const gl=this.gl;
            // å¸§ç‡ä¼°è®¡ï¼ˆä¸ GL2 åŒé€»è¾‘ï¼‰
            this._fpsSamples.push(now);
            if(this._fpsSamples.length>20){
              const dt = (this._fpsSamples[this._fpsSamples.length-1]-this._fpsSamples[0])/1000.0;
              const fps = 19/dt;
              this._fpsSamples.shift();
              const [d1, d2] = CONFIG.effects?.performance?.degradeAt || [48,32];
              if(fps < d2){ this.destroy(); this._fallbackTo2D(); return; }
              else if(fps < d1){ this._quality = 0.7; } else { this._quality = 1.0; }
            }
            const t = (now - this._time0)/1000.0;
            gl.useProgram(this.pr);
            gl.uniform1f(this.u_time, t);
            gl.uniform1f(this.u_scroll, this._scroll);
            gl.uniform1f(this.u_quality, this._quality);
            gl.uniform3f(this.u_shoot, this._shoot[0], this._shoot[1], this._shoot[2]);

            gl.bindBuffer(gl.ARRAY_BUFFER, this.buf);
            gl.enableVertexAttribArray(this.a_pos);
            gl.vertexAttribPointer(this.a_pos, 2, gl.FLOAT, false, 0, 0);
            gl.drawArrays(gl.TRIANGLES, 0, 3);

            this._anim = requestAnimationFrame(this._tick.bind(this));
          }
          _fallbackTo2D(){
            try{ this.gl?.getExtension('WEBGL_lose_context')?.loseContext(); }catch{}
            this.canvas.width = this.canvas.width;
            const engine = new StarField2D(this.canvas);
            ['resize','pause','resume','shoot'].forEach(m=>{ this[m] = engine[m].bind(engine); });
          }
          shoot(px,py){
            const r=this.canvas.getBoundingClientRect();
            let x = ((px)/r.width)*2.0 - 1.0;
            let y = ((py)/r.height)*2.0 - 1.0;
            y = -y;
            x *= r.width/r.height;
            this._shoot = [x,y,(performance.now()-this._time0)/1000.0];
          }
          pause(){ if(this._anim){ cancelAnimationFrame(this._anim); this._anim=null; } }
          resume(){ if(!this._anim && !prefersReducedMotion){ this._anim=requestAnimationFrame(this._tick.bind(this)); } }
          destroy(){ this.pause(); try{ this.gl?.getExtension('WEBGL_lose_context')?.loseContext(); }catch{} this.gl=null; }
        }

        // --- 2D å¤‡ç”¨ï¼šä¿ç•™ä½ åŸæ¥çš„æ˜Ÿç‚¹ + æµæ˜Ÿç‚¹å‡» ---
        class StarField2D{
            constructor(canvas){
                console.log('[StarField2D] æ„é€ å‡½æ•°å¼€å§‹, canvas:', canvas);
                this.canvas=canvas; 
                this.ctx=canvas.getContext('2d',{alpha:true});
                if (!this.ctx) {
                    try { canvas.getContext('webgl')?.getExtension('WEBGL_lose_context')?.loseContext(); } catch {}
                    this.ctx = canvas.getContext('2d', {alpha:true});
                }
                if (!this.ctx) {
                    console.warn('[StarField2D] 2D context unavailable');
                    return; // å…œåº•ï¼šä¸å†å¯åŠ¨åŠ¨ç”»ï¼Œé¿å…åç»­æŠ¥é”™
                }
                console.log('[StarField2D] 2D context è·å–æˆåŠŸ');
                this.width=0; this.height=0; this.animationId=null;
                this._build(); this.resize();
                this.animate(); // æ€»æ˜¯åŠ¨
                console.log('[StarField2D] æ„é€ å®Œæˆï¼ŒåŠ¨ç”»å¾ªç¯å·²å¯åŠ¨');
            }
            _build(){ this.layer1=[]; this.layer2=[]; this.layer3=[]; this.meteors=[]; }
            resize(){
                const dims = scaleCanvas(this.canvas, this.ctx);
                this.width = dims.width; this.height = dims.height;
                const area = this.width*this.height;
                const base = Math.max(120, Math.floor(area/1200));
                const mk = (n, s, tw) => Array.from({length:n},()=>({
                    x: Math.random()*this.width, y: Math.random()*this.height, s, tw, a: Math.random()*6.283,
                    vx:(Math.random()-.5)*0.06*s, vy:(Math.random()-.5)*0.06*s
                }));
                this.layer1 = mk(Math.floor(base*0.45), 0.6, 1.8);
                this.layer2 = mk(Math.floor(base*0.35), 1.0, 1.2);
                this.layer3 = mk(Math.floor(base*0.20), 1.6, 0.8);
            }
            drawFrame(){
                const ctx=this.ctx;
                if (!ctx) return; // å®ˆå«ï¼šä¸Šä¸‹æ–‡ä¸å¯ç”¨æ—¶ç›´æ¥è¿”å›
                // å…ˆæ¶‚æ·±è‰²èƒŒæ™¯ï¼Œé¿å…é€æ˜å åˆ°æµè§ˆå™¨ç™½åº•
                ctx.fillStyle = '#0b1420';
                ctx.fillRect(0,0,this.width,this.height);
                const paint=(arr)=>arr.forEach(s=>{
                    s.x=(s.x+s.vx+this.width)%this.width; s.y=(s.y+s.vy+this.height)%this.height;
                    s.a+=0.02*s.tw; const tw=0.5+0.5*Math.abs(Math.sin(s.a));
                    ctx.fillStyle=`rgba(255,255,255,${0.35+0.55*tw})`;
                    const sz=s.s*1.6; ctx.fillRect(s.x,s.y,sz,sz);
                });
                paint(this.layer1); paint(this.layer2); paint(this.layer3);
                this.meteors = this.meteors.filter(m=>m.life>0);
                for(const m of this.meteors){
                    m.x+=m.vx; m.y+=m.vy; m.life--;
                    ctx.strokeStyle='rgba(255,255,255,.9)'; ctx.lineWidth=1.2;
                    ctx.beginPath(); ctx.moveTo(m.x,m.y); ctx.lineTo(m.x-m.vx*3,m.y-m.vy*3); ctx.stroke();
                }
            }
            animate(){ 
                if(!this._animStarted){ 
                    console.log('[StarField2D] åŠ¨ç”»å¾ªç¯é¦–æ¬¡æ‰§è¡Œ'); 
                    this._animStarted = true; 
                }
                this.drawFrame(); 
                this.animationId=requestAnimationFrame(()=>this.animate()); 
            }
            shoot(x,y){ this.meteors.push({x,y,vx:-4.5,vy:2.8,life:70}); }
            pause(){ if(this.animationId){ cancelAnimationFrame(this.animationId); this.animationId=null; } }
            resume(){ if(!this.animationId){ this.animate(); } }
            destroy(){ this.pause(); }
        }

        // åˆå§‹åŒ–ï¼šç­‰ä¸€å¸§ï¼Œç¡®ä¿å¸ƒå±€å·²å®Œæˆï¼Œé¿å…æ‹¿åˆ°é”™è¯¯å°ºå¯¸ï¼›å‡†å¤‡å¥½åæ·¡å…¥
        let starField;
        requestAnimationFrame(()=>{
            const canvas = document.getElementById('starfield');
            if (!canvas) {
                console.error('æ˜Ÿç©ºç”»å¸ƒå…ƒç´ æœªæ‰¾åˆ°');
                return;
            }
            console.log('å¼€å§‹åˆå§‹åŒ–æ˜Ÿç©ºèƒŒæ™¯...');
            try {
                starField = createCosmos(canvas);
                // æš´éœ²åˆ°å…¨å±€ï¼Œä¾¿äºè¦†ç›–å±‚æ‰“å¼€æ—¶æš‚åœ/æ¢å¤
                window.starField = starField;
                console.log('æ˜Ÿç©ºå¼•æ“åˆ›å»ºæˆåŠŸ:', starField.constructor.name);
                // æ ‡è®°"ç»˜åˆ¶å‡†å¤‡å°±ç»ª"ï¼Œè§£é™¤é¦–å¸§é€æ˜
                canvas.setAttribute('data-ready','1');
                console.log('æ˜Ÿç©ºç”»å¸ƒå·²æ ‡è®°ä¸º readyï¼Œopacity åº”è¯¥å˜ä¸º 1');
                canvas.addEventListener('click', (e)=>{
                    const r=canvas.getBoundingClientRect();
                    starField.shoot(e.clientX-r.left, e.clientY-r.top);
                }, {passive:true});
                window.addEventListener('resize', debounce(() => starField.resize(), 300), { passive: true });
                document.addEventListener('visibilitychange', () => { document.hidden ? starField.pause() : starField.resume(); });
                perf.mark('æ˜Ÿé‡èƒŒæ™¯åˆå§‹åŒ–å®Œæˆ');
            } catch(err) {
                console.error('æ˜Ÿç©ºåˆå§‹åŒ–å¤±è´¥:', err);
                // å³ä½¿å¤±è´¥ä¹Ÿæ˜¾ç¤ºç”»å¸ƒï¼ˆæ·±è‰²èƒŒæ™¯ï¼‰
                canvas.setAttribute('data-ready','1');
            }
        });

        // å¼€å§‹é€›å±•ï¼ˆæ— å†…è”å¤„ç†ï¼‰
        $('#goPhotos').addEventListener('click', () => {
            const target = document.querySelector('#photos');
            if (target) {
                target.scrollIntoView({ behavior: smoothBehavior });
            }
        });

        // ç»å…¸ç”Ÿæ—¥é¡µï¼šæ‰“å¼€/å…³é—­ + postMessage æ§åˆ¶
        (function(){
            const overlay = document.getElementById('hbOverlay');
            const frame = document.getElementById('hbFrame');
            const openBtn = document.getElementById('navClassic');
            const closeBtn = document.getElementById('hbClose');
            
            const open = (e)=>{ 
                if(e) e.preventDefault(); 
                overlay?.classList.add('open'); 
                // Pause starfield to save resources
                try{ window.starField?.pause(); }catch{} 
                console.log('[Main] Classic birthday overlay opened');
            };
            
            const close = (e)=>{ 
                if(e) e.preventDefault(); 
                // Ask child to stop audio/loops politely
                try{ frame?.contentWindow?.postMessage({type:'hb:pause'}, '*'); }catch{}
                overlay?.classList.remove('open'); 
                // Resume starfield
                try{ window.starField?.resume(); }catch{} 
                console.log('[Main] Classic birthday overlay closed');
            };
            
            openBtn?.addEventListener('click', open);
            closeBtn?.addEventListener('click', close);
            
            // ESC to close
            document.addEventListener('keydown', (ev)=>{ 
                if(overlay?.classList.contains('open') && ev.key==='Escape'){ close(); }
            });
            
            // Listen for milestone events from child (e.g., trigger confetti)
            window.addEventListener('message', (e) => {
                if (e?.data?.type === 'hb:wish') {
                    console.log('[Main] ğŸ‰ Milestone event received: Birthday wish shown!');
                    // Optional: trigger your own celebration effect here
                    // globalFX?.firework(Math.random()*window.innerWidth, Math.random()*200);
                }
            });
        })();

        // ===== å¯†è¯­è§£é” & éšè—ç›¸å†Œï¼ˆå®‰å…¨å¢å¼ºç‰ˆï¼‰ =====
        class SecretManager {
            constructor() {
                this.setupListeners();
                // ä»localStorageæ¢å¤è§£é”çŠ¶æ€ï¼ˆä»…å­˜å¸ƒå°”å€¼ï¼Œä¸å­˜å¯†é’¥ï¼‰
                this.hiddenUnlocked = storage.get('secretUnlocked', false);
                // âœ… ä¸åœ¨æ„é€ å‡½æ•°é‡Œè®¿é—® galleryï¼Œé¿å… TDZ
            }
            
            get hiddenUnlocked() {
                return this._unlocked || false;
            }
            
            set hiddenUnlocked(val) {
                this._unlocked = !!val;
                storage.set('secretUnlocked', this._unlocked);
            }
            
            unlock() {
                const input = $('#key');
                if (!input) return;
                
                // å®‰å…¨ï¼šä½¿ç”¨.valueï¼Œé™åˆ¶é•¿åº¦ï¼Œæ¸…ç†
                const value = sanitize.text(input.value.trim().toLowerCase());
                const isValid = DATA.secretKeys.some(k => k.toLowerCase() === value);
                
                if (isValid) {
                    this.hiddenUnlocked = true;
                    window.gallery?.render(); // âœ… å®‰å…¨è°ƒç”¨
                    this.showToast(CONFIG.messages.unlockSuccess, 'success');
                    input.value = ''; // æ¸…ç©ºè¾“å…¥
                } else {
                    this.showToast(CONFIG.messages.unlockFail, 'info');
                }
            }
            
            setupListeners() {
                const unlockBtn = $('#unlock');
                const keyInput = $('#key');
                
                if (unlockBtn) {
                    unlockBtn.addEventListener('click', () => this.unlock());
                }
                
                if (keyInput) {
                    keyInput.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            this.unlock();
                        }
                    });
                }
                
                // ï¼ˆå·²ç§»é™¤ï¼šZIXIAN è¿ç‚¹å½©è›‹ï¼Œä»…ä¿ç•™å¯†è¯­è§£é”è·¯å¾„ï¼‰
            }
            
            // ç»Ÿä¸€çš„è½»é€šçŸ¥ï¼ˆæ”¯æŒç±»å‹ + è¿›åº¦æ¡ï¼‰
            // ç”¨æ³•ï¼šthis.showToast('æç¤ºè¯­', 'success'|'info'|'error', 3000)
            showToast(message, type = 'info', duration = 3000) {
                const container = $('#toast-container');
                if (!container) return;
                
                const toast = document.createElement('div');
                toast.className = 'notification';
                toast.setAttribute('role', 'status');
                const bg = type === 'success' ? 'rgba(107, 207, 127, 0.95)'
                        : type === 'error' ? 'rgba(248, 113, 113, 0.95)'
                        : 'rgba(142, 197, 255, 0.95)';
                toast.style.cssText = `
                    background:${bg};color:#0D1B2A;padding:14px 18px;border-radius:12px;
                    box-shadow:0 10px 30px rgba(0,0,0,.3);animation:slideIn .25s ease-out;
                    font-weight:700;max-width:360px;display:flex;gap:10px;align-items:center;position:relative;overflow:hidden;
                `;

                // å›¾æ ‡ + æ–‡æœ¬
                const icon = document.createElement('span');
                icon.textContent = type === 'success' ? 'âœ…' : type === 'error' ? 'âŒ' : 'â„¹ï¸';
                const txt = document.createElement('span');
                txt.textContent = sanitize.text(message);
                toast.append(icon, txt);
                
                // è¿›åº¦æ¡ï¼ˆè‡ªåŠ¨æ¶ˆå¤±å€’è®¡æ—¶ï¼‰
                const progress = document.createElement('div');
                progress.style.cssText = `position:absolute;left:0;right:0;bottom:0;height:3px;background:rgba(255,255,255,.5);transform-origin:left;`;
                toast.appendChild(progress);
                container.appendChild(toast);
                
                if (progress.animate) {
                    progress.animate([{transform:'scaleX(1)'},{transform:'scaleX(0)'}], {duration, easing:'linear', fill:'forwards'});
                }
                const t = setTimeout(() => {
                    toast.style.animation = 'slideOut .25s ease-in';
                    setTimeout(() => toast.remove(), 260);
                    clearTimeout(t);
                }, duration);
            }

            // åˆ«åï¼šå…¼å®¹æ—§è°ƒç”¨ï¼ˆå¦‚ï¼šshowNotificationï¼‰
            showNotification(message, type = 'info', duration = 3000){
                this.showToast(message, type, duration);
            }
        }
        
        const secretManager = new SecretManager();

        // ===== ç›¸å†Œæ¸²æŸ“ï¼ˆä¸“ä¸šç‰ˆé‡æ„ï¼‰ =====
        const baseHidden = [
            { src: "https://images.unsplash.com/photo-1519681393784-d120267933ba?q=80&w=1400&auto=format&fit=crop", tag: "æœªå…¬å¼€", place: "å®¶é‡Œæ²™å‘", time: "2024-06", say: "ç¡ç€äº†ä¹Ÿåœ¨ç¬‘ã€‚" },
            { src: "https://images.unsplash.com/photo-1513278974582-3e1b4a4fa21e?q=80&w=1400&auto=format&fit=crop", tag: "æœªå…¬å¼€", place: "å¤œå®µæ‘Š", time: "2024-09", say: "è°è§„å®šå¤œæ·±ä¸èƒ½å¿«ä¹ã€‚" }
        ];
        
        class Gallery {
            constructor() {
                this.currentTag = null;
                this.galleryList = [];
                this.currentIndex = 0;
                this.lightboxOpen = false;
                this.setupKeyboardNav();
            }
            
            getAllPhotos() {
                let list = [...DATA.photos];
                if (secretManager.hiddenUnlocked) {
                    list = list.concat(baseHidden);
                }
                return list;
            }
            
            getTags() {
                const photos = this.getAllPhotos();
                const tags = new Set(photos.map(p => p.tag));
                return Array.from(tags);
            }
            
            renderFilters() {
                const wrap = $('#filters');
                if (!wrap) return;
                
                wrap.innerHTML = '';
                const tags = this.getTags();
                
                const createTag = (tagName) => {
                    const el = document.createElement('button');
                    el.type = 'button';
                    el.className = 'tag';
                    el.textContent = tagName;
                    
                    const isActive = (!this.currentTag && tagName === 'å…¨éƒ¨') || this.currentTag === tagName;
                    el.setAttribute('aria-pressed', isActive ? 'true' : 'false');
                    
                    el.addEventListener('click', () => {
                        this.currentTag = (this.currentTag === tagName) ? null : (tagName === 'å…¨éƒ¨' ? null : tagName);
                        this.renderFilters();
                        this.render();
                    });
                    
                    return el;
                };
                
                wrap.appendChild(createTag('å…¨éƒ¨'));
                tags.forEach(tag => wrap.appendChild(createTag(tag)));
                wrap.appendChild(createTag('æœªå…¬å¼€'));
            }
            
            render() {
                const wrap = $('#gallery');
                if (!wrap) return;
                
                wrap.innerHTML = '';
                
                let list = this.getAllPhotos();
                if (this.currentTag && this.currentTag !== 'å…¨éƒ¨') {
                    list = list.filter(p => p.tag === this.currentTag);
                }
                
                this.galleryList = list;
                
                list.forEach((photo, idx) => {
                    const figure = document.createElement('figure');
                    figure.className = 'photo card';
                    figure.tabIndex = 0;
                    figure.setAttribute('role', 'button');
                    figure.setAttribute('aria-label', `${photo.place || ''} ${photo.time || ''}`.trim());
                    
                    const img = document.createElement('img');
                    img.alt = `${photo.place || ''} ${photo.time || ''}`.trim();
                    
                    // blur-up + shimmer + responsive
                    // TIPS: è°ƒæ•´å ä½ä¸æ¸…æ™°å›¾å°ºå¯¸ï¼š
                    //  - small: 24ï¼ˆpxï¼‰ç”¨äºå¿«é€Ÿä½æ¸…é¢„è§ˆï¼›å¯æ”¹ 16~64ï¼›
                    //  - full:  1200ï¼ˆpxï¼‰ç”¨äºæœ€ç»ˆæ¸…æ™°å›¾ï¼›å¯æŒ‰ä½ å›¾ç‰‡æºå¸¦å®½è°ƒæ•´ï¼›
                    const baseUrl = photo.src;
                    const small = unsplash(baseUrl, 24);
                    const full  = unsplash(baseUrl, 1200);
                    // âœ… åŸç”Ÿæ‡’åŠ è½½ + å¼‚æ­¥è§£ç 
                    img.loading = 'lazy';
                    img.decoding = 'async';
                    figure.classList.add('shimmer');
                    img.classList.add('blur','ready');
                    img.src = small;
                    img.addEventListener('load', function onSmall(){
                        if (img.src === small){
                            img.removeEventListener('load', onSmall);
                            img.src = full;
                        } else {
                            figure.classList.remove('shimmer');
                            img.classList.remove('blur');
                        }
                    });
                    
                    // å›¾ç‰‡åŠ è½½å¤±è´¥å¤„ç†
                    img.addEventListener('error', () => {
                        img.style.display = 'none';     // âœ… ä¸æ˜¾ç¤ºç ´å›¾å›¾æ ‡
                    }, { once: true });
                    
                    // å®‰å…¨ï¼šä½¿ç”¨ DOM æ–¹æ³•è€Œé innerHTML
                    const caption = document.createElement('figcaption');
                    const strong = document.createElement('strong');
                    strong.textContent = `${photo.place || ''} Â· ${photo.time || ''}`;
                    caption.appendChild(strong);
                    caption.appendChild(document.createElement('br'));
                    caption.appendChild(document.createTextNode(photo.say || ''));
                    
                    figure.appendChild(img);
                    figure.appendChild(caption);
                    wrap.appendChild(figure);
                    
                    const openLightbox = () => this.openLightbox(idx);
                    figure.addEventListener('click', openLightbox);
                    figure.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter' || e.key === ' ') {
                            e.preventDefault();
                            openLightbox();
                        }
                    });
                });
            }
            
            openLightbox(idx) {
                // âœ… ä¿å­˜ç„¦ç‚¹ä»¥ä¾¿å…³é—­åæ¢å¤
                this.lastActiveElement = document.activeElement;
                
                this.currentIndex = (idx + this.galleryList.length) % this.galleryList.length;
                const photo = this.galleryList[this.currentIndex];
                
                const bigImg = $('#big');
                const bigCap = $('#bigcap');
                const lightbox = $('#lightbox');
                
                if (!bigImg || !lightbox) return;
                
                bigImg.src = photo.src;
                bigImg.alt = `${photo.place || ''} ${photo.time || ''}`.trim();
                
                if (bigCap) {
                    bigCap.textContent = `${photo.place || ''} Â· ${photo.time || ''} â€” ${photo.say || ''}`;
                }
                
                lightbox.classList.add('open');
                this.lightboxOpen = true;
                
                const closeBtn = $('#closeLight');
                if (closeBtn) closeBtn.focus();
                
                // âœ… å¯ç”¨ç„¦ç‚¹é™·é˜±
                this.trapFocus();
                setupLightboxZoom(); // NEW: pinch/wheel zoom
            }
            
            openLightboxCustom(src, caption) {
                // âœ… ä¿å­˜ç„¦ç‚¹ä»¥ä¾¿å…³é—­åæ¢å¤
                this.lastActiveElement = document.activeElement;
                
                const bigImg = $('#big');
                const bigCap = $('#bigcap');
                const lightbox = $('#lightbox');
                
                if (!bigImg || !lightbox) return;
                
                bigImg.src = src;
                bigImg.alt = caption || 'æ”¾å¤§ç…§ç‰‡';
                
                if (bigCap) {
                    bigCap.textContent = caption || '';
                }
                
                lightbox.classList.add('open');
                this.lightboxOpen = true;
                
                const closeBtn = $('#closeLight');
                if (closeBtn) closeBtn.focus();
                
                // âœ… å¯ç”¨ç„¦ç‚¹é™·é˜±
                this.trapFocus();
            }
            
            closeLightbox() {
                const lightbox = $('#lightbox');
                if (lightbox) {
                    lightbox.classList.remove('open');
                    this.lightboxOpen = false;
                    
                    // âœ… ç§»é™¤ç„¦ç‚¹é™·é˜±
                    if (this.focusTrapHandler) {
                        document.removeEventListener('keydown', this.focusTrapHandler);
                        this.focusTrapHandler = null;
                    }
                    
                    // âœ… æ¢å¤ç„¦ç‚¹åˆ°ä¹‹å‰çš„å…ƒç´ 
                    if (this.lastActiveElement && this.lastActiveElement.focus) {
                        this.lastActiveElement.focus();
                    }
                }
            }
            
            trapFocus() {
                // âœ… ç„¦ç‚¹é™·é˜±ï¼šé™åˆ¶Tabé”®ä»…åœ¨lightboxå†…å¾ªç¯
                const lightbox = $('#lightbox');
                if (!lightbox) return;
                
                const focusableSelector = 'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])';
                
                this.focusTrapHandler = (e) => {
                    if (e.key !== 'Tab' || !this.lightboxOpen) return;
                    
                    const focusableEls = Array.from(lightbox.querySelectorAll(focusableSelector))
                        .filter(el => !el.hasAttribute('disabled') && el.offsetParent !== null);
                    
                    if (focusableEls.length === 0) return;
                    
                    const firstEl = focusableEls[0];
                    const lastEl = focusableEls[focusableEls.length - 1];
                    
                    if (e.shiftKey) {
                        if (document.activeElement === firstEl) {
                            e.preventDefault();
                            lastEl.focus();
                        }
                    } else {
                        if (document.activeElement === lastEl) {
                            e.preventDefault();
                            firstEl.focus();
                        }
                    }
                };
                
                document.addEventListener('keydown', this.focusTrapHandler);
            }
            
            navigateLightbox(direction) {
                if (!this.lightboxOpen || this.galleryList.length === 0) return;
                
                this.currentIndex = (this.currentIndex + direction + this.galleryList.length) % this.galleryList.length;
                this.openLightbox(this.currentIndex);
            }
            
            setupKeyboardNav() {
                window.addEventListener('keydown', (e) => {
                    if (!this.lightboxOpen) return;
                    
                    switch (e.key) {
                        case 'Escape':
                            e.preventDefault();
                            this.closeLightbox();
                            break;
                        case 'ArrowLeft':
                            e.preventDefault();
                            this.navigateLightbox(-1);
                            break;
                        case 'ArrowRight':
                            e.preventDefault();
                            this.navigateLightbox(1);
                            break;
                    }
                });
                
                // è®¾ç½®lightboxäº‹ä»¶
                const closeBtn = $('#closeLight');
                const prevBtn = $('#prevLight');
                const nextBtn = $('#nextLight');
                const lightbox = $('#lightbox');
                
                if (closeBtn) closeBtn.addEventListener('click', () => this.closeLightbox());
                if (prevBtn) prevBtn.addEventListener('click', () => this.navigateLightbox(-1));
                if (nextBtn) nextBtn.addEventListener('click', () => this.navigateLightbox(1));
                if (lightbox) {
                    lightbox.addEventListener('click', (e) => {
                        if (e.target.id === 'lightbox') this.closeLightbox();
                    });
                    // === è§¦å±æ‰‹åŠ¿ï¼šå·¦å³æ»‘åŠ¨åˆ‡æ¢ï¼ˆç§»åŠ¨ç«¯ä½“éªŒå¢å¼ºï¼‰ ===
                    if ('ontouchstart' in window) {
                        let startX = 0, startY = 0;
                        lightbox.addEventListener('touchstart', (e) => {
                            const t = e.touches && e.touches[0];
                            if (!t) return;
                            startX = t.clientX; startY = t.clientY;
                        }, { passive: true });
                        lightbox.addEventListener('touchend', (e) => {
                            if (!this.lightboxOpen) return;
                            const t = e.changedTouches && e.changedTouches[0];
                            if (!t) return;
                            const dx = t.clientX - startX;
                            const dy = t.clientY - startY;
                            if (Math.abs(dx) > Math.abs(dy) && Math.abs(dx) > 50) {
                                if (dx < 0) this.navigateLightbox(1); else this.navigateLightbox(-1);
                            }
                        }, { passive: true });
                    }
                }
            }
        }
        
        // ===== Lightbox pinch/wheel zoom (bounded pan) =====
        function setupLightboxZoom(){
            const img = $('#big'); if(!img) return;
            let scale = 1, tx = 0, ty = 0;
            let sx=0, sy=0, ptId=null;
            let lastD=0, cx=0, cy=0;
            const clamp = ()=> {
                const maxT = (scale-1)*0.5*img.clientWidth;
                const maxY = (scale-1)*0.5*img.clientHeight;
                tx = Math.max(-maxT, Math.min(maxT, tx));
                ty = Math.max(-maxY, Math.min(maxY, ty));
            };
            const apply = ()=> img.style.transform = `translate(${tx}px,${ty}px) scale(${scale})`;
            img.classList.add('zooming');
            img.onwheel = (e)=>{ e.preventDefault();
                const k = e.deltaY<0 ? 1.1 : 0.9;
                const prev=scale; scale = Math.max(1, Math.min(3, scale*k));
                // zoom towards pointer
                const rect = img.getBoundingClientRect();
                const px = e.clientX - rect.left - rect.width/2;
                const py = e.clientY - rect.top  - rect.height/2;
                tx = (tx - px)* (scale/prev) + px;
                ty = (ty - py)* (scale/prev) + py;
                clamp(); apply();
            };
            img.ondblclick = ()=>{ scale = scale>1 ? 1 : 2.2; tx=ty=0; apply(); };
            img.onpointerdown = (e)=>{ img.setPointerCapture(e.pointerId); ptId=e.pointerId; sx=e.clientX; sy=e.clientY; cx=tx; cy=ty; };
            img.onpointermove = (e)=>{ if(ptId!==e.pointerId || scale===1) return; tx=cx+(e.clientX-sx); ty=cy+(e.clientY-sy); clamp(); apply(); };
            img.onpointerup = ()=>{ ptId=null; };
            // pinch (2 pointers)
            let p1=null,p2=null;
            img.addEventListener('pointerdown', (e)=>{ if(!p1) p1=e; else if(!p2) p2=e; }, {passive:true});
            img.addEventListener('pointermove', (e)=>{
                if(!p1||!p2) return;
                if(e.pointerId===p1.pointerId) p1=e; else if(e.pointerId===p2.pointerId) p2=e;
                const d=Math.hypot(p1.clientX-p2.clientX, p1.clientY-p2.clientY);
                if(!lastD) lastD=d;
                const k=d/lastD; const prev=scale; scale=Math.max(1, Math.min(3, scale*k)); lastD=d;
                clamp(); apply();
            }, {passive:true});
            img.addEventListener('pointerup', (e)=>{ if(p1?.pointerId===e.pointerId) p1=null; if(p2?.pointerId===e.pointerId) p2=null; lastD=0; }, {passive:true});
        }
        
        const gallery = new Gallery();
        window.gallery = gallery; // âœ… ç»™ SecretManager ä½¿ç”¨
        gallery.renderFilters();
        gallery.render();
        
        perf.mark('ç›¸å†Œç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ');

        // ===== æ—¶é—´è½´ =====
        function renderTimeline(){
            const lane=$('#lane'); lane.innerHTML='';
            DATA.timeline.forEach(t=>{
                const tc=document.createElement('div'); tc.className='tcard';
                const face=document.createElement('div'); face.className='face'; face.tabIndex=0; face.setAttribute('role','button'); face.setAttribute('aria-pressed','false');

                const front=document.createElement('div'); front.className='front';
                const pill=document.createElement('div'); pill.className='pill'; pill.textContent = sanitize.text(t.when);
                const h3f=document.createElement('h3'); h3f.style.marginTop='8px'; h3f.textContent = sanitize.text(t.front);
                front.append(pill,h3f);

                const back=document.createElement('div'); back.className='back';
                const h3b=document.createElement('h3'); h3b.textContent = sanitize.text(t.when);
                const pb=document.createElement('p'); pb.className='muted'; pb.textContent = sanitize.text(t.back);
                back.append(h3b,pb);

                face.append(front,back); tc.append(face); lane.append(tc);
                const toggle=()=>{ face.classList.toggle('flip'); face.setAttribute('aria-pressed', face.classList.contains('flip')?'true':'false'); };
                face.addEventListener('click',toggle);
                face.addEventListener('keydown',e=>{ if(e.key==='Enter' || e.key===' '){ e.preventDefault(); toggle(); }});
            })
        }
        renderTimeline();

        // ï¼ˆå·²ç§»é™¤ï¼šæ‰­è›‹åˆ¸ã€å°æµ‹é€»è¾‘ï¼‰

        // ===== æ‹¼å›¾ï¼ˆNxN æ»‘å— - å‡çº§ç‰ˆï¼šå¯è§£ä¿è¯ã€åŠ¨ç”»ã€è®¡æ—¶ã€æ‰‹åŠ¿ï¼‰ =====
        class PuzzleGame{
            constructor(){
                this.size = (CONFIG.puzzle?.defaultSize)||3;
                this.stage = $('#puzzleStage');
                this.imageUrl = DATA.puzzleImg;
                this.tiles=[]; this.emptyIndex=-1; this.moves=0; this.t0=0; this.timer=null; this.isSolved=false;
                if(this.stage){ this.setupHUD(); this.build(); this.shuffle(true); this.bindControls(); }
            }
            setupHUD(){
                // åœ¨å³ä¾§å¡ç‰‡åŠ è®¡æ—¶/æ­¥æ•°ä¸å°ºå¯¸åˆ‡æ¢ï¼ˆæ’é™¤æ‹¼å›¾èˆå°æœ¬èº«ï¼‰
                const card = document.querySelector('#puzzle .row .card:not(.puzzle)');
                if(!card) return;
                const hud = document.createElement('div'); hud.className='row'; hud.style.marginTop='8px'; hud.style.display='flex'; hud.style.gap='8px'; hud.style.flexWrap='wrap';
                hud.innerHTML = `
                <div class="pill">ç”¨æ—¶ï¼š<span id="pzTime">00:00</span></div>
                <div class="pill">æ­¥æ•°ï¼š<span id="pzMoves">0</span></div>
                <select id="pzSize" class="pill" style="background:transparent;border-color:rgba(255,255,255,.16);cursor:pointer">
                    ${ (CONFIG.puzzle?.sizeOptions||[3,4]).map(n=>`<option value="${n}" ${n===this.size?'selected':''}>${n}Ã—${n}</option>`).join('') }
                </select>
                <button class="btn ghost" id="pzGhost">${CONFIG.puzzle?.showGhost?'éšè—åº•å›¾':'æ˜¾ç¤ºåº•å›¾'}</button>
                `;
                card.appendChild(hud);
                $('#pzSize').addEventListener('change',e=>{ this.size=+e.target.value; this.build(); this.shuffle(true); });
                $('#pzGhost').addEventListener('click',()=>{ 
                    this.stage.classList.toggle('ghost'); 
                    // åŒæ­¥èƒŒæ™¯ï¼Œæ²¡å¼€ ghost å°±ä¸è¦åŸå›¾
                    this.stage.style.backgroundImage = this.stage.classList.contains('ghost') ? `url(${this.imageUrl})` : 'none';
                    $('#pzGhost').textContent = this.stage.classList.contains('ghost') ? 'éšè—åº•å›¾' : 'æ˜¾ç¤ºåº•å›¾'; 
                });
                if(CONFIG.puzzle?.showGhost) this.stage.classList.add('ghost');
            }
            position(i){ const x=i%this.size, y=(i/this.size|0); return {x, y}; }
            index(x,y){ return y*this.size + x; }
            build(){
                this.stage.innerHTML=''; this.tiles=[];
                const N=this.size*this.size; const bg=this.imageUrl;
                this.stage.style.setProperty('--n', this.size);
                // èƒŒæ™¯å›¾ï¼ˆå¹½çµï¼‰- åªåœ¨å¼€å¯å¹½çµæ¨¡å¼æ—¶æ˜¾ç¤º
                this.stage.style.backgroundImage = this.stage.classList.contains('ghost') ? `url(${bg})` : 'none';
                this.stage.style.backgroundSize = '100% 100%';

                for(let i=0;i<N-1;i++){
                    const d=this.position(i);
                    const t=document.createElement('div'); t.className='tile';
                    t.dataset.correct=i; t.dataset.pos=i;
                    // ä½¿ç”¨ transformï¼Œä¸ç”¨ left/top å¸ƒå±€
                    t.style.transform = `translate(${(d.x*100)}%, ${(d.y*100)}%)`;
                    t.style.width = (100/this.size)+'%'; t.style.height=(100/this.size)+'%';
                    t.style.backgroundImage=`url(${bg})`;
                    t.style.backgroundSize=`${this.size*100}% ${this.size*100}%`;
                    t.style.backgroundPosition=`${(-d.x*100/(this.size-1))}% ${(-d.y*100/(this.size-1))}%`;
                    t.addEventListener('click',()=>this.tryMove(+t.dataset.pos));
                    this.stage.appendChild(t); this.tiles.push(t);
                }
                this.emptyIndex = N-1; this.moves=0; this.updateHUD(); this.isSolved=false;
            }
            updateHUD(){
                const sec=Math.floor((performance.now()-this.t0)/1000)|0;
                const m=String(sec/60|0).padStart(2,'0'), s=String(sec%60).padStart(2,'0');
                const timeEl=$('#pzTime'); if(timeEl) timeEl.textContent=`${m}:${s}`; 
                const movesEl=$('#pzMoves'); if(movesEl) movesEl.textContent=String(this.moves);
            }
            startTimer(){
                this.t0=performance.now(); clearInterval(this.timer);
                this.timer=setInterval(()=>this.updateHUD(), 500);
            }
            stopTimer(){ clearInterval(this.timer); }
            canMove(i){
                const a=this.position(i), b=this.position(this.emptyIndex);
                return (a.x===b.x && Math.abs(a.y-b.y)===1) || (a.y===b.y && Math.abs(a.x-b.x)===1);
            }
            moveTile(i, silent=false){
                const t=this.tiles.find(x=>+x.dataset.pos===i); if(!t) return false;
                const to=this.position(this.emptyIndex);
                t.dataset.pos=this.emptyIndex;
                t.style.transform = `translate(${(to.x*100)}%, ${(to.y*100)}%)`;
                // è§¦æ„Ÿåé¦ˆï¼š
                //  - bumpï¼šè½»å¾®ç¼©æ”¾åŠ¨ç”»ï¼ˆè§ CSS .tile.bumpï¼‰ï¼ŒæŒç»­ 120msï¼›
                //  - vibrateï¼šH5 éœ‡åŠ¨ï¼ˆéƒ¨åˆ†è®¾å¤‡æ”¯æŒï¼‰ï¼Œé»˜è®¤ 8msã€‚
                // å¯æ ¹æ®éœ€è¦è°ƒæ•´æ—¶é•¿/å¼ºåº¦ï¼Œæˆ–ç›´æ¥ç§»é™¤ã€‚
                t.classList.add('bump'); setTimeout(()=>t.classList.remove('bump'),120);
                if(navigator.vibrate) try{ navigator.vibrate(8); }catch{}
                this.emptyIndex=i; if(!silent) this.afterMove(); return true;
            }
            afterMove(){
                this.moves++; this.updateHUD();
                if(this.tiles.every(x=>+x.dataset.pos===+x.dataset.correct) && this.emptyIndex===this.size*this.size-1){
                    if(this.isSolved) return; this.isSolved=true; this.stopTimer();
                    const bestKey=`pz_best_${this.size}`; const sec=(performance.now()-this.t0)/1000;
                    const best=+localStorage.getItem(bestKey) || Infinity;
                    if(sec<best) localStorage.setItem(bestKey, String(Math.floor(sec)));
                    secretManager.showNotification(`æ‹¼å›¾å®Œæˆ ğŸ‰ æœ€ä½³çºªå½•ï¼š${Math.min(best, Math.floor(sec))} ç§’`, 'success');
                    const revealBtn=$('#reveal'); if(revealBtn){ revealBtn.textContent='å·²å®Œæˆ âœ”'; revealBtn.disabled=true; }
                    if (DATA.surpriseAudio){ const audio=$('#surprise'); if(audio){ try{ audio.src=DATA.surpriseAudio; audio.play(); }catch{} } }
                }
            }
            randomPermutation(){
                const N=this.size*this.size; const arr=[...Array(N).keys()];
                // Fisherâ€“Yates æ´—ç‰Œ
                for(let i=N-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; }
                // è®©ç©ºç™½åœ¨å°¾éƒ¨
                const ix=arr.indexOf(N-1); [arr[ix],arr[N-1]]=[arr[N-1],arr[ix]];
                // ä¿è¯å¯è§£
                if(!this.isSolvable(arr)) {
                    // äº¤æ¢ä»»æ„ä¸¤ä¸ªéç©º tile ä¿®æ­£å¥‡å¶
                    [arr[0], arr[1]] = [arr[1], arr[0]];
                }
                return arr;
            }
            isSolvable(arr){
                // arr ä¸º 0..N-1 çš„æ’åˆ—ï¼Œå…¶ä¸­ N-1 ä»£è¡¨ç©ºç™½
                const N=this.size*this.size, blankRowFromBottom=this.size - (Math.floor(arr.indexOf(N-1)/this.size));
                let inv=0;
                for(let i=0;i<N-1;i++)for(let j=i+1;j<N-1;j++) if(arr[i]>arr[j]) inv++;
                if(this.size%2===1) return inv%2===0; // å¥‡æ•°é˜¶ï¼šé€†åºæ•°å¶
                // å¶æ•°é˜¶ï¼šç©ºç™½è‡ªåº•èµ·è¡Œæ•°å¥‡å¶ + é€†åºæ•°å¥‡å¶ == 1
                return ((blankRowFromBottom%2===0) === (inv%2===1));
            }
            shuffle(start=false){
                const perm=this.randomPermutation(); // perm[i]= tileIndex æˆ– N-1(ç©º)
                // æ”¾ç½®
                const N=this.size*this.size;
                for(let i=0;i<N;i++){
                    if(perm[i]===N-1){ this.emptyIndex=i; continue; }
                    const tile=this.tiles.find(t=>+t.dataset.correct===perm[i]);
                    tile.dataset.pos=i;
                    const d=this.position(i);
                    tile.style.transform=`translate(${(d.x*100)}%, ${(d.y*100)}%)`;
                }
                this.moves=0; this.updateHUD(); this.isSolved=false;
                if(start){ this.startTimer(); const revealBtn=$('#reveal'); if(revealBtn){ revealBtn.textContent='çœ‹åŸå›¾'; revealBtn.disabled=false; } }
            }
            tryMove(i){ if(!this.canMove(i)) return; this.moveTile(i); }
            bindControls(){
                // Shuffle & Reveal ä¿æŒ
                $('#shuffle')?.addEventListener('click',()=>{ this.build(); setTimeout(()=>this.shuffle(true),0); });
                $('#reveal')?.addEventListener('click',()=>{ gallery.openLightboxCustom(this.imageUrl,'æ‹¼å›¾åŸå›¾'); });

                // é”®ç›˜ï¼ˆé˜²æ­¢è¯¯è§¦ï¼šè¿‡æ»¤è¾“å…¥åœºæ™¯/å¯¹è¯æ¡†/ç»„åˆé”®ï¼‰
                window.addEventListener('keydown',(e)=>{
                    // è¿‡æ»¤è¾“å…¥åœºæ™¯/å¯¹è¯æ¡†/ç»„åˆé”®
                    const tag = (document.activeElement?.tagName||'').toUpperCase();
                    if (tag==='INPUT' || tag==='TEXTAREA' || tag==='SELECT') return;
                    if (e.ctrlKey || e.metaKey || e.altKey) return;
                    if (document.querySelector('.lightbox.open')) return;

                    const b=this.position(this.emptyIndex); let n=null;
                    if(e.key==='ArrowUp') n=this.index(b.x, b.y+1);
                    else if(e.key==='ArrowDown') n=this.index(b.x, b.y-1);
                    else if(e.key==='ArrowLeft') n=this.index(b.x+1, b.y);
                    else if(e.key==='ArrowRight') n=this.index(b.x-1, b.y);
                    if(n!=null && n>=0 && n<this.size*this.size) { e.preventDefault(); this.tryMove(n); }
                });

                // è§¦æ‘¸åˆ’åŠ¨
                if('ontouchstart' in window){
                    let sx=0,sy=0;
                    this.stage.addEventListener('touchstart',e=>{ const t=e.touches[0]; sx=t.clientX; sy=t.clientY; }, {passive:true});
                    this.stage.addEventListener('touchend',e=>{
                        const t=e.changedTouches[0]; const dx=t.clientX-sx, dy=t.clientY-sy;
                        if(Math.abs(dx)<30 && Math.abs(dy)<30) return;
                        const b=this.position(this.emptyIndex); let n=null;
                        if(Math.abs(dx)>Math.abs(dy)) n = dx>0? this.index(b.x-1,b.y) : this.index(b.x+1,b.y);
                        else n = dy>0? this.index(b.x,b.y-1) : this.index(b.x,b.y+1);
                        if(n!=null) this.tryMove(n);
                    }, {passive:true});
                }
            }
        }
        
        const puzzleGame = new PuzzleGame();
        
        perf.mark('æ‹¼å›¾ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ');

        // ===== v3.2 - Config-driven & Global Effects =====
        class GlobalFX {
            constructor(){
                this.overlay = document.getElementById('fxOverlay');
                this.barrageEl = document.getElementById('fxBarrage');
                this.canvas = document.getElementById('fxFireworks');
                this.ctx = this.canvas ? this.canvas.getContext('2d', { alpha: true }) : null;
                this.particles = [];
                this.animationId = null;
                this.timers = [];
                if (this.canvas && this.ctx){
                    this.resize();
                    window.addEventListener('resize', debounce(()=>this.resize()), {passive:true});
                    this.startParticleLoop();
                }
                this.startAutoLoops();
            }
            resize(){ if (this.canvas && this.ctx) scaleCanvas(this.canvas, this.ctx); }
            startParticleLoop(){
                const tick = ()=>{
                    const w = this.canvas.clientWidth || 300;
                    const h = this.canvas.clientHeight || 300;
                    this.ctx.clearRect(0,0,w,h);
                    this.particles.forEach(p=>{
                        p.x += p.vx; p.y += p.vy; p.vx *= 0.985; p.vy = p.vy*0.985 + 0.06; p.life--;
                        this.ctx.fillStyle = p.color; this.ctx.fillRect(p.x,p.y,2,2);
                    });
                    // ç”Ÿå‘½æœŸä¸æ€»é‡æ§åˆ¶ï¼Œé¿å…æç«¯æƒ…å†µä¸‹ç²’å­æ— é™å¢é•¿å¯¼è‡´å†…å­˜è†¨èƒ€
                    this.particles = this.particles.filter(p=>p.life>0);
                    if (this.particles.length > 2200) {
                        this.particles = this.particles.slice(-1800);
                    }
                    this.animationId = requestAnimationFrame(tick);
                }; tick();
            }
            firework(x,y){
                if (this.particles.length > 2000) return; // èƒŒå‹ï¼šç²’å­è¿‡å¤šæ—¶è·³è¿‡æ–°ä¸€è½®çƒŸèŠ±
                for(let i=0;i<60;i++){
                    const a=(i/60)*2*Math.PI;
                    this.particles.push({x,y,vx:Math.cos(a)*(2+Math.random()*3),vy:Math.sin(a)*(2+Math.random()*3),life:50+rand(30),color:`hsl(${rand(360)},90%,70%)`});
                }
            }
            popConfetti(x,y){
                if (this.particles.length > 2000) return; // èƒŒå‹ï¼šç²’å­è¿‡å¤šæ—¶è·³è¿‡çº¸å±‘
                for(let i=0;i<36;i++){
                    const a=(i/36)*2*Math.PI;
                    this.particles.push({x,y,vx:Math.cos(a)*(1+Math.random()*2),vy:Math.sin(a)*(1+Math.random()*2),life:40+rand(20),color:`hsl(${rand(360)},90%,70%)`});
                }
            }
            spawnBalloon(){
                if (!this.overlay || !CONFIG.effects.balloons?.enabled) return;
                // æ€§èƒ½æ§åˆ¶ï¼šé™åˆ¶åŒå±æ°”çƒæ•°
                if (!this.activeBalloons) this.activeBalloons = 0;
                const maxBalloons = CONFIG.effects.performance?.maxBalloons || 24;
                if (this.activeBalloons >= maxBalloons) return;
                
                const texts = CONFIG.effects.balloons.texts?.length? CONFIG.effects.balloons.texts : DEFAULT_WISHES;
                const colors = CONFIG.effects.balloons.colors;
                const el = document.createElement('div'); el.className = 'balloon';
                
                // å½¢çŠ¶ï¼šround | heart | mix
                const shape = CONFIG.effects.balloons.shape || 'round';
                if (shape==='heart' || (shape==='mix' && Math.random()<0.5)) el.classList.add('heart');

                // é¢œè‰²/ä½ç½®
                const pair = colors[rand(colors.length)]; 
                el.style.setProperty('--balloon-color', pair[0]); 
                el.style.setProperty('--balloon-dark', pair[1]);
                const w = this.overlay.clientWidth || window.innerWidth; 
                const x = 20 + Math.random()*Math.max(100, w-100); 
                el.style.left = x+'px';
                el.style.setProperty('--drift', ((Math.random()-0.5)*120)+'px'); 
                el.style.setProperty('--rotate', ((Math.random()-0.5)*12)+'deg');
                
                // æ–°ç»“æ„ï¼šç»„ + æ°”çƒ + ç‹¬ç«‹ç³»ç»“ + çº¿ + æ–‡å­—
                const g  = document.createElement('div'); g.className  = 'g';
                const b  = document.createElement('div'); b.className  = 'b';
                const k  = document.createElement('i');   k.className  = 'k';   // â† ç‹¬ç«‹ç³»ç»“
                
                // ç”¨ SVG ç”»ä¸€æ¡ 2px çº¿ï¼Œåœ†ç«¯ -> ä¸ä¼šå‡ºç°"ç®­å¤´"
                const s = document.createElementNS('http://www.w3.org/2000/svg','svg');
                s.setAttribute('class','s');
                s.setAttribute('width','2');
                s.setAttribute('height','66');
                s.setAttribute('viewBox','0 0 2 66');

                const line = document.createElementNS('http://www.w3.org/2000/svg','line');
                line.setAttribute('x1','1'); line.setAttribute('y1','0');
                line.setAttribute('x2','1'); line.setAttribute('y2','66');
                line.setAttribute('stroke','rgba(255,255,255,0.85)');
                line.setAttribute('stroke-width','2');
                line.setAttribute('stroke-linecap','round');

                s.appendChild(line);
                const t  = document.createElement('small'); t.textContent = texts[rand(texts.length)];

                g.append(b, k, s);  // ä»ç„¶ä¿æŒ b -> k -> s çš„ç»“æ„
                el.append(g, t);
                this.overlay.appendChild(el);
                this.activeBalloons++;

                // â€”â€” æ™¯æ·±ï¼šåªç»™æ°”çƒæœ¬ä½“ï¼Œä¸ç»™æ–‡å­— â€”â€” //
                const [minBlur, maxBlur] = CONFIG.effects.balloons.depthBlur || [0, 1.5];
                const blur = (minBlur + Math.random() * (maxBlur - minBlur)).toFixed(1);
                b.style.setProperty('--dof', blur > 0 ? `blur(${blur}px)` : 'none');   // â† ä»… .b æ¨¡ç³Š
                g.style.filter = 'drop-shadow(0 10px 18px rgba(0,0,0,.35))';           // é˜´å½±ç»™ç»„

                const [minS,maxS]=CONFIG.effects.balloons.speedSecRange||[7,12]; 
                const dur = minS + Math.random()*(maxS-minS);
                
                // æ–°ï¼šç‰©ç† or é€€å› CSS
                if (CONFIG.effects.balloons.physics) {
                    el.style.animation = 'none';
                    this.animateBalloonPhysics(el, g);  // â† ä¼ å…¥ g ç”¨äºæ—‹è½¬
                } else {
                    el.style.animation=`floatUp ${dur}s ease-out forwards`;
                    setTimeout(()=>{ 
                        if (el.parentNode) el.remove(); 
                        this.activeBalloons--; 
                    }, dur*1000 + 500);
                }

                el.addEventListener('click',()=>{ 
                    const r=el.getBoundingClientRect(); 
                    this.popConfetti(r.left+r.width/2, r.top+r.height/2); 
                    el.remove(); 
                    this.activeBalloons--; 
                },{once:true});
            }

            animateBalloonPhysics(el, g){
                // èµ·ç‚¹åœ¨åº•éƒ¨é™„è¿‘
                let x = parseFloat(el.style.left) || 100; // pxï¼Œä» spawn æ—¶å®šçš„
                let y = 0;                                 // ç›¸å¯¹åº•éƒ¨çš„ä½ç§»ï¼ˆpxï¼‰
                let vx = randRange(-8, 8);                 // px/s
                let vy = randRange(35, 55);                // px/s å‘ä¸Š
                const LIFT   = randRange(18, 26);          // px/s^2 æµ®åŠ›
                const DRAG   = 0.85;                       // s^-1 é€Ÿåº¦é˜»å°¼
                const WIND_A = randRange(6, 14);           // px/s^2 é£å¼º
                const WIND_W = randRange(0.4, 0.9);        // Hz é£é¢‘
                const W = this.overlay.clientWidth  || window.innerWidth;
                const H = this.overlay.clientHeight || window.innerHeight;

                let t = Math.random()*1000;
                let last = performance.now();

                const step = (now)=>{
                    const dt = Math.min(0.033, (now - last)/1000); // ç§’ï¼Œæœ€å¤§ 33ms
                    last = now;
                    t += dt;

                    // ä¸¤ä¸ªæ­£å¼¦å åŠ å½“ä½œé£ï¼ˆè¿‘ä¼¼å™ªå£°ï¼‰
                    const wind = Math.sin(2*Math.PI*WIND_W*t) + 0.5*Math.sin(2*Math.PI*(WIND_W*0.37 + 0.11)*t);

                    // åŠ é€Ÿåº¦
                    const ax = WIND_A * wind - vx * DRAG;  // é£ + é˜»å°¼
                    const ay = LIFT - vy * DRAG;           // æµ®åŠ› - é˜»å°¼

                    // é€Ÿåº¦ã€ä½ç½®ç§¯åˆ†
                    vx += ax * dt;
                    vy += ay * dt;
                    x  += vx * dt;
                    y  += vy * dt;

                    // ä¾§è¾¹è½¯åå¼¹
                    if (x < 18)      { x = 18;      vx *= -0.4; }
                    if (x > W - 18)  { x = W - 18;  vx *= -0.4; }

                    // åº”ç”¨åˆ° DOMï¼ˆç”¨ bottom è¡¨ç¤ºä¸Šå‡ï¼‰
                    el.style.left   = x + 'px';
                    el.style.bottom = (20 + y) + 'px';

                    // æ ¹æ®é€Ÿåº¦æ–¹å‘ç»™æ°”çƒ/ç»³ä¸€ä¸ªå€¾è§’ - åªè½¬ç»„ï¼šçº¿å’Œçƒæ°¸è¿œè¿åœ¨ä¸€èµ·
                    const ang = Math.max(-18, Math.min(18, Math.atan2(vx, Math.abs(vy) + 12) * 57.2958));
                    if (g) g.style.transform = `rotate(${ang}deg)`;   // â† åªè½¬ç»„

                    // è¶…å‡ºå±å¹•å›æ”¶
                    if (y > H + 160) { el.remove(); this.activeBalloons--; return; }
                    requestAnimationFrame(step);
                };
                requestAnimationFrame(step);
            }

            spawnBarrage(text){
                if (!this.barrageEl || !CONFIG.effects.barrage.enabled) return;
                const list = CONFIG.effects.barrage.messages||[]; const msg = sanitize.text(text || (list.length? list[rand(list.length)]: DEFAULT_WISHES[rand(DEFAULT_WISHES.length)]));
                const dir = Math.random()<0.5?'left':'right'; const el=document.createElement('div'); el.className='msg'; el.textContent=msg; this.barrageEl.appendChild(el);
                const stageW=this.barrageEl.clientWidth||window.innerWidth; const stageH=this.barrageEl.clientHeight||window.innerHeight; const y=30+Math.random()*Math.max(50, stageH-80); el.style.top=y+'px';
                const [minMs,maxMs]=CONFIG.effects.barrage.speedMsRange||[5000,9000]; const duration=minMs+Math.random()*(maxMs-minMs); const start=performance.now();
                let startX,endX; if (dir==='left'){ startX=stageW+20; endX=-(el.offsetWidth+40);} else { startX=-(el.offsetWidth+40); endX=stageW+20; } el.style.left=startX+'px';
                let sparked=false; const step=(now)=>{ const p=Math.min(1,(now-start)/duration); const x=startX+(endX-startX)*p; el.style.left=x+'px'; if(!sparked && p>0.45 && p<0.48){ sparked=true; this.firework(Math.max(20, Math.min(stageW-20, x + el.offsetWidth*0.5)), y); }
                    if(p<1) requestAnimationFrame(step); else el.remove(); }; requestAnimationFrame(step);
            }
            startAutoLoops(){
                const bd = Math.max(1, CONFIG.effects.balloons.densityPerMinute||0); const bi = Math.max(500, 60000/bd);
                const td = Math.max(1, CONFIG.effects.barrage.densityPerMinute||0); const ti = Math.max(400, 60000/td);
                const balloonTick=()=>{ if(!document.hidden) this.spawnBalloon(); this.timers.push(setTimeout(balloonTick, bi*(0.8+Math.random()*0.4))); };
                const barrageTick=()=>{ if(!document.hidden) this.spawnBarrage(); this.timers.push(setTimeout(barrageTick, ti*(0.8+Math.random()*0.4))); };
                setTimeout(balloonTick, 1200); setTimeout(barrageTick, 1600);
            }
            pause(){ if (this.animationId){ cancelAnimationFrame(this.animationId); this.animationId=null; } }
            resume(){ if (!this.animationId) this.startParticleLoop(); }
        }
        const globalFX = new GlobalFX();
        
        // ===== Resize Guardï¼ˆç¼©æ”¾/å°ºå¯¸å‰§çƒˆå˜åŒ–æ—¶ï¼Œä¸´æ—¶é™è½½ï¼‰ =====
        (function setupResizeGuard(){
            let timer=null, active=false; const html=document.documentElement;
            const kick=()=>{
                if(!active){
                    active=true; html.classList.add('resizing');
                    try{ starField.pause(); }catch{}
                    try{ globalFX.pause(); }catch{}
                }
                clearTimeout(timer);
                timer=setTimeout(()=>{
                    active=false; html.classList.remove('resizing');
                    try{ starField.resume(); }catch{}
                    try{ globalFX.resume(); }catch{}
                }, 450);
            };
            window.addEventListener('resize', kick, {passive:true});
            window.addEventListener('wheel', (e)=>{ if(e.ctrlKey) kick(); }, {passive:true}); // Ctrl+æ»šè½®=ç¼©æ”¾
        })();
        // é¡µé¢å¯è§æ€§å˜åŒ–ï¼šæš‚åœ/æ¢å¤
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) { globalFX.pause(); } else { globalFX.resume(); }
        });

        // ===== æ‚é¡¹ & æœ€ç»ˆåˆå§‹åŒ– =====
        // 1) Web Share åˆ†äº«æŒ‰é’®ï¼ˆå¯é€‰ï¼‰
        // - å¦‚éœ€å…³é—­ï¼Œåˆ é™¤æˆ–æ³¨é‡Šè°ƒç”¨ setupSharingButton()
        function setupSharingButton(){
            if (!navigator.share) return; // ä»…åœ¨æ”¯æŒè®¾å¤‡ä¸Šæ˜¾ç¤º
            const navInner = document.querySelector('.nav-inner');
            if (!navInner) return;
            const btn = document.createElement('button');
            btn.className = 'btn ghost';
            btn.type = 'button';
            btn.textContent = 'åˆ†äº«';
            btn.title = 'è°ƒç”¨ç³»ç»Ÿåˆ†äº«é¢æ¿';
            btn.addEventListener('click', async ()=>{
                try{
                    await navigator.share({
                        title: document.title,
                        text: 'ä¸€èµ·æ¥çœ‹å­èŒœçš„ç”Ÿæ—¥æ˜Ÿæ²³å±•è§ˆå§ï¼',
                        url: location.href
                    });
                }catch(err){
                    console.log('åˆ†äº«å–æ¶ˆ/å¤±è´¥ï¼š', err?.message || err);
                }
            });
            navInner.appendChild(btn);
        }
        setupSharingButton();

        // 2) èƒŒæ™¯éŸ³ä¹ï¼ˆå¯é€‰ï¼‰ï¼š
        // - åœ¨ DATA.bgm è®¾ç½®ä¸ºä½ çš„éŸ³ä¹åœ°å€ï¼ˆæ”¯æŒæœ¬åœ°ç›¸å¯¹è·¯å¾„æˆ– CSP æ”¾è¡Œçš„ https åŸŸï¼‰ï¼›
        // - è‹¥ç•™ç©ºåˆ™ä¸æ˜¾ç¤º BGM åˆ‡æ¢æŒ‰é’®ï¼›
        function setupBackgroundMusic(){
            try{
                if (!DATA.bgm) return; // æœªé…ç½®åˆ™è·³è¿‡
                const navInner = document.querySelector('.nav-inner');
                if (!navInner) return;
                const audio = document.createElement('audio');
                audio.id = 'bgm';
                audio.loop = true;
                audio.preload = 'none';
                audio.src = DATA.bgm;
                document.body.appendChild(audio);
                const toggle = document.createElement('button');
                toggle.className = 'pill';
                toggle.type = 'button';
                toggle.style.marginLeft = '8px';
                toggle.textContent = 'ğŸ”‡';
                let playing = false;
                toggle.addEventListener('click', async ()=>{
                    try{
                        if (!playing){
                            await audio.play();
                            toggle.textContent = 'ğŸµ';
                        }else{
                            audio.pause();
                            toggle.textContent = 'ğŸ”‡';
                        }
                        playing = !playing;
                    }catch(err){
                        secretManager.showToast(CONFIG.messages.autoplayBlocked, 'info');
                    }
                });
                navInner.appendChild(toggle);
            }catch(err){
                console.log('BGM åˆå§‹åŒ–å¤±è´¥ï¼š', err);
            }
        }
        setupBackgroundMusic();

        // 3) Section æ»šåŠ¨å‡ºç°åŠ¨ç”»ï¼ˆå°Šé‡â€œå‡å°‘åŠ¨æ•ˆâ€åå¥½ï¼‰
        (function setupSectionReveal(){
            if (!('IntersectionObserver' in window)) return;
            const sections = document.querySelectorAll('.section');
            sections.forEach(sec => sec.classList.add('reveal-pending'));
            const io = new IntersectionObserver((entries)=>{
                entries.forEach(en=>{
                    if (en.isIntersecting){
                        en.target.classList.remove('reveal-pending');
                        en.target.classList.add('in-view');
                        io.unobserve(en.target);
                    }
                })
            }, { threshold: 0.12 });
            sections.forEach(sec => io.observe(sec));
        })();

    // 4) Service Worker æ³¨å†Œï¼ˆç‹¬ç«‹æ–‡ä»¶ sw.jsï¼‰+ å®‰å…¨ä¸Šä¸‹æ–‡åˆ¤æ–­
    // è¯´æ˜ï¼š
    //  - ä»…åœ¨ HTTPS / localhost / 127.0.0.1 ä¸‹æ³¨å†Œï¼›
    //  - è‹¥ä½¿ç”¨ file:// ç›´æ¥æ‰“å¼€ï¼Œå°†è‡ªåŠ¨è·³è¿‡ï¼ˆæ§åˆ¶å°æœ‰æç¤ºï¼‰ï¼›
    //  - æƒ³ä¸´æ—¶ç¦ç”¨ SWï¼Œå¯å°†æ•´ä¸ª if å—æ³¨é‡Šæ‰ï¼Œæˆ–æŠŠ isSecure è®¾ä¸º falseã€‚
        const isSecure = location.protocol === 'https:' || location.hostname === 'localhost' || location.hostname === '127.0.0.1';
        if ('serviceWorker' in navigator && isSecure) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js', { scope: './' })
                    .then(reg => console.log('ServiceWorker æ³¨å†ŒæˆåŠŸï¼š', reg.scope))
                    .catch(err => console.log('ServiceWorker æ³¨å†Œå¤±è´¥ï¼š', err));
            });
        } else {
            console.log('ç•¥è¿‡ Service Workerï¼ˆéœ€åœ¨ https æˆ– localhost ä¸‹è¿è¡Œï¼‰');
        }
        
        const yearEl = document.getElementById('year');
        if (yearEl) yearEl.textContent = new Date().getFullYear();

        // å¯è®¿é—®æ€§ï¼šEscå…³é—­æŸ¥çœ‹å™¨
        window.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                const lightbox = $('#lightbox');
                if (lightbox) lightbox.classList.remove('open');
            }
        });
        
        // é”™è¯¯å¤„ç†ï¼šå…¨å±€æ•è·
        window.addEventListener('error', (e) => {
            console.error('âŒ é”™è¯¯:', e.message, '@', e.filename, ':', e.lineno);
            if (secretManager) {
                secretManager.showToast(CONFIG.messages.genericIssue, 'info');
            }
        });
        
        window.addEventListener('unhandledrejection', (e) => {
            console.error('âŒ Promise æ‹’ç»:', e.reason);
        });
        
        // æ€§èƒ½æŠ¥å‘Š
        perf.mark('é¡µé¢åˆå§‹åŒ–å®Œæˆ');
        console.log('âœ¨ v3.1 æ‰€æœ‰ç³»ç»Ÿå°±ç»ªï¼ˆSecurity & Performance Enhancedï¼‰');
        console.log('ğŸ“Š æ€§èƒ½:', {
            è€—æ—¶: `${(performance.now() - perf.start).toFixed(2)}ms`,
            ç»•æ—¥: orbitsSince('2001-06-18'),
            ç…§ç‰‡: DATA.photos.length,
            äº‹ä»¶: DATA.timeline.length
        });
        
        // ç‰¹æ€§æ£€æµ‹
        if (navigator.share) console.log('âœ… Web Share');
        if ('serviceWorker' in navigator) console.log('âœ… Service Worker');

        </script>
        
        <!-- SEO: Structured Data -->
        <script type="application/ld+json">
        {
            "@context": "https://schema.org",
            "@type": "WebPage",
            "name": "å­èŒœçš„æ˜Ÿæ²³ç”Ÿæ—¥å±•",
            "description": "äº’åŠ¨ç”Ÿæ—¥ç½‘é¡µï¼šç›¸å†Œã€æ—¶é—´è½´ã€æ‹¼å›¾ã€çƒŸèŠ±",
            "inLanguage": "zh-CN"
        }
        </script>
    </body>
    </html>
