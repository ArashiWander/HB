<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>å­èŒœçš„æ˜Ÿæ²³ç”Ÿæ—¥å±• Â· Happy Orbit, Zixian</title>
    <meta name="description" content="ä¸ºå­èŒœå®šåˆ¶çš„ä¸€é¡µå¼ç”Ÿæ—¥ç½‘é¡µï¼šç›¸å†Œé“¶æ²³ã€æ—¶é—´è½´ã€æ‰­è›‹åˆ¸ã€é»˜å¥‘å°æµ‹ã€æ‹¼å›¾è§£é”ã€å¿ƒæ„¿æ°”çƒã€ç¥ç¦çƒŸèŠ±ã€å®‡å®™æ‰¿è¯ºä¹¦" />
    <meta name="theme-color" content="#0D1B2A" />
    
    <!-- Security: CSP -->
    <!--
    å®‰å…¨ç­–ç•¥ï¼ˆCSPï¼‰è¯´æ˜ï¼š
    - å¦‚éœ€æ’­æ”¾å¤–éƒ¨éŸ³é¢‘ï¼Œè¯·å°†å…¶åŸŸååŠ å…¥ media-srcï¼ˆå·²å…è®¸ https: ä¸ data:ï¼‰ã€‚
    - å¦‚éœ€é¢å¤–å›¾ç‰‡æˆ– API åŸŸï¼Œåˆ†åˆ«æ·»åŠ åˆ° img-src / connect-srcã€‚
    -->
    <meta http-equiv="Content-Security-Policy" 
        content="default-src 'self'; img-src 'self' https://images.unsplash.com data:; media-src 'self' https: data:; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline'; connect-src 'self'; base-uri 'self'; frame-ancestors 'none'">
    
    <!-- SEO: Open Graph -->
    <meta property="og:title" content="å­èŒœçš„æ˜Ÿæ²³ç”Ÿæ—¥å±• Â· Happy Orbit, Zixian" />
    <meta property="og:description" content="ç›¸å†Œé“¶æ²³ã€æ—¶é—´è½´ã€æ‰­è›‹ã€æ‹¼å›¾ã€çƒŸèŠ±â€¦ä¸“å±äº’åŠ¨ç”Ÿæ—¥ç½‘é¡µ" />
    <meta property="og:type" content="website" />
    <meta property="og:image" content="https://images.unsplash.com/photo-1529336953121-a0ce99a0f007?w=1200&h=630&fit=crop" />
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoi5a2Q6Iyc55qE5pif5rKz55Sf5pel5bGVIiwic2hvcnRfbmFtZSI6IuaYn+aymeeUn+aXpSIsInN0YXJ0X3VybCI6Ii8iLCJkaXNwbGF5Ijoic3RhbmRhbG9uZSIsInRoZW1lX2NvbG9yIjoiIzBEMUIyQSIsImJhY2tncm91bmRfY29sb3IiOiIjMEQxQjJBIn0=" />
    
    <link rel="preconnect" href="https://images.unsplash.com" crossorigin>
    <style>
        /* ===== è®¾è®¡ç³»ç»Ÿ ===== */
        :root{
            --bg-deep:#0D1B2A;      /* æš®é› */
            --bg-deeper:#08111d;
            --ink:#E6E6FA;          /* æ˜Ÿè¾‰ */
            --rose:#EFB8C8;         /* ç«ç‘°é‡‘ */
            --mint:#b7ffe1;
            --accent:#8ec5ff;
            --card:#12243b;
            --muted:#9aa7b2;
            --shadow:0 10px 30px rgba(0,0,0,.45);
            --radius:16px;
            --radius-lg:24px;
            --glass:rgba(255,255,255,0.06);
        }
        *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:radial-gradient(1000px 600px at 70% -10%,#12243b 0%,#0D1B2A 40%,#08111d 100%);color:var(--ink);font:16px/1.7 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;scroll-behavior:smooth}
        img{max-width:100%;display:block}
        a{color:var(--mint);text-decoration:none}
    h1,h2,h3{margin:0 0 .75rem 0; line-height:1.25}
    p{margin:.5rem 0 1rem}
    .container{width:min(1100px,92vw);margin:0 auto;padding:56px 0}
    .section{padding:64px 0;border-top:1px solid rgba(255,255,255,.06)}
        .card{background:linear-gradient(180deg,var(--glass),rgba(255,255,255,0.02));border:1px solid rgba(255,255,255,.08);backdrop-filter:blur(6px);-webkit-backdrop-filter:blur(6px);border-radius:var(--radius);box-shadow:var(--shadow)}
        .btn{appearance:none;border:none;border-radius:999px;background:linear-gradient(135deg,var(--rose),#ffd2df 60%,#fff1f6);color:#381a22;font-weight:700;padding:12px 20px;cursor:pointer;box-shadow:0 6px 18px rgba(239,184,200,.35);transition:transform .15s ease, box-shadow .15s ease}
        .btn:hover{transform:translateY(-1px);box-shadow:0 10px 24px rgba(239,184,200,.5)}
        .btn.ghost{background:transparent;color:var(--ink);border:1px solid rgba(255,255,255,.16);box-shadow:none}
        .btn:focus-visible,.tag:focus-visible,.face[role="button"]:focus-visible{outline:2px solid var(--rose);outline-offset:2px}
        .muted{color:var(--muted)}
        .pill{display:inline-flex;align-items:center;gap:.4rem;padding:.35rem .7rem;border-radius:999px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.1);font-size:.85rem}
        .grid{display:grid;gap:16px}
        @media(min-width:800px){.grid.cols-3{grid-template-columns:repeat(3,1fr)}.grid.cols-4{grid-template-columns:repeat(4,1fr)}}

        /* é¦–é€‰å‡å°‘åŠ¨æ•ˆ */
        @media (prefers-reduced-motion: reduce){
            html,body{scroll-behavior:auto}
            *{animation:none!important;transition:none!important}
        }

        /* ===== é¡¶éƒ¨å¯¼èˆª ===== */
        .nav{position:sticky;top:0;z-index:40;background:linear-gradient(180deg,rgba(8,17,29,.9),rgba(8,17,29,.6) 80%,transparent);backdrop-filter:blur(6px);border-bottom:1px solid rgba(255,255,255,.06)}
        .nav-inner{width:min(1024px,92vw);margin:0 auto;display:flex;align-items:center;justify-content:space-between;padding:10px 0}
        .nav a{padding:8px 10px;border-radius:8px;color:var(--ink)}
        .nav a:hover{background:rgba(255,255,255,.06)}

        /* ===== Hero æ˜Ÿæ²³èˆå° ===== */
        #hero{position:relative;min-height:84vh;display:grid;place-items:center}
        #starfield{position:fixed;inset:0;z-index:-1}
        .hero-content{position:relative;z-index:1;display:flex;flex-direction:column;align-items:center;text-align:center;gap:16px;padding:20px}
        .title{font-size:clamp(28px,6vw,56px);letter-spacing:.02em}
        .typing{min-height:1.8em;border-right:2px solid var(--rose);white-space:nowrap;overflow:hidden}
        .hero-actions{display:flex;gap:10px;flex-wrap:wrap;justify-content:center}

        .gate{display:flex;gap:8px;align-items:center;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);border-radius:999px;padding:6px 8px}
        .gate input{all:unset;padding:6px 10px;min-width:12ch}

        /* ===== ç›¸å†Œé“¶æ²³ ===== */
        /* Masonry åˆ—ä¿æŒä¸å˜ */
        .gallery{columns:2 260px;column-gap:14px}

        /* å…³é”®ï¼šç»™ figure ä¸€ä¸ªå›ºæœ‰é«˜åº¦å ä½ï¼Œé˜²æ­¢å›¾ç‰‡å¤±è´¥æ—¶é«˜åº¦ä¸º 0 */
        .photo{
          break-inside:avoid;
          position:relative;
          margin:0 0 14px 0;
          border-radius:14px;
          overflow:hidden;
          border:1px solid rgba(255,255,255,.08);
          aspect-ratio: 4 / 3;           /* âœ… å ä½é«˜åº¦ï¼Œç°ä»£æµè§ˆå™¨ */
          background:rgba(255,255,255,.02);
          /* å…¼å®¹éå¸¸è€çš„æµè§ˆå™¨å¯åŠ ï¼šmin-height: 180px; */
        }

        /* è®©å›¾ç‰‡é“ºæ»¡å®¹å™¨ï¼›å³ä½¿åŠ è½½å¤±è´¥ä¹Ÿä¸æ’‘é«˜å¸ƒå±€ */
        .photo img{
          position:absolute;
          inset:0;
          width:100%;
          height:100%;
          object-fit:cover;
          opacity:1;
          transition:opacity .4s ease;
        }

        /* å­—å¹•æ­£å¸¸å¤šè¡Œæ¢è¡Œï¼Œä¸è¢«è£åˆ‡ */
        .photo figcaption{
          position:absolute;
          left:0; right:0; bottom:0;
          background:linear-gradient(0deg,rgba(0,0,0,.75),transparent);
          padding:12px 12px;
          font-size:.9rem;
          text-align:center;
          line-height:1.4;
          white-space:normal;           /* é˜²æ­¢é•¿è‹±æ–‡ä¸æ¢è¡Œ */
          word-break:break-word;
        }
    .tags{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0}
    .tag{cursor:pointer;appearance:none;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.06);color:var(--ink);padding:.35rem .7rem;border-radius:999px}
    .tag[aria-pressed="true"]{background:rgba(239,184,200,.15);border-color:rgba(239,184,200,.5)}

        /* å›¾ç‰‡æŸ¥çœ‹å™¨ */
        .lightbox{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;place-items:center;z-index:50}
        .lightbox.open{display:grid}
        .lightbox .viewer{width:min(960px,92vw);max-height:86vh;display:grid;gap:10px}
        .lightbox img{max-height:70vh;margin:auto;border-radius:12px}

        /* ===== æ—¶é—´è½´ ===== */
        .timeline{overflow:auto hidden;padding:10px}
        .lane{display:flex;gap:16px;min-height:200px}
        .tcard{min-width:240px;perspective:1000px}
        .face{position:relative;height:180px;border-radius:14px;padding:14px;transform-style:preserve-3d;transition:transform .5s;border:1px solid rgba(255,255,255,.1);background:linear-gradient(180deg,var(--glass),rgba(255,255,255,.02))}
        .face.flip{transform:rotateY(180deg)}
        .front,.back{position:absolute;inset:0;padding:14px;backface-visibility:hidden}
        .back{transform:rotateY(180deg)}

        /* ===== æ‰­è›‹æœº ===== */
        .gacha{display:grid;gap:14px}
        .coupon{display:grid;gap:10px;padding:14px;border-radius:14px;border:1px dashed rgba(255,255,255,.3);background:linear-gradient(135deg,rgba(239,184,200,.12),rgba(255,255,255,.04))}

        /* ===== å°æµ‹éªŒ ===== */
        .quiz{display:grid;gap:14px}
        .q{padding:14px;border-radius:12px;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08)}

        /* ===== æ‹¼å›¾ ===== */
        .puzzle{width:min(360px,92vw);height:min(360px,92vw);position:relative;border-radius:12px;overflow:hidden;border:1px solid rgba(255,255,255,.1)}
        .tile{position:absolute;width:33.3333%;height:33.3333%;background-size:300% 300%;border:1px solid rgba(255,255,255,.05);cursor:pointer;transition:box-shadow .15s}
        .tile:active{box-shadow:0 0 0 2px rgba(255,255,255,.2) inset}

    /* ===== å…¨å±€åŠ¨æ•ˆè¦†ç›–å±‚ ===== */
    .fx-overlay{position:fixed;inset:0;pointer-events:none;z-index:20;overflow:hidden}
    #fxFireworks{position:absolute;inset:0}
    #fxBarrage{position:absolute;left:0;right:0;overflow:hidden;top:80px;bottom:auto;height:calc(100vh - 200px)}
        
        /* æ°”çƒè®¾è®¡ - çœŸæ­£çš„æ°”çƒå½¢çŠ¶ */
        .balloon{
            position:absolute;
            bottom:20px; /* ä»å®¹å™¨åº•éƒ¨å¼€å§‹ï¼Œå¯è§ */
            display:flex;
            flex-direction:column;
            align-items:center;
            cursor:pointer;
            transition:transform .2s ease;
        }
        .balloon:hover{transform:scale(1.05)}
        
        /* æ°”çƒä¸»ä½“ - åœ†å½¢ï¼Œåº•éƒ¨ç¨å°– */
        .balloon .b{
            width:50px;
            height:65px;
            background:linear-gradient(135deg, var(--balloon-color, #ff6b9d) 0%, var(--balloon-dark, #c9184a) 100%);
            border-radius:50% 50% 50% 50% / 60% 60% 40% 40%;
            position:relative;
            box-shadow:
                inset -10px -10px 20px rgba(0,0,0,.2),
                inset 10px 10px 20px rgba(255,255,255,.3),
                0 10px 30px rgba(0,0,0,.3);
        }
        /* é«˜å…‰æ•ˆæœ */
        .balloon .b::before{
            content:'';
            position:absolute;
            top:8px;
            left:12px;
            width:20px;
            height:25px;
            background:radial-gradient(ellipse at center, rgba(255,255,255,.6) 0%, transparent 60%);
            border-radius:50%;
        }
        /* æ°”çƒåº•éƒ¨å°ç»“ */
        .balloon .b::after{
            content:'';
            position:absolute;
            bottom:-5px;
            left:50%;
            transform:translateX(-50%);
            width:6px;
            height:8px;
            background:linear-gradient(180deg, var(--balloon-dark, #c9184a), #8b0000);
            border-radius:0 0 50% 50%;
        }
        
        /* ç»³å­ */
        .balloon .s{
            width:1.5px;
            height:60px;
            background:linear-gradient(180deg, rgba(255,255,255,.4), rgba(255,255,255,.6));
            margin-top:2px;
        }
        
        /* ç¥ç¦æ–‡å­— */
        .balloon small{
            margin-top:8px;
            max-width:120px;
            text-align:center;
            color:var(--ink);
            font-size:.9rem;
            text-shadow:0 2px 4px rgba(0,0,0,.3);
            line-height:1.3;
        }
        
        /* æ°”çƒä¸Šå‡åŠ¨ç”» - åŒ…å«æ‰€æœ‰å˜æ¢ */
        @keyframes floatUp{
            0%{
                transform:translateY(0) translateX(0) rotate(0deg);
                opacity:1;
            }
            25%{
                transform:translateY(-105px) translateX(calc(var(--drift, 0px) * 0.25)) rotate(calc(var(--rotate, 5deg) * 0.5));
            }
            50%{
                transform:translateY(-210px) translateX(calc(var(--drift, 0px) * 0.5)) rotate(var(--rotate, 5deg));
                opacity:1;
            }
            75%{
                transform:translateY(-315px) translateX(calc(var(--drift, 0px) * 0.75)) rotate(calc(var(--rotate, 5deg) * 0.5));
                opacity:0.7;
            }
            100%{
                transform:translateY(-420px) translateX(var(--drift, 0px)) rotate(0deg);
                opacity:0;
            }
        }
        
    .barrage{position:absolute;left:0;top:0;right:0;bottom:0;pointer-events:none;overflow:hidden}
    .msg{position:absolute;background:rgba(0,0,0,.7);color:#fff;padding:12px 20px;border-radius:999px;font-size:1rem;line-height:1.5;border:1px solid rgba(255,255,255,.2);white-space:nowrap;box-shadow:0 4px 12px rgba(0,0,0,.3)}

        /* ===== æ‰¿è¯ºä¹¦ ===== */
        .promise{display:grid;gap:14px}
        .poster{border:1px solid rgba(255,255,255,.08);border-radius:14px;overflow:hidden}
        .sig{border:1px dashed rgba(255,255,255,.25);border-radius:8px;height:120px;background:rgba(255,255,255,.02)}

        /* è¾…åŠ© */
        .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
        .right{margin-left:auto}
        .center{text-align:center}
        .hidden{display:none!important}
        
        /* Resize Guard: åœ¨é¢‘ç¹ç¼©æ”¾/è°ƒæ•´çª—å£æ—¶ï¼Œæš‚æ—¶å…³é—­è¿‡æ¸¡ä¸åŠ¨ç”»ï¼Œé¿å… GPU/å†…å­˜æŠ–åŠ¨ */
        html.resizing *, html.resizing .section.in-view{
            transition:none!important; animation:none!important;
        }
        
        /* é€šçŸ¥åŠ¨ç”» */
        @keyframes slideIn{
            from{transform:translateX(120%);opacity:0}
            to{transform:translateX(0);opacity:1}
        }
        @keyframes slideOut{
            from{transform:translateX(0);opacity:1}
            to{transform:translateX(120%);opacity:0}
        }
        
        /* å›¾ç‰‡æ·¡å…¥ */
        @keyframes fadeIn{
            from{opacity:0}
            to{opacity:1}
        }
        
        /* åŠ è½½æŒ‡ç¤ºå™¨ */
        .loading{
            display:inline-block;
            width:20px;
            height:20px;
            border:3px solid rgba(255,255,255,.3);
            border-radius:50%;
            border-top-color:var(--rose);
            animation:spin 1s ease-in-out infinite;
        }
        @keyframes spin{
            to{transform:rotate(360deg)}
        }
        
        /* Performance: content-visibility for off-screen sections */
        .section{
            content-visibility:auto;
            contain-intrinsic-size:1000px 800px;
        }
        /*
         * æ»šåŠ¨å‡ºç°åŠ¨ç”»ï¼ˆIntersectionObserver é…åˆï¼‰ï¼š
         * - ç»™ section æ·»åŠ  .reveal-pending ä»¥é¿å…é¦–å±é—ªçƒï¼›
         * - å½“è¿›å…¥è§†å£æ—¶ç§»é™¤ pending å¹¶åŠ  .in-view è§¦å‘åŠ¨ç”»ã€‚
         * - è‹¥ç”¨æˆ·åå¥½å‡å°‘åŠ¨æ•ˆï¼ˆprefers-reduced-motionï¼‰ï¼ŒJS å°†ä¸å¯ç”¨åŠ¨ç”»ã€‚
         */
        @keyframes fadeSlideUp{from{opacity:0;transform:translateY(16px)}to{opacity:1;transform:translateY(0)}}
        .section.reveal-pending{opacity:0}
        .section.in-view{animation:fadeSlideUp .6s ease-out both}
        
        /* Skip link for accessibility */
        .skip-link{
            position:absolute;
            top:-40px;
            left:0;
            background:var(--rose);
            color:#0D1B2A;
            padding:8px;
            text-decoration:none;
            z-index:100;
        }
        .skip-link:focus{
            top:0;
        }
        
        /* Status/toast container */
        #toast-container{
            position:fixed;
            top:20px;
            right:20px;
            z-index:10000;
            display:flex;
            flex-direction:column;
            gap:10px;
        }
        /* ç§»åŠ¨åŠ¨ç”»çš„æ€§èƒ½æš—ç¤º */
        .balloon{will-change:transform}
        .tile{will-change:left, top}
        
        /* ===== ç”œèœœå¯çˆ±ä¸»é¢˜ ===== */
        body.theme-sweet {
            --bg-deep:#201128;
            --bg-deeper:#170c1f;
            --ink:#FFF6FB;
            --rose:#FFB7D5;
            --mint:#C1FFE7;
            --accent:#A8C8FF;
            --card:#281536;
            --muted:#D6CFE2;
            --glass:rgba(255,255,255,0.08);
        }
        body.theme-sweet .btn{
            background:linear-gradient(135deg,#FFB7D5,#FFE4EF 60%,#FFF8FB);
            color:#5b2236; 
            box-shadow:0 8px 20px rgba(255,183,213,.35);
        }
        body.theme-sweet .pill{
            background:rgba(255,255,255,.10);
            border-color:rgba(255,255,255,.18);
        }
        body.theme-sweet .card{
            box-shadow:0 12px 36px rgba(0,0,0,.45);
        }

        /* ===== æ›´å¥½çœ‹çš„æ°”çƒ ===== */
        .balloon{ 
            filter:drop-shadow(0 10px 18px rgba(0,0,0,.35)); 
        }
        .balloon .b{
            width:56px;
            height:74px; 
            position:relative;
            background:linear-gradient(145deg, var(--balloon-color,#ff6b9d), var(--balloon-dark,#c9184a));
            border-radius:52% 52% 50% 50% / 62% 62% 42% 42%;
            box-shadow:
                inset -14px -16px 24px rgba(0,0,0,.25),
                inset 10px 12px 24px rgba(255,255,255,.28);
        }
        .balloon .b::before{ /* è½¯é«˜å…‰æ–‘ */
            content:""; 
            position:absolute; 
            top:10px; 
            left:12px; 
            width:24px; 
            height:30px;
            background:radial-gradient(circle at 35% 35%, rgba(255,255,255,.75), rgba(255,255,255,.0) 60%);
            border-radius:50%;
        }
        .balloon .b::after{ /* åº•éƒ¨ç³»ç»“ */
            content:""; 
            position:absolute; 
            bottom:-6px; 
            left:50%; 
            transform:translateX(-50%);
            width:8px;
            height:10px;
            border-radius:0 0 60% 60%;
            background:linear-gradient(180deg, var(--balloon-dark,#c9184a), #6b0f2a);
            box-shadow:0 2px 4px rgba(0,0,0,.3) inset;
        }
        
        /* å¿ƒå½¢å˜ä½“ */
        .balloon.heart .b{
            width:64px;
            height:60px;
            background:transparent;
            box-shadow:none;
        }
        .balloon.heart .b > i{
            position:absolute; 
            left:50%; 
            top:28px; 
            width:34px; 
            height:34px;
            transform:translateX(-50%) rotate(45deg);
            background:linear-gradient(145deg, var(--balloon-color,#ff6b9d), var(--balloon-dark,#c9184a));
            border-radius:0 0 8px 0;
            box-shadow:
                inset -8px -8px 16px rgba(0,0,0,.22), 
                inset 8px 8px 16px rgba(255,255,255,.22);
        }
        .balloon.heart .b::before{
            content:""; 
            position:absolute; 
            width:32px; 
            height:32px; 
            border-radius:50%;
            background:linear-gradient(145deg, var(--balloon-color,#ff6b9d), var(--balloon-dark,#c9184a));
            box-shadow:
                inset -8px -8px 16px rgba(0,0,0,.22), 
                inset 8px 8px 16px rgba(255,255,255,.22);
            left:6px; 
            top:4px;
        }
        .balloon.heart .b::after{
            content:""; 
            position:absolute; 
            width:32px; 
            height:32px; 
            border-radius:50%;
            background:linear-gradient(145deg, var(--balloon-color,#ff6b9d), var(--balloon-dark,#c9184a));
            box-shadow:
                inset -8px -8px 16px rgba(0,0,0,.22), 
                inset 8px 8px 16px rgba(255,255,255,.22);
            right:6px; 
            top:4px;
            transform:none;
        }

        /* ç»³å­è½»å¾®å¼¯æ›²ï¼ˆç”¨æ¸å˜æ¨¡æ‹Ÿï¼‰ */
        .balloon .s{
            width:1.5px; 
            height:66px; 
            margin-top:3px;
            background:linear-gradient(180deg, rgba(255,255,255,.5), rgba(255,255,255,.8));
        }
        
        /* æ‹¼å›¾å¹½çµåº•å›¾æ”¯æŒ */
        .puzzle.ghost{ 
            background-position:center; 
            background-size:100% 100%; 
            background-repeat:no-repeat;
            opacity: 0.3;
        }
        .puzzle.ghost .tile{
            opacity: 0.85;
        }
        .puzzle .tile{ 
            transition: transform .15s ease; 
        }
    </style>
</head>
<body>
    <!-- å…¨å±€èƒŒæ™¯ï¼šæ˜Ÿç©º -->
    <canvas id="starfield" aria-hidden="true"></canvas>

    <!-- Skip link for accessibility -->
    <a href="#main" class="skip-link">è·³åˆ°ä¸»å†…å®¹</a>
    
    <!-- Toast container for notifications -->
    <div id="toast-container" role="status" aria-live="polite" aria-atomic="true"></div>
    
    <!-- é¡¶éƒ¨å¯¼èˆª -->
    <div class="nav" role="navigation" aria-label="ä¸»å¯¼èˆª">
        <div class="nav-inner">
            <div class="pill">ğŸŒŒ å­èŒœçš„æ˜Ÿæ²³ç”Ÿæ—¥å±•</div>
            <nav class="row" aria-label="ç« èŠ‚">
                <a id="navPhotos" href="#photos">ç›¸å†Œ</a>
                <a id="navTimeline" href="#timeline">æ—¶é—´è½´</a>
                <a id="navGacha" href="#gacha">æ‰­è›‹</a>
                <a id="navQuiz" href="#quiz">å°æµ‹</a>
                <a id="navPuzzle" href="#puzzle">æ‹¼å›¾</a>
                <a id="navPromise" href="#promise">æ‰¿è¯ºä¹¦</a>
            </nav>
        </div>
    </div>

    <!-- Hero èˆå° -->
    <section id="hero" class="container">
        <div class="hero-content">
            <div class="pill">ç¬¬ <span id="revolutions">â€”</span> æ¬¡ç»•æ—¥æ—…è¡Œ</div>
            <h1 class="title">Happy Orbit, <span style="color:var(--rose)">Zixian</span> âœ¨</h1>
            <div id="typing" class="typing" aria-live="polite"></div>
            <div class="hero-actions">
                <span class="gate" role="group" aria-label="å¯†è¯­è§£é”">
                    <input id="key" placeholder="è¾“å…¥å¯†è¯­ï¼ˆå¦‚ç”Ÿæ—¥ï¼š2001-06-18ï¼‰" aria-label="å¯†è¯­" autocomplete="off" />
                    <button class="btn ghost" id="unlock" type="button">è§£é”</button>
                </span>
                <button class="btn" id="goPhotos" type="button">å¼€å§‹é€›å±•</button>
            </div>
            <p id="heroTip" class="muted">å°å½©è›‹æç¤ºï¼šå¿«é€Ÿè¿ç‚¹ Z I X I A N å¯è§£é”éšè—ç›¸å†Œ</p>
        </div>
    </section>

    <!-- ç›¸å†Œé“¶æ²³ -->
    <main id="main">
    <section id="photos" class="section" role="main">
        <div class="container">
            <h2 id="photosTitle">ğŸ“· ç›¸å†Œé“¶æ²³</h2>
            <p id="photosSub" class="muted">æ¯ä¸€å¼ ç…§ç‰‡éƒ½æ˜¯æ˜Ÿåº§çš„ä¸€é¢—æ˜Ÿã€‚</p>
            <div class="tags" id="filters"></div>
            <div class="gallery" id="gallery" aria-live="polite"></div>
        </div>
    </section>

    <!-- æŸ¥çœ‹å™¨ -->
    <div class="lightbox" id="lightbox" role="dialog" aria-modal="true" aria-label="ç…§ç‰‡æŸ¥çœ‹å™¨">
        <div class="viewer card">
            <img id="big" alt="æ”¾å¤§ç…§ç‰‡" />
            <div class="row" style="justify-content:space-between;padding:8px 12px">
                <div id="bigcap" class="muted"></div>
                <div class="row">
                    <button class="btn ghost" id="prevLight" type="button" aria-label="ä¸Šä¸€å¼ ">ä¸Šä¸€å¼ </button>
                    <button class="btn ghost" id="nextLight" type="button" aria-label="ä¸‹ä¸€å¼ ">ä¸‹ä¸€å¼ </button>
                    <button class="btn ghost" id="closeLight" type="button">å…³é—­</button>
                </div>
            </div>
        </div>
    </div>

    <!-- æ—¶é—´è½´ -->
    <section id="timeline" class="section">
        <div class="container">
            <h2 id="timelineTitle">ğŸ—ºï¸ æˆ‘ä»¬çš„æ—¶é—´è½´</h2>
            <div class="timeline card">
                <div class="lane" id="lane"></div>
            </div>
            <p id="timelineTip" class="muted">ç‚¹å‡»å¡ç‰‡ç¿»é¢ï¼ŒæŸ¥çœ‹â€œé‚£å¤©æˆ‘æƒ³è¯´çš„è¯â€ã€‚</p>
        </div>
    </section>

    <!-- æ‰­è›‹æœº -->
    <section id="gacha" class="section">
        <div class="container">
            <h2 id="gachaTitle">ğŸ å¿ƒæ„¿æ‰­è›‹æœº</h2>
            <div class="gacha">
                <div class="row">
                    <button class="btn" id="roll" type="button">æ‰­ä¸€ä¸ª</button>
                    <button class="btn ghost" id="saveCoupon" type="button" disabled>ä¸‹è½½åˆ¸PNG</button>
                </div>
                <div class="coupon" id="coupon" aria-live="polite"></div>
            </div>
        </div>
    </section>

    <!-- é»˜å¥‘å°æµ‹ -->
    <section id="quiz" class="section">
        <div class="container">
            <h2 id="quizTitle">ğŸ’ é»˜å¥‘å°æµ‹</h2>
            <form class="quiz" id="quizForm"></form>
            <div class="row">
                <button class="btn" id="submitQuiz" type="button">ç”Ÿæˆé»˜å¥‘å€¼</button>
                <div class="pill" id="scoreLabelPill">é»˜å¥‘å€¼ï¼š<span id="score">â€”</span></div>
                <button class="btn ghost" id="saveBadge" type="button" disabled>ä¸‹è½½å¾½ç« PNG</button>
            </div>
            <canvas id="badgeCanvas" width="600" height="320" class="poster hidden" aria-hidden="true"></canvas>
        </div>
    </section>

    <!-- æ‹¼å›¾è§£é” -->
    <section id="puzzle" class="section">
        <div class="container">
            <h2 id="puzzleTitle">ğŸ§© å°æ‹¼å›¾ Â· è§£é”ç”Ÿæ—¥æƒŠå–œ</h2>
            <p id="puzzleTip" class="muted">å°†ç¢ç‰‡ç§»åŠ¨åˆ°æ­£ç¡®ä½ç½®ã€‚å®Œæˆåè‡ªåŠ¨è§£é”æƒŠå–œéŸ³é¢‘ã€‚</p>
            <div class="row" style="align-items:flex-start">
                <div class="puzzle card" id="puzzleStage" aria-label="3x3æ»‘å—æ‹¼å›¾" role="application"></div>
                <div class="card" style="padding:14px;min-width:260px">
                    <div class="row"><button class="btn" id="shuffle" type="button">é‡æ–°æ‰“ä¹±</button><button class="btn ghost" id="reveal" type="button">çœ‹åŸå›¾</button></div>
                    <audio id="surprise" class="row" controls src="" preload="none"></audio>
                    <p class="muted">å®Œæˆæç¤ºä¼šå‡ºç°ï¼ŒéŸ³é¢‘å³è§£é”æ’­æ”¾ã€‚</p>
                </div>
            </div>
        </div>
    </section>

    <!-- å…¨å±€åŠ¨æ•ˆè¦†ç›–å±‚ï¼ˆè‡ªåŠ¨å¼¹å¹• + æ°”çƒï¼‰ï¼Œä¸å æ®å¸ƒå±€ï¼Œpointer-events:none -->
    <div id="fxOverlay" class="fx-overlay" aria-hidden="true">
        <canvas id="fxFireworks"></canvas>
        <div class="barrage" id="fxBarrage"></div>
    </div>

    <!-- æ‰¿è¯ºä¹¦ & çºªå¿µå¡ -->
    <section id="promise" class="section">
        <div class="container">
            <h2 id="promiseTitle">ğŸ“œ å®‡å®™æ‰¿è¯ºä¹¦</h2>
            <div class="promise">
                <textarea id="pledge" class="card" rows="6" style="padding:14px;color:var(--ink);background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:12px">äº²çˆ±çš„å­èŒœï¼š\n\næ„¿åšä½ æ¼«é•¿èˆªç¨‹é‡Œçš„è€å¿ƒå…‰æºã€‚æœªæ¥çš„æ¯ä¸€ä¸ªå¹³å‡¡æ—¥å­ï¼Œæˆ‘è´Ÿè´£æŠŠå®ƒä»¬ç‚¹äº®ã€‚\n\nè¯·ç»§ç»­åšæˆ‘çš„åŒ—ææ˜Ÿã€‚\n\nç½²åï¼š___\næ—¥æœŸï¼š___</textarea>
                <label class="muted" id="sigLabel">åœ¨ä¸‹æ–¹æ‰‹å†™ç­¾å</label>
                <canvas id="sig" class="sig" aria-label="ç­¾å"></canvas>
                <div class="row">
                    <button class="btn" id="savePoster" type="button">ç”Ÿæˆçºªå¿µå¡PNG</button>
                    <button class="btn ghost" id="clearSig" type="button">æ¸…ç©ºç­¾å</button>
                </div>
                <canvas id="poster" width="900" height="1400" class="poster" aria-label="çºªå¿µå¡é¢„è§ˆ"></canvas>
            </div>
        </div>
    </section>

    <footer class="section">
        <div class="container center muted">Â© <span id="year"></span> For Zixian, with stardust. ç¥ä½ ç”Ÿæ—¥å¿«ä¹ã€‚</div>
    </footer>
    </main>

    <script>
    // ===== v3.2 - Config-driven & Global Effects =====
    'use strict';
    
    console.log('ğŸˆ Happy Birthday Script v3.0 - Professional Edition');
    
    /*
     * ===== ç»Ÿä¸€é…ç½®ï¼ˆå¼€å‘è€…åªéœ€æ”¹è¿™é‡Œï¼‰ =====
     * ç”¨é€”ï¼šé›†ä¸­ç®¡ç†ç½‘ç«™æ‰€æœ‰å¯è§æ–‡æ¡ˆ/å‚æ•°ï¼ˆæ ‡é¢˜ã€æŒ‰é’®ã€æç¤ºã€é¢˜åº“ã€åŠ¨æ•ˆç­‰ï¼‰ã€‚
     * ç”Ÿæ•ˆï¼šä¿å­˜å¹¶åˆ·æ–°å³å¯ï¼ˆçº¯é™æ€ï¼Œæ— æ„å»ºæ­¥éª¤ï¼‰ã€‚
     * å®‰å…¨ï¼šç”¨æˆ·è¾“å…¥éƒ½æœ‰ sanitizeï¼›æœ¬é…ç½®ä¸ºé™æ€æ–‡æœ¬ï¼Œå°†æŒ‰åŸæ ·æ¸²æŸ“ã€‚
     * ä½ç½®æ˜ å°„ï¼šæ¯ä¸ªå­—æ®µä¸‹æ–¹é™„æ³¨äº†â€œå‡ºç°ä½ç½®/æ³¨æ„äº‹é¡¹â€ï¼Œä¾¿äºå¿«é€Ÿå®šä½ä¿®æ”¹ã€‚
     */
    const CONFIG = {
        site: {
            // å‡ºç°ä½ç½®ï¼š<title> / og:title / å¯¼èˆªå“ç‰Œ Pill
            title: 'å­èŒœçš„æ˜Ÿæ²³ç”Ÿæ—¥å±• Â· Happy Orbit, Zixian',
            // å‡ºç°ä½ç½®ï¼š<meta name="description"> / og:descriptionï¼ˆç”¨äºåˆ†äº«å¡ç‰‡ï¼‰
            description: 'ä¸ºå­èŒœå®šåˆ¶çš„ä¸€é¡µå¼ç”Ÿæ—¥ç½‘é¡µï¼šç›¸å†Œé“¶æ²³ã€æ—¶é—´è½´ã€æ‰­è›‹åˆ¸ã€é»˜å¥‘å°æµ‹ã€æ‹¼å›¾è§£é”ã€å¼¹å¹•æ°”çƒã€ç­¾åçºªå¿µå¡',
            // å‡ºç°ä½ç½®ï¼šå¯¼èˆªæ å·¦ä¾§å“ç‰Œ
            brand: 'ğŸŒŒ å­èŒœçš„æ˜Ÿæ²³ç”Ÿæ—¥å±•',
            // å‡ºç°ä½ç½®ï¼šog:imageï¼ˆå»ºè®® 1200Ã—630ï¼‰ï¼Œç¤¾äº¤å¹³å°åˆ†äº«é¢„è§ˆå›¾
            ogImage: 'https://images.unsplash.com/photo-1529336953121-a0ce99a0f007?w=1200&h=630&fit=crop',
            // å‡ºç°ä½ç½®ï¼š<meta name="theme-color">ï¼Œå½±å“æµè§ˆå™¨åœ°å€æ /å®‰å“ä»»åŠ¡æ é…è‰²
            themeColor: '#0D1B2A'
        },
        nav: {
            // å‡ºç°ä½ç½®ï¼šé¡¶éƒ¨å¯¼èˆªï¼›å¯¹åº”é”šç‚¹ #photos/#timeline/#gacha/#quiz/#puzzle/#promise
            photos: 'ç›¸å†Œ', timeline: 'æ—¶é—´è½´', gacha: 'æ‰­è›‹', quiz: 'å°æµ‹', puzzle: 'æ‹¼å›¾', promise: 'æ‰¿è¯ºä¹¦'
        },
        hero: {
            // å‡ºç°ä½ç½®ï¼šé¦–é¡µä¸»æ ‡é¢˜ï¼ˆæ”¯æŒå°‘é‡å†…è”æ ·å¼/Emojiï¼‰
            titleHTML: 'Happy Orbit, <span style="color:var(--rose)">Zixian</span> âœ¨',
            // å‡ºç°ä½ç½®ï¼šä¸»æ ‡é¢˜ä¸‹çš„æ‰“å­—æœºå­—å¹•ï¼ˆå¾ªç¯æ˜¾ç¤ºï¼‰ï¼›å¯ç”¨ 'N' ä»£è¡¨æœ¬å¹´ä¸ 2001 çš„å·®å€¼
            lines: ['ä¸ä½ åŒè½¨çš„ç¬¬Næ¬¡ç»•æ—¥æ—…è¡Œã€‚','ä»Šæ™šï¼ŒæŠŠå›å¿†æ’æˆæ˜Ÿåº§ã€‚','ç¥ä½ ç”Ÿæ—¥å¿«ä¹ï¼Œå­èŒœã€‚'],
            // å‡ºç°ä½ç½®ï¼šå¯†è¯­è¾“å…¥æ¡†å ä½
            keyPlaceholder: 'è¾“å…¥å¯†è¯­ï¼ˆå¦‚ç”Ÿæ—¥ï¼š2001-06-18ï¼‰',
            // å‡ºç°ä½ç½®ï¼šå¯†è¯­è§£é”æŒ‰é’®
            unlock: 'è§£é”',
            // å‡ºç°ä½ç½®ï¼šå¼€å§‹é€›å±•æŒ‰é’®ï¼ˆæ»šåŠ¨åˆ°ç›¸å†Œï¼‰
            go: 'å¼€å§‹é€›å±•',
            // å‡ºç°ä½ç½®ï¼šHero åº•éƒ¨æç¤ºï¼ˆé”®ç›˜/è¿ç‚¹å½©è›‹ç­‰ï¼‰
            tip: 'å°å½©è›‹æç¤ºï¼šå¿«é€Ÿè¿ç‚¹ Z I X I A N å¯è§£é”éšè—ç›¸å†Œ'
        },
        sections: {
            // ç›¸å†Œæ¨¡å—ï¼šæ ‡é¢˜ + å‰¯æ–‡æ¡ˆï¼ˆæ¨¡å—é¡¶éƒ¨ï¼‰
            photos: { title: 'ğŸ“· ç›¸å†Œé“¶æ²³', sub: 'æ¯ä¸€å¼ ç…§ç‰‡éƒ½æ˜¯æ˜Ÿåº§çš„ä¸€é¢—æ˜Ÿã€‚' },
            // æ—¶é—´è½´æ¨¡å—ï¼šæ ‡é¢˜ + æç¤ºï¼ˆæç¤ºæ˜¾ç¤ºåœ¨å¡ç‰‡ä¸Šæ–¹ï¼‰
            timeline: { title: 'ğŸ—ºï¸ æˆ‘ä»¬çš„æ—¶é—´è½´', tip: 'ç‚¹å‡»å¡ç‰‡ç¿»é¢ï¼ŒæŸ¥çœ‹â€œé‚£å¤©æˆ‘æƒ³è¯´çš„è¯â€ã€‚' },
            // æ‰­è›‹æ¨¡å—ï¼šæ ‡é¢˜/æŒ‰é’® + åˆ¸å¡ç‰‡/PNG æ–‡æ¡ˆï¼ˆé¡µé¢å±•ç¤ºä¸ä¸‹è½½å›¾ç‰‡ä¸€è‡´ï¼‰
            gacha: { title: 'ğŸ å¿ƒæ„¿æ‰­è›‹æœº', roll: 'æ‰­ä¸€ä¸ª', save: 'ä¸‹è½½åˆ¸PNG',
                winBanner: 'ğŸŸï¸ æ­å–œæŠ½ä¸­', serialLabel: 'ç¼–å·', rules: 'ä½¿ç”¨è¯´æ˜ï¼šä»…é™æŒæœ‰äºº Â· æ°¸ä¸è¿‡æœŸ Â· å¯å åŠ æ‹¥æŠ±', brandEn: 'ZIXIAN BIRTHDAY COUPON'
            },
            // å°æµ‹æ¨¡å—ï¼šæ ‡é¢˜/æŒ‰é’®ï¼›scoreLabel ä¸ badgeFooter ä¹Ÿä½“ç°åœ¨ç”Ÿæˆçš„å¾½ç«  PNG é‡Œ
            quiz: { title: 'ğŸ’ é»˜å¥‘å°æµ‹', submit: 'ç”Ÿæˆé»˜å¥‘å€¼', scoreLabel: 'é»˜å¥‘å€¼', save: 'ä¸‹è½½å¾½ç« PNG', badgeFooter: 'Zixian & You' },
            // æ‹¼å›¾æ¨¡å—ï¼šæ ‡é¢˜/æç¤º/æŒ‰é’®ï¼ˆå®Œæˆåè‹¥è®¾ç½®äº† surpriseAudio åˆ™æ’­æ”¾ï¼‰
            puzzle: { title: 'ğŸ§© å°æ‹¼å›¾ Â· è§£é”ç”Ÿæ—¥æƒŠå–œ', tip: 'å°†ç¢ç‰‡ç§»åŠ¨åˆ°æ­£ç¡®ä½ç½®ã€‚å®Œæˆåè‡ªåŠ¨è§£é”æƒŠå–œéŸ³é¢‘ã€‚', shuffle: 'é‡æ–°æ‰“ä¹±', reveal: 'çœ‹åŸå›¾' },
            // æ‰¿è¯ºä¹¦æ¨¡å—ï¼šç­¾ååŒºæç¤º + æŒ‰é’®
            promise: { title: 'ğŸ“œ å®‡å®™æ‰¿è¯ºä¹¦', sigLabel: 'åœ¨ä¸‹æ–¹æ‰‹å†™ç­¾å', save: 'ç”Ÿæˆçºªå¿µå¡PNG', clear: 'æ¸…ç©ºç­¾å' },
            // é¡µè„šï¼šæ”¯æŒ {year} å ä½ç¬¦
            footer: 'Â© {year} For Zixian, with stardust. ç¥ä½ ç”Ÿæ—¥å¿«ä¹ã€‚'
        },
        // Toast æç¤ºé›†åˆï¼šæ‰€æœ‰å¼¹å‡ºçš„æ“ä½œç»“æœ/é”™è¯¯æé†’éƒ½ä»è¿™é‡Œå–
        messages: {
            unlockSuccess: 'è§£é”æˆåŠŸï¼šå·²åŠ å…¥éšè—ç›¸å†Œ âœ¨',
            unlockFail: 'å¯†è¯­ä¸å¯¹ï¼Œä½†æ˜Ÿæ˜Ÿä¸ä¼šè®°ä»‡~ ğŸ’«',
            easterEgg: 'å½©è›‹è§£é”ï¼šæœªå…¬å¼€çš„å‚»ç…§å·²åŠ å…¥~ ğŸ‰',
            autoplayBlocked: 'è‡ªåŠ¨æ’­æ”¾å—é™ï¼Œè¯·å…ˆä¸é¡µé¢äº¤äº’å†è¯•ä¸€æ¬¡ï½',
            genericIssue: 'é‡åˆ°äº†å°é—®é¢˜ï¼Œä½†ä¸å½±å“ä½¿ç”¨ ğŸŒŸ'
        },
        data: {
            // è§£é”å¯†è¯­ï¼šä»»ä¸€å‘½ä¸­å³è§†ä¸ºè§£é”ï¼ˆä»…å­˜å¸ƒå°”çŠ¶æ€ï¼Œä¸å›å†™æ˜æ–‡ï¼‰
            secretKeys: ["2001-06-18","20010618","loveu","zixian"],
            // ç›¸å†Œæ•°ç»„ï¼š{src, tag, place, time, say}
            photos: [
                {src:"https://images.unsplash.com/photo-1529336953121-a0ce99a0f007?q=80&w=1400&auto=format&fit=crop", tag:"æ—…è¡Œ", place:"é’å²›", time:"2023-08", say:"æµ·é£æŠŠä½ çœ¸å­é‡Œçš„å…‰ä¹Ÿå¹äº®äº†"},
                {src:"https://images.unsplash.com/photo-1520975916090-3105956dac38?q=80&w=1400&auto=format&fit=crop", tag:"æ—¥å¸¸", place:"å®¶", time:"2024-02", say:"ç…è›‹çš„è¾¹ç¼˜åƒæ—¥å‡º"},
                {src:"https://images.unsplash.com/photo-1489440543286-a69330151c0a?q=80&w=1400&auto=format&fit=crop", tag:"é«˜ç”œ", place:"å’–å•¡é¦†", time:"2024-11", say:"æ‹¿é“æ³¡æ²«ä¸Šçš„å°èƒ¡å­æ¡ˆå‘ç°åœº"},
                {src:"https://images.unsplash.com/photo-1510772314292-9c0ad4c82d9d?q=80&w=1400&auto=format&fit=crop", tag:"æç¬‘", place:"æ¸¸ä¹å›­", time:"2022-10", say:"å°–å«çš„å’Œç¬‘çš„å…¶å®ä¸€ä¸ªæ„æ€"},
                {src:"https://images.unsplash.com/photo-1549880338-65ddcdfd017b?q=80&w=1400&auto=format&fit=crop", tag:"æ—…è¡Œ", place:"å±±é‡", time:"2021-07", say:"é“¶æ²³è¦ä»ä½ çš„ç«æ¯›ä¸Šè·¯è¿‡"},
                {src:"https://images.unsplash.com/photo-1469474968028-56623f02e42e?q=80&w=1400&auto=format&fit=crop", tag:"æ—¥å¸¸", place:"å°åŒº", time:"2024-05", say:"æ™šé£å’Œä½ éƒ½å‡†ç¡®æŠµè¾¾"}
            ],
            // æ—¶é—´è½´å¡ç‰‡ï¼šwhenï¼ˆè§’æ ‡ï¼‰/ frontï¼ˆæ­£é¢ï¼‰/ backï¼ˆåé¢ï¼‰
            timeline: [
                {when:"åˆè§", front:"ç¬¬ä¸€æ¬¡å¿ƒåŠ¨", back:"å¦‚æœèƒ½å›åˆ°é‚£å¤©ï¼Œæˆ‘ä¼šæ›´å¤§å£°åœ°è¯´ï¼šå¹¸ä¼šï¼Œå®‡å®™èµ å“ã€‚"},
                {when:"ç¬¬ä¸€æ¬¡æ—…è¡Œ", front:"é”™è¿‡æœ«ç­è½¦", back:"åŸæ¥æ…¢ä¸€ç‚¹ï¼Œä¸–ç•Œä¼šæ›´é…åˆæˆ‘ä»¬ã€‚"},
                {when:"ç¬¬ä¸€ä»½ç¤¼ç‰©", front:"äº²æ‰‹åšçš„è›‹ç³•", back:"ç³–éœœå¤ªç”œï¼Œä½†ä½ ç¬‘èµ·æ¥åˆšå¥½ã€‚"},
                {when:"æ¬å®¶é‚£å‘¨", front:"ç®±å­å±±", back:"è°¢è°¢ä½ æŠŠæˆ‘çš„æ··ä¹±ä¹Ÿè£…ç®±æ‰“åŒ…ã€‚"},
                {when:"ä»Šå¹´ä»Šå¤©", front:"ç”Ÿæ—¥ï¼", back:"ç»§ç»­å¹¶è‚©ï¼Œä»¥æ’æ˜Ÿä½œè·¯ç¯ã€‚"}
            ],
            // æ‰­è›‹æ± ï¼štitle/desc ä½“ç°åœ¨å¡ç‰‡ä¸ä¸‹è½½ PNG
            coupons: [
                {title:"åºŠä¸Šæ—©é¤åˆ¸", desc:"å‘¨æœ«ä»»é€‰ä¸€æ—¥ï¼Œå¥‰ä¸Šæ‰‹ä½œæ—©é¤+å’–å•¡ã€‚"},
                {title:"è‚©é¢ˆæŒ‰æ‘©åˆ¸", desc:"15åˆ†é’Ÿè‚©é¢ˆæ”¾æ¾ï¼ŒæŒ‰åˆ°ä½ å‘¼å™œå“ã€‚"},
                {title:"ç”µå½±è‡ªç”±åˆ¸", desc:"ä½ é€‰ç‰‡ï¼Œæˆ‘é—­å˜´ã€‚"},
                {title:"æ•£æ­¥é›¨å¤©åˆ¸", desc:"å°åŒºç»•ä¸¤åœˆï¼Œä¼ä¸‹è®²å…«å¦ã€‚"},
                {title:"å®¶åŠ¡ç»ˆæ­¢åˆ¸", desc:"å½“æ—¥å…é™¤ä¸€åˆ‡å®¶åŠ¡ï¼Œç›‘ç£ä¹Ÿç®—ã€‚"}
            ],
            // å°æµ‹é¢˜åº“ï¼šq é—®é¢˜æ–‡æœ¬ / a é€‰é¡¹æ•°ç»„ / pick æ­£ç¡®ä¸‹æ ‡
            quiz: [
                {q:"å¥¹æ›´çˆ±å“ªç§æ—©é¥­ï¼Ÿ", a:["å’¸å…š","ç”œå…š"], pick:1},
                {q:"æœ€å¸¸ç”¨çš„è¡¨æƒ…ï¼Ÿ", a:["(=ï¾ŸÏ‰ï¾Ÿ)=","(Ë˜ï¸¶Ë˜).ï½¡."], pick:0},
                {q:"æœ€ä¸èˆå¾—åˆ çš„ç…§ç‰‡ç±»å‹ï¼Ÿ", a:["ç³Šä½†å¿«ä¹","ç¾ä½†æ— èŠ"], pick:0},
                {q:"ç†æƒ³æ—…è¡Œæ–¹å¼ï¼Ÿ", a:["æ­¥è¡ŒåŸå¸‚","æµ·è¾¹å‘å‘†"], pick:1},
                {q:"æ”¶åˆ°èŠ±æœ€æƒ³è¦ï¼Ÿ", a:["å‘æ—¥è‘µ","æ»¡å¤©æ˜Ÿ"], pick:1}
            ],
            // æ‹¼å›¾èƒŒæ™¯ï¼ˆCSS èƒŒæ™¯åˆ‡ç‰‡æ˜¾ç¤ºï¼›ä¸ç»˜åˆ¶åˆ° Canvasï¼Œä¸å— CORS é™åˆ¶ï¼‰
            puzzleImg: "https://images.unsplash.com/photo-1500530855697-b586d89ba3ee?q=80&w=1200&auto=format&fit=crop",
            // æ‹¼å›¾å®Œæˆåæ’­æ”¾ï¼ˆå¯ç•™ç©ºä»¥ç¦ç”¨ï¼‰
            surpriseAudio: "",
            // èƒŒæ™¯éŸ³ä¹ï¼ˆå¯¼èˆªä¼šå‡ºç°æ’­æ”¾/é™éŸ³æŒ‰é’®ï¼›ç•™ç©ºåˆ™éšè—æŒ‰é’®ï¼‰
            bgm: ""
        },
        // ä¸»é¢˜é…ç½®ï¼ˆ'sweet' å¼€å¯ç²‰å«©ä¸»é¢˜ï¼‰
        ui: { theme: 'sweet' },
        effects: {
            // æ€§èƒ½è‡ªé€‚åº”
            performance: {
                targetFPS: 55, 
                degradeAt: [48, 32],
                maxBalloons: 24, 
                maxBarrages: 60,
                dprFactor: {"1":0.9,"1.5":1.0,"2":1.05,"3":1.1}
            },
            // å…¨å±€æ°”çƒåŠ¨æ•ˆï¼ˆé¡µé¢ä¸Šå±‚æ¼‚æµ®ï¼‰
            balloons: {
                enabled: true,
                // æ¯åˆ†é’Ÿå¤§çº¦å¤šå°‘ä¸ªæ°”çƒï¼ˆå®é™…è®¡æ—¶å¸¦è½»å¾®éšæœºæŠ–åŠ¨ï¼‰
                densityPerMinute: 15,
                // ä¸Šå‡åŠ¨ç”»æ—¶é•¿ï¼ˆç§’åŒºé—´ï¼Œå•ä¸ªæ°”çƒåœ¨åŒºé—´å†…éšæœºï¼‰
                speedSecRange: [7, 12],
                // æ°”çƒæ–‡æ¡ˆæ± ï¼ˆä¸ºç©ºæ—¶ä¼šå›é€€åˆ°å†…ç½® DEFAULT_WISHESï¼‰
                texts: ['ç”Ÿæ—¥å¿«ä¹','æ°¸è¿œå¼€å¿ƒ','æ‰€çˆ±çš†æ‰€å¾—','è¢«ä¸–ç•Œæ¸©æŸ”ä»¥å¾…'],
                colors: [
                    ['#ff6b9d','#c9184a'],['#ffd93d','#f9a826'],['#6bcf7f','#2d8f47'],['#74c0fc','#339af0'],['#da77f2','#9c36d4'],['#ff8787','#fa5252']
                ],
                shape: 'mix',        // 'round' | 'heart' | 'mix'
                glossy: true,        // é«˜å…‰&è¾¹ç¼˜å…‰
                depthBlur: [0, 1.5]  // åŒå±æ™¯æ·±ï¼ˆåƒç´ ï¼‰èŒƒå›´
            },
            // å…¨å±€å¼¹å¹•åŠ¨æ•ˆï¼ˆæ¨ªå‘æ»šåŠ¨ï¼‰
            barrage: {
                enabled: true,
                // æ¯åˆ†é’Ÿå¤§çº¦å¤šå°‘æ¡å¼¹å¹•ï¼ˆå®é™…è®¡æ—¶å¸¦è½»å¾®éšæœºæŠ–åŠ¨ï¼‰
                densityPerMinute: 20,
                // å•æ¡å¼¹å¹•æ»šåŠ¨å…¨å±æ‰€éœ€æ—¶é—´ï¼ˆæ¯«ç§’åŒºé—´ï¼Œå•æ¡åœ¨åŒºé—´å†…éšæœºï¼‰
                speedMsRange: [5000, 9000],
                // å¼¹å¹•æ–‡æ¡ˆæ± ï¼ˆä¸ºç©ºæ—¶ä¼šå›é€€åˆ°å†…ç½® DEFAULT_WISHESï¼‰
                messages: ['Zixianç”Ÿæ—¥å¿«ä¹ï¼','æ„¿ä½ æ˜Ÿæ²³é•¿æ˜','ä»Šå¤©ä¹Ÿè¦å¼€å¿ƒï¼','æœ‰æˆ‘åœ¨~','è¦ä¸€ç›´è¢«çˆ±åŒ…å›´']
            }
        },
        // æ‹¼å›¾å¯é…ç½®
        puzzle: { 
            defaultSize: 3, 
            sizeOptions: [3, 4], 
            showGhost: true 
        }
    };

    // ===== æ–‡æ¡ˆæ€»æ§ï¼ˆAlt+E / å¯¼èˆªæŒ‰é’®"ğŸ“ æ–‡æ¡ˆ"ï¼‰=====
    (function CopyCenter(){
      const OVK='COPY_OVERRIDES_V1';
      const isObj=o=>o&&typeof o==='object'&&!Array.isArray(o);
      const norm=p=>p.replace(/\[(\d+)\]/g,'.$1');
      const get=(o,p)=>norm(p).split('.').reduce((a,k)=>a?.[k],o);
      const set=(o,p,v)=>{ const ks=norm(p).split('.'); const last=ks.pop(); let cur=o;
        for(const k of ks){ if(!(k in cur)||!isObj(cur[k])) cur[k]={}; cur=cur[k]; } cur[last]=v; };
      const merge=(t,s)=>{ for(const k in s){ if(isObj(s[k])){ if(!isObj(t[k])) t[k]={}; merge(t[k],s[k]); } else { t[k]=s[k]; } } return t; };
      const collect=(o,prefix='',out=[])=>{
        if(typeof o==='string'){ out.push({path:prefix,value:o}); return out; }
        if(Array.isArray(o)){ o.forEach((it,i)=>collect(it,`${prefix}[${i}]`,out)); return out; }
        if(isObj(o)){ Object.keys(o).forEach(k=>collect(o[k], prefix?`${prefix}.${k}`:k, out)); }
        return out;
      };

      // è½½å…¥å†å²è¦†ç›–
      try{ const raw=localStorage.getItem(OVK); if(raw) merge(CONFIG, JSON.parse(raw)); }catch{}

      // ç»‘å®šä¸åˆ·æ–°ï¼ˆæŠŠ key è®°åˆ° DOMï¼Œä¾¿äºé«˜äº®ä¸é‡æ‰“ï¼‰
      const B=[];
      window.bindText=(sel,key,{html=false}={})=>{
        const el=document.querySelector(sel); if(!el) return;
        const v=get(CONFIG,key); if(v==null) return;
        if(html) el.innerHTML=v; else el.textContent=v;
        el.dataset.copyKey=key; B.push({sel,key,html});
      };
      window.refreshCopy=()=>{
        B.forEach(({sel,key,html})=>{
          const el=document.querySelector(sel); if(!el) return;
          const v=get(CONFIG,key); if(v==null) return;
          if(html) el.innerHTML=v; else el.textContent=v;
        });
        try{ dom.clear(); }catch{}
        try{ gallery.renderFilters(); gallery.render(); }catch{}
        try{ renderTimeline(); }catch{}
        try{ renderQuiz(); }catch{}
        if (Array.isArray(CONFIG.hero.lines)) window.__TYPEWRITER_LINES__ = CONFIG.hero.lines.slice();
      };

      // æ–‡æ¡ˆé¢æ¿ UI
      function setupUI(){
        const css=`
        #copyBtn{margin-left:8px}
        #copyPanel{position:fixed;top:0;right:0;width:min(520px,100%);height:100vh;background:#0b1624;
          box-shadow:-24px 0 40px rgba(0,0,0,.4);z-index:9999;display:none;flex-direction:column}
        #copyPanel.open{display:flex}
        #copyPanel header{display:flex;gap:8px;align-items:center;padding:10px;border-bottom:1px solid rgba(255,255,255,.08)}
        #copyPanel input,#copyPanel textarea{width:100%;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);
          color:#e6e6fa;border-radius:8px;padding:8px}
        #copyList{padding:10px;overflow:auto;display:grid;gap:8px}
        .copy-item{display:grid;gap:6px}
        .copy-key{font:12px/1.2 system-ui;color:#9aa7b2}
        [data-copy-highlight] [data-copy-key]::after{
          content:attr(data-copy-key);position:absolute;left:6px;bottom:6px;background:#efb8c8;color:#381a22;border-radius:6px;
          padding:2px 6px;font:12px/1 system-ui }
        `;
        const st=document.createElement('style'); st.textContent=css; document.head.appendChild(st);

        const nav=document.querySelector('.nav-inner');
        const btn=document.createElement('button'); btn.id='copyBtn'; btn.className='pill'; btn.type='button'; btn.textContent='ğŸ“ æ–‡æ¡ˆ';
        btn.addEventListener('click',toggle); if(nav) nav.appendChild(btn);

        const p=document.createElement('div'); p.id='copyPanel';
        p.innerHTML=`
          <header>
            <strong style="flex:1">æ–‡æ¡ˆé¢æ¿</strong>
            <input id="copySearch" placeholder="æœç´¢ key æˆ–å†…å®¹â€¦" />
            <button class="btn ghost" id="copyHighlight">é«˜äº®</button>
            <button class="btn ghost" id="copyExport">å¯¼å‡ºJSON</button>
            <button class="btn ghost" id="copyImport">å¯¼å…¥JSON</button>
            <button class="btn" id="copyClose">å…³é—­</button>
          </header>
          <div id="copyList"></div>`;
        document.body.appendChild(p);

        const list=p.querySelector('#copyList');
        const render=(q='')=>{
          const items=collect(CONFIG).filter(it=>{
            const s=(it.path+' '+it.value).toLowerCase(); return !q || s.includes(q.toLowerCase());
          });
          list.innerHTML='';
          for(const it of items){
            const wrap=document.createElement('div'); wrap.className='copy-item';
            wrap.innerHTML=`<div class="copy-key">${it.path}</div>`;
            const multi=/\n/.test(it.value) || it.value.length>60;
            const field=document.createElement(multi?'textarea':'input');
            field.value=it.value;
            field.addEventListener('input', (e)=>{
              set(CONFIG,it.path,e.target.value);
              localStorage.setItem(OVK, JSON.stringify(CONFIG));
              refreshCopy();
            });
            wrap.appendChild(field); list.appendChild(wrap);
          }
        };
        render();
        p.querySelector('#copySearch').addEventListener('input',e=>render(e.target.value));
        let hl=false; p.querySelector('#copyHighlight').addEventListener('click',()=>{
          hl=!hl; document.documentElement.toggleAttribute('data-copy-highlight',hl);
        });
        p.querySelector('#copyExport').addEventListener('click',()=>{
          const blob=new Blob([JSON.stringify(CONFIG,null,2)],{type:'application/json'});
          const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='copy.json'; a.click();
          setTimeout(()=>URL.revokeObjectURL(a.href),1000);
        });
        p.querySelector('#copyImport').addEventListener('click',()=>{
          const txt=prompt('ç²˜è´´ JSONï¼š'); if(!txt) return;
          try{ merge(CONFIG, JSON.parse(txt)); localStorage.setItem(OVK, JSON.stringify(CONFIG)); refreshCopy(); render(); }
          catch{ alert('JSON æ— æ•ˆ'); }
        });
        
        // â€”â€” èµ„äº§ï¼ˆå›¾ç‰‡ï¼‰ç®¡ç†ï¼šæ‰«æå¹¶ä¸Šä¼ æ›¿æ¢ â€”â€” //
        const ASSET_BOX = document.createElement('details');
        ASSET_BOX.open = true;
        ASSET_BOX.innerHTML = `
          <summary style="padding:8px 10px;border-top:1px solid rgba(255,255,255,.08);cursor:pointer">ğŸ“· èµ„äº§ Â· å›¾ç‰‡æ›¿æ¢</summary>
          <div id="assetList" style="padding:10px;display:grid;gap:10px"></div>`;
        p.appendChild(ASSET_BOX);

        function looksLikeImage(v){
          return typeof v==='string' && /^(data:image\/|https?:\/\/).+/i.test(v);
        }
        // æ”¶é›†æ‰€æœ‰ string å›¾ç‰‡å­—æ®µï¼ˆå«æ•°ç»„ï¼‰
        function collectImageKeys(root){
          const out=[]; const walk=(o, path='')=>{
            if (typeof o==='string'){ if(looksLikeImage(o)) out.push({path,value:o}); return; }
            if (Array.isArray(o)){ o.forEach((it,i)=>walk(it, `${path}[${i}]`)); return; }
            if (o && typeof o==='object'){ Object.keys(o).forEach(k=>walk(o[k], path?`${path}.${k}`:k)); }
          }; walk(root); return out;
        }

        function drawAssets(){
          const box = ASSET_BOX.querySelector('#assetList'); box.innerHTML='';
          const imgs = collectImageKeys(CONFIG);
          imgs.forEach(({path,value})=>{
            const row=document.createElement('div');
            row.style.display='grid'; row.style.gridTemplateColumns='1fr auto'; row.style.gap='8px'; row.style.alignItems='center';
            const left=document.createElement('div');
            const shortValue = value.length > 50 ? value.substring(0, 47) + '...' : value;
            left.innerHTML = `<div class="copy-key">${path}</div>
              <div style="display:flex;gap:8px;align-items:center;margin-top:4px">
                <img src="${value}" alt="" style="width:64px;height:48px;object-fit:cover;border-radius:6px;border:1px solid rgba(255,255,255,.15)" onerror="this.style.display='none'"/>
                <input value="${shortValue}" readonly style="cursor:pointer;font-size:11px" title="${value}" />
              </div>`;
            const up=document.createElement('button'); up.className='btn ghost'; up.textContent='ä¸Šä¼ æ›¿æ¢'; up.style.fontSize='12px';
            up.addEventListener('click', async ()=>{
              const f=document.createElement('input'); f.type='file'; f.accept='image/*';
              f.onchange=async ()=>{
                const file=f.files?.[0]; if(!file) return;
                const dataUrl = await compressToDataURL(file, 1600, 0.85); // å®½åº¦ä¸Šé™ï¼Œè´¨é‡85%
                set(CONFIG, path, dataUrl);
                localStorage.setItem(OVK, JSON.stringify(CONFIG));
                refreshCopy(); drawAssets();
              }; f.click();
            });
            row.append(left,up); box.appendChild(row);
          });
        }
        drawAssets();

        // å›¾ç‰‡å‹ç¼©åˆ° dataURLï¼ˆé¿å… CORSï¼Œé€‚é…æ‹¼å›¾èƒŒæ™¯ï¼‰
        async function compressToDataURL(file, maxW=1600, quality=0.85){
          return new Promise((resolve)=>{
            const r=new FileReader(); 
            r.onload=()=>{ 
              const i=new Image(); 
              i.onload=()=>{
                const scale = Math.min(1, maxW / i.width);
                const w = Math.round(i.width*scale), h=Math.round(i.height*scale);
                const c=document.createElement('canvas'); c.width=w; c.height=h;
                const ctx=c.getContext('2d'); ctx.drawImage(i,0,0,w,h);
                resolve(c.toDataURL('image/jpeg', quality));
              };
              i.src=r.result; 
            }; 
            r.readAsDataURL(file); 
          });
        }
        
        p.querySelector('#copyClose').addEventListener('click',toggle);
        document.addEventListener('keydown',e=>{ if(e.altKey && (e.key==='e'||e.key==='E')){ e.preventDefault(); toggle(); } });
        function toggle(){ p.classList.toggle('open'); }
      }
      if(document.readyState==='loading'){ document.addEventListener('DOMContentLoaded',setupUI); } else setupUI();

      // å°‘é‡ API
      window.__COPY_PANEL__={open:()=>document.getElementById('copyPanel')?.classList.add('open')};
    })();

    // ===== æ€§èƒ½ç›‘æ§ =====
    const perf = {
        start: performance.now(),
        mark: (name) => {
            const t = performance.now() - perf.start;
            console.log(`â±ï¸ ${name}: ${t.toFixed(2)}ms`);
        }
    };

    // å°†é¡µé¢é™æ€æ–‡æ¡ˆä¸å…ƒä¿¡æ¯ä» CONFIG æ³¨å…¥
    function applyConfig(){
        document.title = CONFIG.site.title;
        const metaDesc=document.querySelector('meta[name="description"]'); if(metaDesc) metaDesc.setAttribute('content',CONFIG.site.description);
        const ogTitle=document.querySelector('meta[property="og:title"]'); if(ogTitle) ogTitle.setAttribute('content',CONFIG.site.title);
        const ogDesc=document.querySelector('meta[property="og:description"]'); if(ogDesc) ogDesc.setAttribute('content',CONFIG.site.description);
        const ogImg=document.querySelector('meta[property="og:image"]'); if(ogImg) ogImg.setAttribute('content',CONFIG.site.ogImage);
        const theme=document.querySelector('meta[name="theme-color"]'); if(theme) theme.setAttribute('content',CONFIG.site.themeColor);

        bindText('.nav-inner .pill','site.brand');
        bindText('#navPhotos','nav.photos');
        bindText('#navTimeline','nav.timeline');
        bindText('#navGacha','nav.gacha');
        bindText('#navQuiz','nav.quiz');
        bindText('#navPuzzle','nav.puzzle');
        bindText('#navPromise','nav.promise');

        bindText('h1.title','hero.titleHTML',{html:true});
        const keyInput=document.getElementById('key'); if(keyInput) keyInput.placeholder=CONFIG.hero.keyPlaceholder;
        bindText('#unlock','hero.unlock');
        bindText('#goPhotos','hero.go');
        bindText('#heroTip','hero.tip');

        bindText('#photosTitle','sections.photos.title');
        bindText('#photosSub','sections.photos.sub');
        bindText('#timelineTitle','sections.timeline.title');
        bindText('#timelineTip','sections.timeline.tip');
        bindText('#gachaTitle','sections.gacha.title');
        bindText('#roll','sections.gacha.roll');
        bindText('#saveCoupon','sections.gacha.save');
        bindText('#quizTitle','sections.quiz.title');
        bindText('#submitQuiz','sections.quiz.submit');
        const scorePill=document.querySelector('#scoreLabelPill');
        if(scorePill) scorePill.innerHTML=`${CONFIG.sections.quiz.scoreLabel}ï¼š<span id="score">â€”</span>`;
        bindText('#saveBadge','sections.quiz.save');
        bindText('#puzzleTitle','sections.puzzle.title');
        bindText('#puzzleTip','sections.puzzle.tip');
        bindText('#shuffle','sections.puzzle.shuffle');
        bindText('#reveal','sections.puzzle.reveal');
        bindText('#promiseTitle','sections.promise.title');
        bindText('#sigLabel','sections.promise.sigLabel');
        bindText('#savePoster','sections.promise.save');
        bindText('#clearSig','sections.promise.clear');

        const footer=document.querySelector('footer .container');
        if(footer) footer.innerHTML=(CONFIG.sections.footer||'').replace('{year}', new Date().getFullYear());

        if(Array.isArray(CONFIG.hero.lines)) window.__TYPEWRITER_LINES__=CONFIG.hero.lines.slice();
    }
    
    // ===== æ•°æ®ï¼ˆæ”¹ä¸ºä» CONFIG è¯»å–ï¼‰ =====
    const DATA = CONFIG.data;

    // ç¥ç¦çŸ­è¯­åº“ï¼ˆç”¨äºè‡ªåŠ¨æˆ–ç©ºè¾“å…¥æ—¶éšæœºï¼‰
    const DEFAULT_WISHES = [
        'æ„¿ä½ å¿«ä¹','å¹³å®‰å–œä¹','ä¸‡äº‹èƒœæ„','å¿ƒæƒ³äº‹æˆ','å‰ç¨‹ä¼¼é”¦',
        'å¾—å¿æ‰€æ„¿','æ—¥æ—¥è‡ªæ–°','é¡ºé£é¡ºæ°´','æ‰€çˆ±çš†æ‰€å¾—','æ°¸è¿œæœ‰å…‰',
        'å²å²å¸¸æ¬¢æ„‰','æ˜Ÿæ²³é•¿æ˜','æ¸©æŸ”ä¸”åšå¼º','è¢«ä¸–ç•Œæ¸©æŸ”ä»¥å¾…'
    ];
    
    // ===== å®‰å…¨å·¥å…·ï¼šæ–‡æœ¬æ¸…ç†ï¼ˆé˜²XSSï¼‰ =====
    const sanitize = {
        text: (str) => String(str || '').slice(0, 500),
        html: (str) => sanitize.text(str).replace(/[<>'"&]/g, c => ({
            '<': '&lt;', '>': '&gt;', "'": '&#39;', '"': '&quot;', '&': '&amp;'
        })[c])
    };
    
    // ===== ç²¾ç¡®ç»•æ—¥æ¬¡æ•°è®¡ç®— =====
    function orbitsSince(isoDate = '2001-06-18') {
        const birth = new Date(isoDate);
        const now = new Date();
        let years = now.getFullYear() - birth.getFullYear();
        const hadBirthday = (now.getMonth() > birth.getMonth()) || 
                          (now.getMonth() === birth.getMonth() && now.getDate() >= birth.getDate());
        return hadBirthday ? years : years - 1;
    }
    
    // ===== Unsplash å“åº”å¼å›¾ç‰‡è¾…åŠ© =====
    const unsplash = (baseUrl, width) => {
        try {
            const url = new URL(baseUrl);
            url.searchParams.set('w', width);
            url.searchParams.set('auto', 'format');
            url.searchParams.set('fit', 'crop');
            url.searchParams.set('q', '80');
            return url.toString();
        } catch {
            return baseUrl;
        }
    };
    
    // ===== LocalStorage å®‰å…¨å°è£… =====
    const storage = {
        get: (key, fallback = null) => {
            try {
                const val = localStorage.getItem(key);
                return val ? JSON.parse(val) : fallback;
            } catch { return fallback; }
        },
        set: (key, val) => {
            try {
                localStorage.setItem(key, JSON.stringify(val));
                return true;
            } catch { return false; }
        }
    };

    // ===== å·¥å…·ç±»ï¼šæ€§èƒ½ä¼˜åŒ–çš„ DOM æŸ¥è¯¢ =====
    class DOMCache {
        constructor() {
            this.cache = new Map();
        }
        get(selector) {
            if (!this.cache.has(selector)) {
                this.cache.set(selector, document.querySelector(selector));
            }
            return this.cache.get(selector);
        }
        getAll(selector) {
            return document.querySelectorAll(selector);
        }
        clear() {
            this.cache.clear();
        }
    }
    
    const dom = new DOMCache();
    const $ = (s) => dom.get(s);
    const $$ = (s) => dom.getAll(s);

    // ===== å°å·¥å…·å‡½æ•°ï¼ˆæ”¹è¿›ç‰ˆï¼‰ =====
    const rand = (n) => Math.floor(Math.random() * n);
    const randRange = (min, max) => min + Math.random() * (max - min);
    
    const downloadBlob = (blob, filename) => {
        const a = document.createElement('a');
        const url = URL.createObjectURL(blob);
        a.href = url;
        a.download = filename;
        a.click();
        setTimeout(() => URL.revokeObjectURL(url), 1000);
    };
    
    const debounce = (fn, delay = 150) => {
        let timer;
        return (...args) => {
            clearTimeout(timer);
            timer = setTimeout(() => fn(...args), delay);
        };
    };
    
    const throttle = (fn, limit = 100) => {
        let inThrottle;
        return (...args) => {
            if (!inThrottle) {
                fn(...args);
                inThrottle = true;
                setTimeout(() => inThrottle = false, limit);
            }
        };
    };
    
    // å®‰å…¨çš„ IntersectionObserverï¼ˆæ‡’åŠ è½½ä¼˜åŒ–ï¼‰
    const lazyObserver = 'IntersectionObserver' in window ? new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                const img = entry.target;
                if (img.dataset.src) {
                    img.src = img.dataset.src;
                    img.removeAttribute('data-src');
                    lazyObserver.unobserve(img);
                }
            }
        });
    }, { rootMargin: '50px' }) : null;
    
    const prefersReducedMotion = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;
    const smoothBehavior = prefersReducedMotion ? 'auto' : 'smooth';

    // é€šç”¨ï¼šCSSåƒç´ åˆ°é«˜DPRç”»å¸ƒç¼©æ”¾ï¼ˆæ”¹è¿›ç‰ˆï¼‰
    function scaleCanvas(canvas, ctx) {
        const rect = canvas.getBoundingClientRect();
        // åŠ¨æ€é™åˆ¶ DPR ä¸ç”»å¸ƒåƒç´ ï¼Œé¿å…æµè§ˆå™¨åœ¨æé™ç¼©æ”¾ä¸‹åˆ†é…è¶…å¤§ä½å›¾å¯¼è‡´å´©æºƒ
        const MAX_DIM = 4096; // å•è¾¹æœ€å¤§åƒç´ ï¼ˆä¿æŠ¤é˜ˆå€¼ï¼‰
        const rawDpr = window.devicePixelRatio || 1;
        const dprCap = Math.min(2, MAX_DIM / Math.max(1, rect.width), MAX_DIM / Math.max(1, rect.height));
        const dpr = Math.max(1, Math.min(rawDpr, dprCap));
        const w = Math.max(1, Math.floor(rect.width * dpr));
        const h = Math.max(1, Math.floor(rect.height * dpr));
        if (canvas.width !== w || canvas.height !== h) {
            canvas.width = w;
            canvas.height = h;
            ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
        }
        return { width: rect.width, height: rect.height, dpr };
    }
    
    applyConfig();
    
    // ===== å¯ç”¨ç”œèœœä¸»é¢˜ =====
    if (CONFIG.ui?.theme === 'sweet') { 
        document.body.classList.add('theme-sweet'); 
    }
    
    perf.mark('æ ¸å¿ƒå·¥å…·åˆå§‹åŒ–å®Œæˆ');

    // ===== æ˜Ÿé‡èƒŒæ™¯ & æ‰“å­—æœºï¼ˆä¼˜åŒ–ç‰ˆï¼‰ =====
    const typingEl = $('#typing');
    // ä» CONFIG.hero.lines æ³¨å…¥ï¼Œå¯éšæ—¶åœ¨é¡¶éƒ¨é…ç½®ä¿®æ”¹
    const lines = Array.isArray(window.__TYPEWRITER_LINES__) ? window.__TYPEWRITER_LINES__ : [
        'ä¸ä½ åŒè½¨çš„ç¬¬Næ¬¡ç»•æ—¥æ—…è¡Œã€‚',
        'ä»Šæ™šï¼ŒæŠŠå›å¿†æ’æˆæ˜Ÿåº§ã€‚',
        'ç¥ä½ ç”Ÿæ—¥å¿«ä¹ï¼Œå­èŒœã€‚'
    ];
    
    // æ‰“å­—æœºæ•ˆæœç®¡ç†å™¨
    class TypeWriter {
        constructor(element, lines, speed = 50) {
            this.element = element;
            this.lines = lines;
            this.speed = speed;
            this.lineIdx = 0;
            this.charIdx = 0;
            this.isRunning = false;
        }
        
        start() {
            if (prefersReducedMotion) {
                const str = this.lines[0].replace('N', new Date().getFullYear() - 2001);
                this.element.textContent = str;
                return;
            }
            this.isRunning = true;
            this.tick();
        }
        
        tick() {
            if (!this.isRunning) return;
            
            const str = this.lines[this.lineIdx].replace('N', new Date().getFullYear() - 2001);
            this.element.textContent = str.slice(0, this.charIdx++);
            
            if (this.charIdx <= str.length) {
                setTimeout(() => this.tick(), this.speed);
            } else {
                setTimeout(() => {
                    this.charIdx = 0;
                    this.lineIdx = (this.lineIdx + 1) % this.lines.length;
                    this.tick();
                }, 1200);
            }
        }
        
        stop() {
            this.isRunning = false;
        }
    }
    
    const typeWriter = new TypeWriter(typingEl, lines);
    typeWriter.start();
    
    // ä½¿ç”¨ç²¾ç¡®çš„ç»•æ—¥æ¬¡æ•°è®¡ç®—
    const orbits = orbitsSince('2001-06-18');
    const revolutionsEl = $('#revolutions');
    if (revolutionsEl) revolutionsEl.textContent = orbits;

    // æ˜Ÿæ˜Ÿåœºï¼ˆæ€§èƒ½ä¼˜åŒ–ç‰ˆï¼‰
    class StarField {
        constructor(canvas) {
            this.canvas = canvas;
            this.ctx = canvas.getContext('2d', { alpha: true });
            this.stars = [];
            this.width = 0;
            this.height = 0;
            this.animationId = null;
            this.init();
        }
        
        init() {
            this.resize();
            if (!prefersReducedMotion) {
                this.animate();
            } else {
                this.drawFrame();
            }
        }
        
        resize() {
            const dims = scaleCanvas(this.canvas, this.ctx);
            this.width = dims.width;
            this.height = dims.height;
            this.createStars();
        }
        
        createStars() {
            const count = Math.min(200, Math.floor(this.width * this.height / 1000));
            this.stars = Array.from({ length: count }, () => ({
                x: Math.random() * this.width,
                y: Math.random() * this.height,
                z: Math.random() * 1 + 0.2,
                vx: (Math.random() - 0.5) * 0.15,
                vy: (Math.random() - 0.5) * 0.15
            }));
        }
        
        drawFrame() {
            this.ctx.clearRect(0, 0, this.width, this.height);
            for (const s of this.stars) {
                this.ctx.fillStyle = `rgba(255,255,255,${0.4 + s.z * 0.6})`;
                const size = 1.4 + s.z * 1.6;
                this.ctx.fillRect(s.x, s.y, size, size);
            }
        }
        
        animate() {
            this.ctx.clearRect(0, 0, this.width, this.height);
            
            for (const s of this.stars) {
                s.x += s.vx;
                s.y += s.vy;
                
                if (s.x < 0 || s.x > this.width) s.vx *= -1;
                if (s.y < 0 || s.y > this.height) s.vy *= -1;
                
                this.ctx.fillStyle = `rgba(255,255,255,${0.4 + s.z * 0.6})`;
                const size = 1.4 + s.z * 1.6;
                this.ctx.fillRect(s.x, s.y, size, size);
            }
            
            this.animationId = requestAnimationFrame(() => this.animate());
        }
        
        destroy() {
            if (this.animationId) {
                cancelAnimationFrame(this.animationId);
                this.animationId = null;
            }
        }
        
        pause() {
            this.destroy();
        }
        
        resume() {
            if (!prefersReducedMotion && !this.animationId) {
                this.animate();
            }
        }
    }
    
    const starField = new StarField(document.getElementById('starfield'));
    window.addEventListener('resize', debounce(() => starField.resize(), 300), { passive: true });
    
    // é¡µé¢å¯è§æ€§å˜åŒ–ï¼šæš‚åœ/æ¢å¤åŠ¨ç”»
    document.addEventListener('visibilitychange', () => {
        if (document.hidden) {
            starField.pause();
        } else {
            starField.resume();
        }
    });
    
    perf.mark('æ˜Ÿé‡èƒŒæ™¯åˆå§‹åŒ–å®Œæˆ');

    // å¼€å§‹é€›å±•ï¼ˆæ— å†…è”å¤„ç†ï¼‰
    $('#goPhotos').addEventListener('click', () => {
        const target = document.querySelector('#photos');
        if (target) {
            target.scrollIntoView({ behavior: smoothBehavior });
        }
    });

    // ===== å¯†è¯­è§£é” & éšè—ç›¸å†Œï¼ˆå®‰å…¨å¢å¼ºç‰ˆï¼‰ =====
    class SecretManager {
        constructor() {
            this.setupListeners();
            // ä»localStorageæ¢å¤è§£é”çŠ¶æ€ï¼ˆä»…å­˜å¸ƒå°”å€¼ï¼Œä¸å­˜å¯†é’¥ï¼‰
            this.hiddenUnlocked = storage.get('secretUnlocked', false);
            if (this.hiddenUnlocked && gallery) {
                gallery.render();
            }
        }
        
        get hiddenUnlocked() {
            return this._unlocked || false;
        }
        
        set hiddenUnlocked(val) {
            this._unlocked = !!val;
            storage.set('secretUnlocked', this._unlocked);
        }
        
        unlock() {
            const input = $('#key');
            if (!input) return;
            
            // å®‰å…¨ï¼šä½¿ç”¨.valueï¼Œé™åˆ¶é•¿åº¦ï¼Œæ¸…ç†
            const value = sanitize.text(input.value.trim().toLowerCase());
            const isValid = DATA.secretKeys.some(k => k.toLowerCase() === value);
            
            if (isValid) {
                this.hiddenUnlocked = true;
                if (gallery) gallery.render();
                this.showToast(CONFIG.messages.unlockSuccess, 'success');
                input.value = ''; // æ¸…ç©ºè¾“å…¥
            } else {
                this.showToast(CONFIG.messages.unlockFail, 'info');
            }
        }
        
        setupListeners() {
            const unlockBtn = $('#unlock');
            const keyInput = $('#key');
            
            if (unlockBtn) {
                unlockBtn.addEventListener('click', () => this.unlock());
            }
            
            if (keyInput) {
                keyInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        this.unlock();
                    }
                });
            }
            
            // è¿ç‚¹ Z I X I A N å½©è›‹
            let keySequence = "";
            let lastTap = 0;
            window.addEventListener('keydown', (e) => {
                const now = Date.now();
                if (now - lastTap > 1000) keySequence = "";
                lastTap = now;
                
                const ch = (e.key || '').toUpperCase();
                keySequence += ch;
                
                if (keySequence.endsWith('ZIXIAN')) {
                    this.hiddenUnlocked = true;
                    if (gallery) gallery.render();
                    this.showToast(CONFIG.messages.easterEgg, 'success');
                }
            });
        }
        
        // ç»Ÿä¸€çš„è½»é€šçŸ¥ï¼ˆæ”¯æŒç±»å‹ + è¿›åº¦æ¡ï¼‰
        // ç”¨æ³•ï¼šthis.showToast('æç¤ºè¯­', 'success'|'info'|'error', 3000)
        showToast(message, type = 'info', duration = 3000) {
            const container = $('#toast-container');
            if (!container) return;
            
            const toast = document.createElement('div');
            toast.className = 'notification';
            toast.setAttribute('role', 'status');
            const bg = type === 'success' ? 'rgba(107, 207, 127, 0.95)'
                    : type === 'error' ? 'rgba(248, 113, 113, 0.95)'
                    : 'rgba(142, 197, 255, 0.95)';
            toast.style.cssText = `
                background:${bg};color:#0D1B2A;padding:14px 18px;border-radius:12px;
                box-shadow:0 10px 30px rgba(0,0,0,.3);animation:slideIn .25s ease-out;
                font-weight:700;max-width:360px;display:flex;gap:10px;align-items:center;position:relative;overflow:hidden;
            `;

            // å›¾æ ‡ + æ–‡æœ¬
            const icon = document.createElement('span');
            icon.textContent = type === 'success' ? 'âœ…' : type === 'error' ? 'âŒ' : 'â„¹ï¸';
            const txt = document.createElement('span');
            txt.textContent = sanitize.text(message);
            toast.append(icon, txt);
            
            // è¿›åº¦æ¡ï¼ˆè‡ªåŠ¨æ¶ˆå¤±å€’è®¡æ—¶ï¼‰
            const progress = document.createElement('div');
            progress.style.cssText = `position:absolute;left:0;right:0;bottom:0;height:3px;background:rgba(255,255,255,.5);transform-origin:left;`;
            toast.appendChild(progress);
            container.appendChild(toast);
            
            if (progress.animate) {
                progress.animate([{transform:'scaleX(1)'},{transform:'scaleX(0)'}], {duration, easing:'linear', fill:'forwards'});
            }
            const t = setTimeout(() => {
                toast.style.animation = 'slideOut .25s ease-in';
                setTimeout(() => toast.remove(), 260);
                clearTimeout(t);
            }, duration);
        }

        // åˆ«åï¼šå…¼å®¹æ—§è°ƒç”¨ï¼ˆå¦‚ï¼šshowNotificationï¼‰
        showNotification(message, type = 'info', duration = 3000){
            this.showToast(message, type, duration);
        }
    }
    
    const secretManager = new SecretManager();

    // ===== ç›¸å†Œæ¸²æŸ“ï¼ˆä¸“ä¸šç‰ˆé‡æ„ï¼‰ =====
    const baseHidden = [
        { src: "https://images.unsplash.com/photo-1519681393784-d120267933ba?q=80&w=1400&auto=format&fit=crop", tag: "æœªå…¬å¼€", place: "å®¶é‡Œæ²™å‘", time: "2024-06", say: "ç¡ç€äº†ä¹Ÿåœ¨ç¬‘ã€‚" },
        { src: "https://images.unsplash.com/photo-1513278974582-3e1b4a4fa21e?q=80&w=1400&auto=format&fit=crop", tag: "æœªå…¬å¼€", place: "å¤œå®µæ‘Š", time: "2024-09", say: "è°è§„å®šå¤œæ·±ä¸èƒ½å¿«ä¹ã€‚" }
    ];
    
    class Gallery {
        constructor() {
            this.currentTag = null;
            this.galleryList = [];
            this.currentIndex = 0;
            this.lightboxOpen = false;
            this.setupKeyboardNav();
        }
        
        getAllPhotos() {
            let list = [...DATA.photos];
            if (secretManager.hiddenUnlocked) {
                list = list.concat(baseHidden);
            }
            return list;
        }
        
        getTags() {
            const photos = this.getAllPhotos();
            const tags = new Set(photos.map(p => p.tag));
            return Array.from(tags);
        }
        
        renderFilters() {
            const wrap = $('#filters');
            if (!wrap) return;
            
            wrap.innerHTML = '';
            const tags = this.getTags();
            
            const createTag = (tagName) => {
                const el = document.createElement('button');
                el.type = 'button';
                el.className = 'tag';
                el.textContent = tagName;
                
                const isActive = (!this.currentTag && tagName === 'å…¨éƒ¨') || this.currentTag === tagName;
                el.setAttribute('aria-pressed', isActive ? 'true' : 'false');
                
                el.addEventListener('click', () => {
                    this.currentTag = (this.currentTag === tagName) ? null : (tagName === 'å…¨éƒ¨' ? null : tagName);
                    this.renderFilters();
                    this.render();
                });
                
                return el;
            };
            
            wrap.appendChild(createTag('å…¨éƒ¨'));
            tags.forEach(tag => wrap.appendChild(createTag(tag)));
            wrap.appendChild(createTag('æœªå…¬å¼€'));
        }
        
        render() {
            const wrap = $('#gallery');
            if (!wrap) return;
            
            wrap.innerHTML = '';
            
            let list = this.getAllPhotos();
            if (this.currentTag && this.currentTag !== 'å…¨éƒ¨') {
                list = list.filter(p => p.tag === this.currentTag);
            }
            
            this.galleryList = list;
            
            list.forEach((photo, idx) => {
                const figure = document.createElement('figure');
                figure.className = 'photo card';
                figure.tabIndex = 0;
                figure.setAttribute('role', 'button');
                figure.setAttribute('aria-label', `${photo.place || ''} ${photo.time || ''}`.trim());
                
                const img = document.createElement('img');
                img.alt = `${photo.place || ''} ${photo.time || ''}`.trim();
                
                // ç›´æ¥è®¾ç½®å›¾ç‰‡æºï¼Œä¸ä½¿ç”¨æ‡’åŠ è½½
                const baseUrl = photo.src;
                img.src = baseUrl;
                
                // å›¾ç‰‡åŠ è½½å®Œæˆåç¡®ä¿å¯è§
                img.addEventListener('load', () => {
                    img.style.opacity = '1';
                }, { once: true });
                
                // å›¾ç‰‡åŠ è½½å¤±è´¥å¤„ç†
                img.addEventListener('error', () => {
                    img.style.display = 'none';     // âœ… ä¸æ˜¾ç¤ºç ´å›¾å›¾æ ‡
                }, { once: true });
                
                // å®‰å…¨ï¼šä½¿ç”¨ DOM æ–¹æ³•è€Œé innerHTML
                const caption = document.createElement('figcaption');
                const strong = document.createElement('strong');
                strong.textContent = `${photo.place || ''} Â· ${photo.time || ''}`;
                caption.appendChild(strong);
                caption.appendChild(document.createElement('br'));
                caption.appendChild(document.createTextNode(photo.say || ''));
                
                figure.appendChild(img);
                figure.appendChild(caption);
                wrap.appendChild(figure);
                
                const openLightbox = () => this.openLightbox(idx);
                figure.addEventListener('click', openLightbox);
                figure.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        openLightbox();
                    }
                });
            });
        }
        
        openLightbox(idx) {
            this.currentIndex = (idx + this.galleryList.length) % this.galleryList.length;
            const photo = this.galleryList[this.currentIndex];
            
            const bigImg = $('#big');
            const bigCap = $('#bigcap');
            const lightbox = $('#lightbox');
            
            if (!bigImg || !lightbox) return;
            
            bigImg.src = photo.src;
            bigImg.alt = `${photo.place || ''} ${photo.time || ''}`.trim();
            
            if (bigCap) {
                bigCap.textContent = `${photo.place || ''} Â· ${photo.time || ''} â€” ${photo.say || ''}`;
            }
            
            lightbox.classList.add('open');
            this.lightboxOpen = true;
            
            const closeBtn = $('#closeLight');
            if (closeBtn) closeBtn.focus();
        }
        
        openLightboxCustom(src, caption) {
            const bigImg = $('#big');
            const bigCap = $('#bigcap');
            const lightbox = $('#lightbox');
            
            if (!bigImg || !lightbox) return;
            
            bigImg.src = src;
            bigImg.alt = caption || 'æ”¾å¤§ç…§ç‰‡';
            
            if (bigCap) {
                bigCap.textContent = caption || '';
            }
            
            lightbox.classList.add('open');
            this.lightboxOpen = true;
            
            const closeBtn = $('#closeLight');
            if (closeBtn) closeBtn.focus();
        }
        
        closeLightbox() {
            const lightbox = $('#lightbox');
            if (lightbox) {
                lightbox.classList.remove('open');
                this.lightboxOpen = false;
            }
        }
        
        navigateLightbox(direction) {
            if (!this.lightboxOpen || this.galleryList.length === 0) return;
            
            this.currentIndex = (this.currentIndex + direction + this.galleryList.length) % this.galleryList.length;
            this.openLightbox(this.currentIndex);
        }
        
        setupKeyboardNav() {
            window.addEventListener('keydown', (e) => {
                if (!this.lightboxOpen) return;
                
                switch (e.key) {
                    case 'Escape':
                        e.preventDefault();
                        this.closeLightbox();
                        break;
                    case 'ArrowLeft':
                        e.preventDefault();
                        this.navigateLightbox(-1);
                        break;
                    case 'ArrowRight':
                        e.preventDefault();
                        this.navigateLightbox(1);
                        break;
                }
            });
            
            // è®¾ç½®lightboxäº‹ä»¶
            const closeBtn = $('#closeLight');
            const prevBtn = $('#prevLight');
            const nextBtn = $('#nextLight');
            const lightbox = $('#lightbox');
            
            if (closeBtn) closeBtn.addEventListener('click', () => this.closeLightbox());
            if (prevBtn) prevBtn.addEventListener('click', () => this.navigateLightbox(-1));
            if (nextBtn) nextBtn.addEventListener('click', () => this.navigateLightbox(1));
            if (lightbox) {
                lightbox.addEventListener('click', (e) => {
                    if (e.target.id === 'lightbox') this.closeLightbox();
                });
                // === è§¦å±æ‰‹åŠ¿ï¼šå·¦å³æ»‘åŠ¨åˆ‡æ¢ï¼ˆç§»åŠ¨ç«¯ä½“éªŒå¢å¼ºï¼‰ ===
                if ('ontouchstart' in window) {
                    let startX = 0, startY = 0;
                    lightbox.addEventListener('touchstart', (e) => {
                        const t = e.touches && e.touches[0];
                        if (!t) return;
                        startX = t.clientX; startY = t.clientY;
                    }, { passive: true });
                    lightbox.addEventListener('touchend', (e) => {
                        if (!this.lightboxOpen) return;
                        const t = e.changedTouches && e.changedTouches[0];
                        if (!t) return;
                        const dx = t.clientX - startX;
                        const dy = t.clientY - startY;
                        if (Math.abs(dx) > Math.abs(dy) && Math.abs(dx) > 50) {
                            if (dx < 0) this.navigateLightbox(1); else this.navigateLightbox(-1);
                        }
                    }, { passive: true });
                }
            }
        }
    }
    
    const gallery = new Gallery();
    gallery.renderFilters();
    gallery.render();
    
    perf.mark('ç›¸å†Œç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ');

    // ===== æ—¶é—´è½´ =====
    function renderTimeline(){
        const lane=$('#lane'); lane.innerHTML='';
        DATA.timeline.forEach(t=>{
            const tc=document.createElement('div'); tc.className='tcard';
            const face=document.createElement('div'); face.className='face'; face.tabIndex=0; face.setAttribute('role','button'); face.setAttribute('aria-pressed','false');
            const front=document.createElement('div'); front.className='front'; front.innerHTML=`<div class="pill">${t.when}</div><h3 style="margin-top:8px">${t.front}</h3>`;
            const back=document.createElement('div'); back.className='back'; back.innerHTML=`<h3>${t.when}</h3><p class="muted">${t.back}</p>`;
            face.append(front,back); tc.append(face); lane.append(tc);
            const toggle=()=>{ face.classList.toggle('flip'); face.setAttribute('aria-pressed', face.classList.contains('flip')?'true':'false'); };
            face.addEventListener('click',toggle);
            face.addEventListener('keydown',e=>{ if(e.key==='Enter' || e.key===' '){ e.preventDefault(); toggle(); }});
        })
    }
    renderTimeline();

    // ===== æ‰­è›‹åˆ¸ =====
    let lastCoupon=null;
    $('#roll').addEventListener('click',()=>{
        lastCoupon = DATA.coupons[rand(DATA.coupons.length)];
        const win = sanitize.text(CONFIG.sections.gacha.winBanner);
        const serial = sanitize.text(CONFIG.sections.gacha.serialLabel);
        const rules = sanitize.text(CONFIG.sections.gacha.rules);
        $('#coupon').innerHTML = `<div class="row"><div class="pill">${win}</div><div class="right pill">${serial} ${1000+rand(9000)}</div></div><h3>${lastCoupon.title}</h3><p class="muted">${lastCoupon.desc}</p><small class="muted">${rules}</small>`;
        $('#saveCoupon').disabled=false;
    })
    $('#saveCoupon').addEventListener('click',()=>{
        if(!lastCoupon) return;
        const c=document.createElement('canvas'); c.width=900; c.height=500; const ctx=c.getContext('2d');
        const g=ctx.createLinearGradient(0,0,900,500); g.addColorStop(0,'#2a3a55');g.addColorStop(1,'#0d1b2a'); ctx.fillStyle=g; ctx.fillRect(0,0,c.width,c.height);
        ctx.strokeStyle='rgba(239,184,200,.6)'; ctx.setLineDash([16,10]); ctx.lineWidth=3; ctx.strokeRect(18,18,c.width-36,c.height-36);
    ctx.font='700 42px system-ui'; ctx.fillStyle='#EFB8C8'; ctx.fillText(CONFIG.sections.gacha.brandEn, 40, 90);
        ctx.font='700 64px system-ui'; ctx.fillStyle='#fff'; ctx.fillText(lastCoupon.title, 40, 180);
    ctx.font='24px system-ui'; ctx.fillStyle='#cfe3ff'; wrapText(ctx,lastCoupon.desc,40,230,820,34);
    ctx.font='16px system-ui'; ctx.fillStyle='rgba(255,255,255,.7)'; ctx.fillText(CONFIG.sections.gacha.rules,40,460);
        c.toBlob(b=>downloadBlob(b,`coupon_${Date.now()}.png`));
    })

    function wrapText(ctx,text,x,y,maxWidth,lineHeight){
        const words=text.split(' '); let line='';
        for(let n=0;n<words.length;n++){
            const test=line+words[n]+" "; const w=ctx.measureText(test).width;
            if(w>maxWidth && n>0){ctx.fillText(line,x,y); line=words[n]+" "; y+=lineHeight}else{line=test}
        }
        ctx.fillText(line,x,y);
    }

    // ===== å°æµ‹ =====
    function renderQuiz(){
        const f=$('#quizForm'); f.innerHTML='';
        DATA.quiz.forEach((item,idx)=>{
            const q=document.createElement('div'); q.className='q';
            q.innerHTML=`<div style="margin-bottom:6px"><strong>Q${idx+1}. ${item.q}</strong></div>`;
            item.a.forEach((opt,i)=>{
                const id=`q${idx}_${i}`;
                const lab=document.createElement('label'); lab.style.display='flex'; lab.style.gap='8px'; lab.style.alignItems='center'; lab.style.cursor='pointer';
                lab.innerHTML=`<input type="radio" name="q${idx}" value="${i}" aria-labelledby="${id}"> <span id="${id}">${opt}</span>`;
                q.append(lab);
            })
            f.append(q);
        })
    }
    renderQuiz();
    $('#submitQuiz').addEventListener('click',()=>{
        let correct=0; DATA.quiz.forEach((item,idx)=>{const v=fv(`q${idx}`); if(v!==null && +v===item.pick) correct++;});
        const pct=Math.round(100*correct/DATA.quiz.length);
        $('#score').textContent=pct+'%';
        drawBadge(pct); $('#saveBadge').disabled=false;
    })
    function fv(name){const el=[...document.getElementsByName(name)].find(i=>i.checked);return el?el.value:null}
    function drawBadge(pct){
        const c=$('#badgeCanvas'); const ctx=c.getContext('2d'); c.classList.remove('hidden');
        ctx.clearRect(0,0,c.width,c.height);
        const g=ctx.createLinearGradient(0,0,c.width,0); g.addColorStop(0,'#0d1b2a'); g.addColorStop(1,'#2a3a55'); ctx.fillStyle=g; ctx.fillRect(0,0,c.width,c.height);
    ctx.fillStyle='#EFB8C8'; ctx.font='700 40px system-ui'; ctx.fillText(CONFIG.sections.quiz.scoreLabel,40,70);
        ctx.fillStyle='#fff'; ctx.font='900 120px system-ui'; ctx.fillText(pct+'%',40,190);
    ctx.fillStyle='#cfe3ff'; ctx.font='24px system-ui'; ctx.fillText(CONFIG.sections.quiz.badgeFooter,40,240);
        // è¿›åº¦å¼§
        const cx=420, cy=160, r=120; ctx.lineWidth=18; ctx.strokeStyle='rgba(255,255,255,.15)'; ctx.beginPath(); ctx.arc(cx,cy,r,Math.PI*0.75,Math.PI*2.25); ctx.stroke();
        const end= Math.PI*0.75 + (Math.PI*1.5)*(pct/100);
        ctx.strokeStyle='#EFB8C8'; ctx.beginPath(); ctx.arc(cx,cy,r,Math.PI*0.75,end); ctx.stroke();
    }
    $('#saveBadge').addEventListener('click',()=>$('#badgeCanvas').toBlob(b=>downloadBlob(b,`badge_${Date.now()}.png`)));

    // ===== æ‹¼å›¾ï¼ˆNxN æ»‘å— - å‡çº§ç‰ˆï¼šå¯è§£ä¿è¯ã€åŠ¨ç”»ã€è®¡æ—¶ã€æ‰‹åŠ¿ï¼‰ =====
    class PuzzleGame{
        constructor(){
            this.size = (CONFIG.puzzle?.defaultSize)||3;
            this.stage = $('#puzzleStage');
            this.imageUrl = DATA.puzzleImg;
            this.tiles=[]; this.emptyIndex=-1; this.moves=0; this.t0=0; this.timer=null; this.isSolved=false;
            if(this.stage){ this.setupHUD(); this.build(); this.shuffle(true); this.bindControls(); }
        }
        setupHUD(){
            // åœ¨å³ä¾§å¡ç‰‡åŠ è®¡æ—¶/æ­¥æ•°ä¸å°ºå¯¸åˆ‡æ¢
            const card = document.querySelector('#puzzle + .section .container .row .card') || document.querySelector('#puzzle .card');
            if(!card) return;
            const hud = document.createElement('div'); hud.className='row'; hud.style.marginTop='8px'; hud.style.display='flex'; hud.style.gap='8px'; hud.style.flexWrap='wrap';
            hud.innerHTML = `
              <div class="pill">ç”¨æ—¶ï¼š<span id="pzTime">00:00</span></div>
              <div class="pill">æ­¥æ•°ï¼š<span id="pzMoves">0</span></div>
              <select id="pzSize" class="pill" style="background:transparent;border-color:rgba(255,255,255,.16);cursor:pointer">
                ${ (CONFIG.puzzle?.sizeOptions||[3,4]).map(n=>`<option value="${n}" ${n===this.size?'selected':''}>${n}Ã—${n}</option>`).join('') }
              </select>
              <button class="btn ghost" id="pzGhost">${CONFIG.puzzle?.showGhost?'éšè—åº•å›¾':'æ˜¾ç¤ºåº•å›¾'}</button>
            `;
            card.appendChild(hud);
            $('#pzSize').addEventListener('change',e=>{ this.size=+e.target.value; this.build(); this.shuffle(true); });
            $('#pzGhost').addEventListener('click',()=>{ this.stage.classList.toggle('ghost'); $('#pzGhost').textContent=this.stage.classList.contains('ghost')?'éšè—åº•å›¾':'æ˜¾ç¤ºåº•å›¾'; });
            if(CONFIG.puzzle?.showGhost) this.stage.classList.add('ghost');
        }
        position(i){ const x=i%this.size, y=(i/this.size|0); return {x, y}; }
        index(x,y){ return y*this.size + x; }
        build(){
            this.stage.innerHTML=''; this.tiles=[];
            const N=this.size*this.size; const bg=this.imageUrl;
            this.stage.style.setProperty('--n', this.size);
            // èƒŒæ™¯å›¾ï¼ˆå¹½çµï¼‰
            this.stage.style.backgroundImage = `url(${bg})`;
            this.stage.style.backgroundSize = '100% 100%';

            for(let i=0;i<N-1;i++){
                const d=this.position(i);
                const t=document.createElement('div'); t.className='tile';
                t.dataset.correct=i; t.dataset.pos=i;
                // ä½¿ç”¨ transformï¼Œä¸ç”¨ left/top å¸ƒå±€
                t.style.transform = `translate(${(d.x*100)}%, ${(d.y*100)}%)`;
                t.style.width = (100/this.size)+'%'; t.style.height=(100/this.size)+'%';
                t.style.backgroundImage=`url(${bg})`;
                t.style.backgroundSize=`${this.size*100}% ${this.size*100}%`;
                t.style.backgroundPosition=`${(-d.x*100/(this.size-1))}% ${(-d.y*100/(this.size-1))}%`;
                t.addEventListener('click',()=>this.tryMove(+t.dataset.pos));
                this.stage.appendChild(t); this.tiles.push(t);
            }
            this.emptyIndex = N-1; this.moves=0; this.updateHUD(); this.isSolved=false;
        }
        updateHUD(){
            const sec=Math.floor((performance.now()-this.t0)/1000)|0;
            const m=String(sec/60|0).padStart(2,'0'), s=String(sec%60).padStart(2,'0');
            const timeEl=$('#pzTime'); if(timeEl) timeEl.textContent=`${m}:${s}`; 
            const movesEl=$('#pzMoves'); if(movesEl) movesEl.textContent=String(this.moves);
        }
        startTimer(){
            this.t0=performance.now(); clearInterval(this.timer);
            this.timer=setInterval(()=>this.updateHUD(), 500);
        }
        stopTimer(){ clearInterval(this.timer); }
        canMove(i){
            const a=this.position(i), b=this.position(this.emptyIndex);
            return (a.x===b.x && Math.abs(a.y-b.y)===1) || (a.y===b.y && Math.abs(a.x-b.x)===1);
        }
        moveTile(i, silent=false){
            const t=this.tiles.find(x=>+x.dataset.pos===i); if(!t) return false;
            const to=this.position(this.emptyIndex);
            t.dataset.pos=this.emptyIndex;
            t.style.transform = `translate(${(to.x*100)}%, ${(to.y*100)}%)`;
            this.emptyIndex=i; if(!silent) this.afterMove(); return true;
        }
        afterMove(){
            this.moves++; this.updateHUD();
            if(this.tiles.every(x=>+x.dataset.pos===+x.dataset.correct) && this.emptyIndex===this.size*this.size-1){
                if(this.isSolved) return; this.isSolved=true; this.stopTimer();
                const bestKey=`pz_best_${this.size}`; const sec=(performance.now()-this.t0)/1000;
                const best=+localStorage.getItem(bestKey) || Infinity;
                if(sec<best) localStorage.setItem(bestKey, String(Math.floor(sec)));
                secretManager.showNotification(`æ‹¼å›¾å®Œæˆ ğŸ‰ æœ€ä½³çºªå½•ï¼š${Math.min(best, Math.floor(sec))} ç§’`, 'success');
                const revealBtn=$('#reveal'); if(revealBtn){ revealBtn.textContent='å·²å®Œæˆ âœ”'; revealBtn.disabled=true; }
                if (DATA.surpriseAudio){ const audio=$('#surprise'); if(audio){ try{ audio.src=DATA.surpriseAudio; audio.play(); }catch{} } }
            }
        }
        randomPermutation(){
            const N=this.size*this.size; const arr=[...Array(N).keys()];
            // Fisherâ€“Yates æ´—ç‰Œ
            for(let i=N-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; }
            // è®©ç©ºç™½åœ¨å°¾éƒ¨
            const ix=arr.indexOf(N-1); [arr[ix],arr[N-1]]=[arr[N-1],arr[ix]];
            // ä¿è¯å¯è§£
            if(!this.isSolvable(arr)) {
                // äº¤æ¢ä»»æ„ä¸¤ä¸ªéç©º tile ä¿®æ­£å¥‡å¶
                [arr[0], arr[1]] = [arr[1], arr[0]];
            }
            return arr;
        }
        isSolvable(arr){
            // arr ä¸º 0..N-1 çš„æ’åˆ—ï¼Œå…¶ä¸­ N-1 ä»£è¡¨ç©ºç™½
            const N=this.size*this.size, blankRowFromBottom=this.size - (Math.floor(arr.indexOf(N-1)/this.size));
            let inv=0;
            for(let i=0;i<N-1;i++)for(let j=i+1;j<N-1;j++) if(arr[i]>arr[j]) inv++;
            if(this.size%2===1) return inv%2===0; // å¥‡æ•°é˜¶ï¼šé€†åºæ•°å¶
            // å¶æ•°é˜¶ï¼šç©ºç™½è‡ªåº•èµ·è¡Œæ•°å¥‡å¶ + é€†åºæ•°å¥‡å¶ == 1
            return ((blankRowFromBottom%2===0) === (inv%2===1));
        }
        shuffle(start=false){
            const perm=this.randomPermutation(); // perm[i]= tileIndex æˆ– N-1(ç©º)
            // æ”¾ç½®
            const N=this.size*this.size;
            for(let i=0;i<N;i++){
                if(perm[i]===N-1){ this.emptyIndex=i; continue; }
                const tile=this.tiles.find(t=>+t.dataset.correct===perm[i]);
                tile.dataset.pos=i;
                const d=this.position(i);
                tile.style.transform=`translate(${(d.x*100)}%, ${(d.y*100)}%)`;
            }
            this.moves=0; this.updateHUD(); this.isSolved=false;
            if(start){ this.startTimer(); const revealBtn=$('#reveal'); if(revealBtn){ revealBtn.textContent='çœ‹åŸå›¾'; revealBtn.disabled=false; } }
        }
        tryMove(i){ if(!this.canMove(i)) return; this.moveTile(i); }
        bindControls(){
            // Shuffle & Reveal ä¿æŒ
            $('#shuffle')?.addEventListener('click',()=>{ this.build(); setTimeout(()=>this.shuffle(true),0); });
            $('#reveal')?.addEventListener('click',()=>{ gallery.openLightboxCustom(this.imageUrl,'æ‹¼å›¾åŸå›¾'); });

            // é”®ç›˜
            window.addEventListener('keydown',(e)=>{
                const b=this.position(this.emptyIndex); let n=null;
                if(e.key==='ArrowUp') n=this.index(b.x, b.y+1);
                else if(e.key==='ArrowDown') n=this.index(b.x, b.y-1);
                else if(e.key==='ArrowLeft') n=this.index(b.x+1, b.y);
                else if(e.key==='ArrowRight') n=this.index(b.x-1, b.y);
                if(n!=null && n>=0 && n<this.size*this.size) { e.preventDefault(); this.tryMove(n); }
            });

            // è§¦æ‘¸åˆ’åŠ¨
            if('ontouchstart' in window){
                let sx=0,sy=0;
                this.stage.addEventListener('touchstart',e=>{ const t=e.touches[0]; sx=t.clientX; sy=t.clientY; }, {passive:true});
                this.stage.addEventListener('touchend',e=>{
                    const t=e.changedTouches[0]; const dx=t.clientX-sx, dy=t.clientY-sy;
                    if(Math.abs(dx)<30 && Math.abs(dy)<30) return;
                    const b=this.position(this.emptyIndex); let n=null;
                    if(Math.abs(dx)>Math.abs(dy)) n = dx>0? this.index(b.x-1,b.y) : this.index(b.x+1,b.y);
                    else n = dy>0? this.index(b.x,b.y-1) : this.index(b.x,b.y+1);
                    if(n!=null) this.tryMove(n);
                }, {passive:true});
            }
        }
    }
    
    const puzzleGame = new PuzzleGame();
    
    perf.mark('æ‹¼å›¾ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ');

    // ===== v3.2 - Config-driven & Global Effects =====
    class GlobalFX {
        constructor(){
            this.overlay = document.getElementById('fxOverlay');
            this.barrageEl = document.getElementById('fxBarrage');
            this.canvas = document.getElementById('fxFireworks');
            this.ctx = this.canvas ? this.canvas.getContext('2d', { alpha: true }) : null;
            this.particles = [];
            this.animationId = null;
            this.timers = [];
            if (this.canvas && this.ctx){
                this.resize();
                window.addEventListener('resize', debounce(()=>this.resize()), {passive:true});
                if (!prefersReducedMotion) this.startParticleLoop();
            }
            this.startAutoLoops();
        }
        resize(){ if (this.canvas && this.ctx) scaleCanvas(this.canvas, this.ctx); }
        startParticleLoop(){
            const tick = ()=>{
                const w = this.canvas.clientWidth || 300;
                const h = this.canvas.clientHeight || 300;
                this.ctx.clearRect(0,0,w,h);
                this.particles.forEach(p=>{
                    p.x += p.vx; p.y += p.vy; p.vx *= 0.985; p.vy = p.vy*0.985 + 0.06; p.life--;
                    this.ctx.fillStyle = p.color; this.ctx.fillRect(p.x,p.y,2,2);
                });
                // ç”Ÿå‘½æœŸä¸æ€»é‡æ§åˆ¶ï¼Œé¿å…æç«¯æƒ…å†µä¸‹ç²’å­æ— é™å¢é•¿å¯¼è‡´å†…å­˜è†¨èƒ€
                this.particles = this.particles.filter(p=>p.life>0);
                if (this.particles.length > 2200) {
                    this.particles = this.particles.slice(-1800);
                }
                this.animationId = requestAnimationFrame(tick);
            }; tick();
        }
        firework(x,y){
            if (this.particles.length > 2000) return; // èƒŒå‹ï¼šç²’å­è¿‡å¤šæ—¶è·³è¿‡æ–°ä¸€è½®çƒŸèŠ±
            for(let i=0;i<60;i++){
                const a=(i/60)*2*Math.PI;
                this.particles.push({x,y,vx:Math.cos(a)*(2+Math.random()*3),vy:Math.sin(a)*(2+Math.random()*3),life:50+rand(30),color:`hsl(${rand(360)},90%,70%)`});
            }
        }
        popConfetti(x,y){
            if (this.particles.length > 2000) return; // èƒŒå‹ï¼šç²’å­è¿‡å¤šæ—¶è·³è¿‡çº¸å±‘
            for(let i=0;i<36;i++){
                const a=(i/36)*2*Math.PI;
                this.particles.push({x,y,vx:Math.cos(a)*(1+Math.random()*2),vy:Math.sin(a)*(1+Math.random()*2),life:40+rand(20),color:`hsl(${rand(360)},90%,70%)`});
            }
        }
        spawnBalloon(){
            if (!this.overlay || !CONFIG.effects.balloons?.enabled) return;
            // æ€§èƒ½æ§åˆ¶ï¼šé™åˆ¶åŒå±æ°”çƒæ•°
            if (!this.activeBalloons) this.activeBalloons = 0;
            const maxBalloons = CONFIG.effects.performance?.maxBalloons || 24;
            if (this.activeBalloons >= maxBalloons) return;
            
            const texts = CONFIG.effects.balloons.texts?.length? CONFIG.effects.balloons.texts : DEFAULT_WISHES;
            const colors = CONFIG.effects.balloons.colors;
            const el = document.createElement('div'); el.className='balloon';
            
            // å½¢çŠ¶ï¼šround | heart | mix
            const shape = CONFIG.effects.balloons.shape || 'round';
            if (shape==='heart' || (shape==='mix' && Math.random()<0.5)) el.classList.add('heart');

            // é¢œè‰²/ä½ç½®
            const pair = colors[rand(colors.length)]; 
            el.style.setProperty('--balloon-color', pair[0]); 
            el.style.setProperty('--balloon-dark', pair[1]);
            const w = this.overlay.clientWidth || window.innerWidth; 
            const x = 20 + Math.random()*Math.max(100, w-100); 
            el.style.left = x+'px';
            el.style.setProperty('--drift', ((Math.random()-0.5)*120)+'px'); 
            el.style.setProperty('--rotate', ((Math.random()-0.5)*12)+'deg');
            
            // æ™¯æ·±æ¨¡ç³Š
            const [minBlur,maxBlur]=CONFIG.effects.balloons.depthBlur||[0,1.5];
            el.style.filter = `blur(${(minBlur+Math.random()*(maxBlur-minBlur)).toFixed(1)}px) drop-shadow(0 10px 18px rgba(0,0,0,.35))`;

            // ç»“æ„ï¼šä¸»ä½“/ç»³/æ–‡æ¡ˆï¼›å¿ƒå½¢éœ€è¦ä¸€ä¸ªå†…éƒ¨ <i> ä½œä¸ºå¿ƒå°–
            const b=document.createElement('div'); b.className='b';
            if (el.classList.contains('heart')) b.appendChild(document.createElement('i'));
            const s=document.createElement('div'); s.className='s';
            const t=document.createElement('small'); t.textContent = texts[rand(texts.length)];
            el.append(b,s,t); this.overlay.appendChild(el); this.activeBalloons++;

            const [minS,maxS]=CONFIG.effects.balloons.speedSecRange||[7,12]; 
            const dur = minS + Math.random()*(maxS-minS); 
            el.style.animation=`floatUp ${dur}s ease-out forwards`;

            el.addEventListener('click',()=>{ 
                const r=el.getBoundingClientRect(); 
                this.popConfetti(r.left+r.width/2, r.top+r.height/2); 
                el.remove(); 
                this.activeBalloons--; 
            },{once:true});
            
            setTimeout(()=>{ 
                if (el.parentNode) el.remove(); 
                this.activeBalloons--; 
            }, dur*1000 + 500);
        }
        spawnBarrage(text){
            if (!this.barrageEl || !CONFIG.effects.barrage.enabled) return;
            const list = CONFIG.effects.barrage.messages||[]; const msg = sanitize.text(text || (list.length? list[rand(list.length)]: DEFAULT_WISHES[rand(DEFAULT_WISHES.length)]));
            const dir = Math.random()<0.5?'left':'right'; const el=document.createElement('div'); el.className='msg'; el.textContent=msg; this.barrageEl.appendChild(el);
            const stageW=this.barrageEl.clientWidth||window.innerWidth; const stageH=this.barrageEl.clientHeight||window.innerHeight; const y=30+Math.random()*Math.max(50, stageH-80); el.style.top=y+'px';
            const [minMs,maxMs]=CONFIG.effects.barrage.speedMsRange||[5000,9000]; const duration=minMs+Math.random()*(maxMs-minMs); const start=performance.now();
            let startX,endX; if (dir==='left'){ startX=stageW+20; endX=-(el.offsetWidth+40);} else { startX=-(el.offsetWidth+40); endX=stageW+20; } el.style.left=startX+'px';
            let sparked=false; const step=(now)=>{ const p=Math.min(1,(now-start)/duration); const x=startX+(endX-startX)*p; el.style.left=x+'px'; if(!sparked && p>0.45 && p<0.48){ sparked=true; this.firework(Math.max(20, Math.min(stageW-20, x + el.offsetWidth*0.5)), y); }
                if(p<1) requestAnimationFrame(step); else el.remove(); }; requestAnimationFrame(step);
        }
        startAutoLoops(){ if (prefersReducedMotion) return; 
            const bd = Math.max(1, CONFIG.effects.balloons.densityPerMinute||0); const bi = Math.max(500, 60000/bd);
            const td = Math.max(1, CONFIG.effects.barrage.densityPerMinute||0); const ti = Math.max(400, 60000/td);
            const balloonTick=()=>{ if(!document.hidden) this.spawnBalloon(); this.timers.push(setTimeout(balloonTick, bi*(0.8+Math.random()*0.4))); };
            const barrageTick=()=>{ if(!document.hidden) this.spawnBarrage(); this.timers.push(setTimeout(barrageTick, ti*(0.8+Math.random()*0.4))); };
            setTimeout(balloonTick, 1200); setTimeout(barrageTick, 1600);
        }
        pause(){ if (this.animationId){ cancelAnimationFrame(this.animationId); this.animationId=null; } }
        resume(){ if (!this.animationId && !prefersReducedMotion) this.startParticleLoop(); }
    }
    const globalFX = new GlobalFX();
    
    // ===== Resize Guardï¼ˆç¼©æ”¾/å°ºå¯¸å‰§çƒˆå˜åŒ–æ—¶ï¼Œä¸´æ—¶é™è½½ï¼‰ =====
    (function setupResizeGuard(){
        let timer=null, active=false; const html=document.documentElement;
        const kick=()=>{
            if(!active){
                active=true; html.classList.add('resizing');
                try{ starField.pause(); }catch{}
                try{ globalFX.pause(); }catch{}
            }
            clearTimeout(timer);
            timer=setTimeout(()=>{
                active=false; html.classList.remove('resizing');
                try{ starField.resume(); }catch{}
                try{ globalFX.resume(); }catch{}
            }, 450);
        };
        window.addEventListener('resize', kick, {passive:true});
        window.addEventListener('wheel', (e)=>{ if(e.ctrlKey) kick(); }, {passive:true}); // Ctrl+æ»šè½®=ç¼©æ”¾
    })();
    // é¡µé¢å¯è§æ€§å˜åŒ–ï¼šæš‚åœ/æ¢å¤
    document.addEventListener('visibilitychange', () => {
        if (document.hidden) { globalFX.pause(); } else { globalFX.resume(); }
    });
    // ===== æ‰¿è¯ºä¹¦ | ç­¾å | çºªå¿µå¡ =====
    const sig = $('#sig'); const sg = sig.getContext('2d');
    function resizeSig(){ scaleCanvas(sig, sg); }
    window.addEventListener('resize', debounce(resizeSig), {passive:true}); resizeSig();
    
    // ç­¾åç»˜åˆ¶çŠ¶æ€
    let drawing = false;
    let last = {x: 0, y: 0};

    // ===== ç­¾åäº‹ä»¶å¤„ç† =====
    function rel(e){const r=sig.getBoundingClientRect(); const t=e.touches? e.touches[0]: e; return {x:t.clientX-r.left, y:t.clientY-r.top}}
    const begin = e=>{drawing=true; last=rel(e)}; const end=()=>drawing=false; const move=e=>{if(!drawing) return; const p=rel(e); sg.strokeStyle='#fff'; sg.lineWidth=2; sg.lineCap='round'; sg.beginPath(); sg.moveTo(last.x,last.y); sg.lineTo(p.x,p.y); sg.stroke(); last=p}
    sig.addEventListener('mousedown',begin); sig.addEventListener('mousemove',move); window.addEventListener('mouseup',end);
    sig.addEventListener('touchstart',begin,{passive:true}); sig.addEventListener('touchmove',move,{passive:true}); sig.addEventListener('touchend',end);
    $('#clearSig').addEventListener('click',()=>sg.clearRect(0,0,sig.width,sig.height));

    function drawPoster(){
        const c=$('#poster'); const ctx=c.getContext('2d'); ctx.clearRect(0,0,c.width,c.height);
        const M=60; const W=c.width-2*M;
        // èƒŒæ™¯
        const g=ctx.createLinearGradient(0,0,0,c.height); g.addColorStop(0,'#0d1b2a'); g.addColorStop(1,'#2a3a55'); ctx.fillStyle=g; ctx.fillRect(0,0,c.width,c.height);
        // å¤–æ¡†
        ctx.strokeStyle='rgba(255,255,255,.25)'; ctx.lineWidth=2; roundRect(ctx, M-10, M-10, c.width-2*(M-10), c.height-2*(M-10), 24); ctx.stroke();
        // æ ‡é¢˜
        ctx.fillStyle='#EFB8C8'; ctx.font='900 64px system-ui'; ctx.fillText('Happy Orbit, Zixian', M, M+70);
        ctx.fillStyle='#cfe3ff'; ctx.font='24px system-ui'; ctx.fillText(new Date().toLocaleDateString(), M, M+110);
        // æ–‡æ¡ˆå®¹å™¨
        const boxY = M+140; const boxH = c.height - boxY - (M+240);
        ctx.fillStyle='rgba(255,255,255,.05)'; roundRect(ctx, M, boxY, W, boxH, 18); ctx.fill();
        // å®‰å…¨ï¼šä½¿ç”¨.valueï¼ˆå·²æ¸…ç†ï¼‰
        const pledgeEl = $('#pledge');
        const text = pledgeEl ? sanitize.text(pledgeEl.value) : '';
        ctx.fillStyle='#fff'; ctx.font='28px system-ui';
        const lines = wrapMixedText(ctx, text, W-40); const lh=40; let y=boxY+40;
        for(const l of lines){ if(y>boxY+boxH- lh) break; ctx.fillText(l, M+20, y); y+=lh; }
        // ç­¾ååŒºæ ‡é¢˜
        ctx.fillStyle='#cfe3ff'; ctx.font='20px system-ui'; const sigTitleY = Math.min(y+20, c.height - M - 180); ctx.fillText('ç­¾å', M, sigTitleY);
        // ç­¾åè´´å›¾
        const sigY = Math.min(sigTitleY+14, c.height - M - 160);
        ctx.drawImage(sig, M, sigY, Math.min(420, W*0.6), 140);
        // è£…é¥°æ˜Ÿç‚¹
        for(let i=0;i<90;i++){ctx.fillStyle=`hsla(${rand(360)},100%,80%,.8)`; ctx.fillRect(M+rand(W), (c.height-M-280)+rand(240), 2, 2)}
    }
    function wrapMixedText(ctx, text, maxWidth){
        const out=[]; const paras = (text||'').split('\n');
        for(const par of paras){
            if(par.trim()===''){ out.push(''); continue; }
            let line='';
            for(let i=0;i<par.length;i++){
                const ch=par[i]; const test=line+ch; if(ctx.measureText(test).width>maxWidth && line!==''){ out.push(line); line=ch; } else { line=test; }
            }
            out.push(line);
        }
        return out;
    }
    function roundRect(ctx, x, y, w, h, r){ ctx.beginPath(); ctx.moveTo(x+r,y); ctx.arcTo(x+w,y,x+w,y+h,r); ctx.arcTo(x+w,y+h,x,y+h,r); ctx.arcTo(x,y+h,x,y,r); ctx.arcTo(x,y,x+w,y,r); ctx.closePath(); }
    $('#savePoster').addEventListener('click',()=>{
        drawPoster(); $('#poster').toBlob(b=>downloadBlob(b,`zixian_poster_${Date.now()}.png`))
    })

    // ===== æ‚é¡¹ & æœ€ç»ˆåˆå§‹åŒ– =====
    // 1) Web Share åˆ†äº«æŒ‰é’®ï¼ˆå¯é€‰ï¼‰
    // - å¦‚éœ€å…³é—­ï¼Œåˆ é™¤æˆ–æ³¨é‡Šè°ƒç”¨ setupSharingButton()
    function setupSharingButton(){
        if (!navigator.share) return; // ä»…åœ¨æ”¯æŒè®¾å¤‡ä¸Šæ˜¾ç¤º
        const navInner = document.querySelector('.nav-inner');
        if (!navInner) return;
        const btn = document.createElement('button');
        btn.className = 'btn ghost';
        btn.type = 'button';
        btn.textContent = 'åˆ†äº«';
        btn.title = 'è°ƒç”¨ç³»ç»Ÿåˆ†äº«é¢æ¿';
        btn.addEventListener('click', async ()=>{
            try{
                await navigator.share({
                    title: document.title,
                    text: 'ä¸€èµ·æ¥çœ‹å­èŒœçš„ç”Ÿæ—¥æ˜Ÿæ²³å±•è§ˆå§ï¼',
                    url: location.href
                });
            }catch(err){
                console.log('åˆ†äº«å–æ¶ˆ/å¤±è´¥ï¼š', err?.message || err);
            }
        });
        navInner.appendChild(btn);
    }
    setupSharingButton();

    // 2) èƒŒæ™¯éŸ³ä¹ï¼ˆå¯é€‰ï¼‰ï¼š
    // - åœ¨ DATA.bgm è®¾ç½®ä¸ºä½ çš„éŸ³ä¹åœ°å€ï¼ˆæ”¯æŒæœ¬åœ°ç›¸å¯¹è·¯å¾„æˆ– CSP æ”¾è¡Œçš„ https åŸŸï¼‰ï¼›
    // - è‹¥ç•™ç©ºåˆ™ä¸æ˜¾ç¤º BGM åˆ‡æ¢æŒ‰é’®ï¼›
    function setupBackgroundMusic(){
        try{
            if (!DATA.bgm) return; // æœªé…ç½®åˆ™è·³è¿‡
            const navInner = document.querySelector('.nav-inner');
            if (!navInner) return;
            const audio = document.createElement('audio');
            audio.id = 'bgm';
            audio.loop = true;
            audio.preload = 'none';
            audio.src = DATA.bgm;
            document.body.appendChild(audio);
            const toggle = document.createElement('button');
            toggle.className = 'pill';
            toggle.type = 'button';
            toggle.style.marginLeft = '8px';
            toggle.textContent = 'ğŸ”‡';
            let playing = false;
            toggle.addEventListener('click', async ()=>{
                try{
                    if (!playing){
                        await audio.play();
                        toggle.textContent = 'ğŸµ';
                    }else{
                        audio.pause();
                        toggle.textContent = 'ğŸ”‡';
                    }
                    playing = !playing;
                }catch(err){
                    secretManager.showToast(CONFIG.messages.autoplayBlocked, 'info');
                }
            });
            navInner.appendChild(toggle);
        }catch(err){
            console.log('BGM åˆå§‹åŒ–å¤±è´¥ï¼š', err);
        }
    }
    setupBackgroundMusic();

    // 3) Section æ»šåŠ¨å‡ºç°åŠ¨ç”»ï¼ˆå°Šé‡â€œå‡å°‘åŠ¨æ•ˆâ€åå¥½ï¼‰
    (function setupSectionReveal(){
        if (prefersReducedMotion || !('IntersectionObserver' in window)) return;
        const sections = document.querySelectorAll('.section');
        sections.forEach(sec => sec.classList.add('reveal-pending'));
        const io = new IntersectionObserver((entries)=>{
            entries.forEach(en=>{
                if (en.isIntersecting){
                    en.target.classList.remove('reveal-pending');
                    en.target.classList.add('in-view');
                    io.unobserve(en.target);
                }
            })
        }, { threshold: 0.12 });
        sections.forEach(sec => io.observe(sec));
    })();

    // 4) Service Worker æ³¨å†Œï¼ˆç¦»çº¿ç¼“å­˜ï¼Œå¯é€‰ï¼‰
    // - å¦‚éœ€å…³é—­ï¼Œæ³¨é‡Šä¸‹é¢ä¸€æ®µæ³¨å†Œä»£ç ï¼›
    // - sw.js ä½äºç«™ç‚¹æ ¹ç›®å½•ï¼›åœ¨ GitHub Pages/é™æ€æ‰˜ç®¡ä¸‹ï¼Œç¡®ä¿è·¯å¾„æ­£ç¡®ã€‚
    if ('serviceWorker' in navigator){
        window.addEventListener('load', ()=>{
            navigator.serviceWorker.register('sw.js').then(reg=>{
                console.log('ServiceWorker æ³¨å†ŒæˆåŠŸï¼Œä½œç”¨åŸŸï¼š', reg.scope);
            }).catch(err=>{
                console.log('ServiceWorker æ³¨å†Œå¤±è´¥ï¼š', err);
            });
        });
    }
    const yearEl = document.getElementById('year');
    if (yearEl) yearEl.textContent = new Date().getFullYear();

    // å¯è®¿é—®æ€§ï¼šEscå…³é—­æŸ¥çœ‹å™¨
    window.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            const lightbox = $('#lightbox');
            if (lightbox) lightbox.classList.remove('open');
        }
    });
    
    // é”™è¯¯å¤„ç†ï¼šå…¨å±€æ•è·
    window.addEventListener('error', (e) => {
        console.error('âŒ é”™è¯¯:', e.message, '@', e.filename, ':', e.lineno);
        if (secretManager) {
            secretManager.showToast(CONFIG.messages.genericIssue, 'info');
        }
    });
    
    window.addEventListener('unhandledrejection', (e) => {
        console.error('âŒ Promise æ‹’ç»:', e.reason);
    });
    
    // æ€§èƒ½æŠ¥å‘Š
    perf.mark('é¡µé¢åˆå§‹åŒ–å®Œæˆ');
    console.log('âœ¨ v3.1 æ‰€æœ‰ç³»ç»Ÿå°±ç»ªï¼ˆSecurity & Performance Enhancedï¼‰');
    console.log('ğŸ“Š æ€§èƒ½:', {
        è€—æ—¶: `${(performance.now() - perf.start).toFixed(2)}ms`,
        ç»•æ—¥: orbitsSince('2001-06-18'),
        ç…§ç‰‡: DATA.photos.length,
        äº‹ä»¶: DATA.timeline.length
    });
    
    // ç‰¹æ€§æ£€æµ‹
    if (navigator.share) console.log('âœ… Web Share');
    if ('serviceWorker' in navigator) console.log('âœ… Service Worker');

    </script>
    
    <!-- SEO: Structured Data -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "WebPage",
        "name": "å­èŒœçš„æ˜Ÿæ²³ç”Ÿæ—¥å±•",
        "description": "äº’åŠ¨ç”Ÿæ—¥ç½‘é¡µï¼šç›¸å†Œã€æ—¶é—´è½´ã€æ‰­è›‹ã€æ‹¼å›¾ã€çƒŸèŠ±",
        "inLanguage": "zh-CN"
    }
    </script>
</body>
</html>
